@{
    ViewBag.Title = "Despacho";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="Despacho0001"></span></a>
    </li>
    <li>
        <a href="@Url.Action("DashboardDespachoCorte", "DashboardDespachoCorte")"><span id="Despacho0025"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("Despacho", "Despacho")"><span id="Despacho0016"></span></a>
    </li>
}

<div id="formDespacho" class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="formNav clearfix">
                <div class="row">
                    <div class="col-sm-12 col-md-12 col-lg-12">
                        <div class="button-section">
                            <div class="btn-group save-group">
                                <button id="Guardar" onclick="javascript:void(0);" type="button" class="btn btn-yellow"><span id="Despacho0003"></span></button>
                                <button id="dropdown-toggle" type="button" class="btn btn-yellow dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caretWhite"></span>
                                </button>
                            </div>
                            <a id="Cancelar" href="#" class="btn btn-black"><span id="Despacho0004"></span></a>
                        </div>
                        <div class="button-section">
                            <div class="dropdown action-group">
                                <a id="Acciones" data-target="#" href="#" data-toggle="dropdown" role="button" ariahaspopup="true" aria-expanded="false" class="btn btn-default">
                                    <span id="Despacho0005"></span>
                                    <span class="caretBlue"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="Acciones">
                                    <li><a id="RedirectListado" href="#"><span id="Despacho0006"></span></a></li>
                                    <li><a href="#"><span id="Despacho0007"></span></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div id="ProyectoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Despacho0020"></label>
                            <input id="ProyectoID" />
                        </div>
                        <div id="SpoolDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Despacho0008"></label>
                            <input id="SpoolID" />
                        </div>
                        <div class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Despacho0009"></label>
                            <div class="row">
                                <div id="todosDiv" class="col-sm-3 col-md-3 col-lg-3">
                                    <label id="Despacho0010" class="centered"></label>
                                    <input id="todos" class="" type="radio" name="radio" checked value="1">
                                </div>
                                <div id="vaciosDiv" class="col-sm-3 col-md-3 col-lg-3">
                                    <label id="Despacho0011" class="centered"></label>
                                    <input id="vacios" class="" type="radio" name="radio" value="2" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div id="grid" class="gridWithInputsStorage"></div>
        </div>
    </div>
</div>
<input type="hidden" id="ChecksAlmacenaje" value="1"/>@*1 todos 2 sin localizacion*@ 
<script>

    @section JavascriptDocumentReadyHomeCookie {
    Cookies.set("home", true, { path: '/' });
    Cookies.set("navegacion", "25", { path: '/' });
    }

    @section JavascriptGlobalVariables {
    var resultadoJson, NumeroControl = {}, lastEditedCellID = "",
        Proyecto = {}, lastEditedBastonCellID = "", x = 1;

    var _spoolID = getUrlParameter("SpoolID", "-1"),
        _proyectoID = getUrlParameter("ProyectoID", "-1");
    var _DashboardDespacho = "@Url.Action("DashboardDespachoCorte", "DashboardDespachoCorte")";

    var $DespachoModel = {
        listContainer: {
            create: ".button-section",
            list: "#grid",
            detail: ".detailLink",
            destroy: ".k-grid-Cancelar"
        },
        properties: {
            proyecto: {
                visible: "#ProyectoDiv",
                editable: "#ProyectoID",
                required: "#ProyectoID"
            },
            spool: {
                visible: "#SpoolDiv",
                editable: "#SpoolID",
                required: "#SpoolID"
            },
            todos: {
                visible: "#todosDiv",
                editable: "#todos",
                required: "#todos"
            },
            vacios: {
                visible: "#vaciosDiv",
                editable: "#vacios",
                required: "#vacios"
            }
        }
    };

    }

    @section JavascriptGlobalFunctions {
    function changeLanguageCall() {
        CargarGridDespacho();
    };

    function CargaInicial() {
        $("#Guardar").click(function () { Guardar(); });
        $("#RedirectListado").click(function () { RedirectListado(); });
        $("#ProyectoID").kendoComboBox({
            dataTextField: "Nombre",
            dataValueField: "ProyectoID",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarProyecto(dataItem.ProyectoID, dataItem.Nombre);
            },
            change: function (e) {
                var value = this.value();
                LimpiarCamposProyecto();
                if (!value) {
                    Proyecto = {};
                }
            },
            filter: "contains",
        });
        ObtenerProyecto();
        
        $("#SpoolID").kendoAutoComplete({
            dataTextField: "NumeroControl",
            dataValueField: "NumeroControlID",
            autoBind: false,
            dataSource: {
                type: "json",
                minLength: 1,
                serverFiltering: true,
                transport: {
                    read: {
                        url: function (op) {
                            var val="";
                            if(op.filter){
                                val = op.filter.filters[0].value;
                            }
                            return $UrlDummyDespacho + "&id=" + Proyecto.ProyectoID + "&texto=" + val + "&token=" + Cookies.get("token");
                        }
                    }
                },
            },
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarNumeroControl(dataItem.NumeroControlID, dataItem.NumeroControl);
            },
            change: function (e) {
                var value = this.value();
                if (!value) {
                    NumeroControl = {};
                }
                ObtenerDatosGrid();
            },
            filter: "contains",
        });

        $('input:radio').click(function () {
            if ($(this).val() === '1') {
                $("#ChecksAlmacenaje").val(1);
                FiltrarDatos();
            } else if ($(this).val() === '2') {
                $("#ChecksAlmacenaje").val(2);
                FiltrarDatos();
            }
        });
    };
    function CargaInicialEdicion() {
        $("#ProyectoID").data("kendoComboBox").value(_proyectoID);
        $("#SpoolID").data("kendoAutoComplete").value(_spoolID);

        CargarNumeroControl(_spoolID);
        CargarProyecto(_proyectoID, $("#ProyectoID").data("kendoComboBox").text());
        ObtenerDatosGrid();
    };
    function CargarGridDespacho() {
        $("#grid").kendoGrid({
            dataSource: {
                data: resultadoJson,
                schema: {
                    model: {
                        fields: {
                            Etiqueta: { type: "string", editable: false },
                            ItemCode: { type: "string", editable: false },
                            Descripcion: { type: "string", editable: false },
                            NumeroUnico: { type: "string", editable: true },
                            Estatus: { type: "string", editable: false },
                            Baston: { type: "string", editable: true },
                            ProyectoID: { type: "string", editable: false },
                            NumeroControl: { type: "string", editable: false },
                        }
                    }
                },
                pageSize: 10,
                serverPaging: false,
                serverFiltering: false,
                serverSorting: false
            },
            autoHeight: true,
            sortable: true,
            scrollable: false,
            editable: {
                mode: "incell",
                confirmation: false
            },
            edit: function (e) {
                if (e.model.Hold == "True") {
                    this.closeCell();
                };
            },
            pageable: {
                refresh: false,
                pageSizes: [10, 15, 20],
                info: false,
                input: false,
                numeric: true,
            },
            columns: [
                { field: "NumeroControl", title: _dictionary.Despacho0012[$("#language").data("kendoDropDownList").value()] },
                { field: "Etiqueta", title: _dictionary.Despacho0024[$("#language").data("kendoDropDownList").value()] },
                { field: "ItemCode", title: _dictionary.Despacho0013[$("#language").data("kendoDropDownList").value()] },
                { field: "Descripcion", title: _dictionary.Despacho0014[$("#language").data("kendoDropDownList").value()] },
                { field: "NumeroUnico", title: _dictionary.Despacho0015[$("#language").data("kendoDropDownList").value()], editor: NumeroUnicoAutocomplete },
                { field: "Estatus", title: _dictionary.Despacho0019[$("#language").data("kendoDropDownList").value()] },
                { field: "Baston", title: _dictionary.Despacho0023[$("#language").data("kendoDropDownList").value()], editor: bastonAutoComplete },               
                { field: "Hold", title: _dictionary.Despacho0017[$("#language").data("kendoDropDownList").value()], hidden: true },
                { field: "TieneDespacho", title: _dictionary.Despacho0018[$("#language").data("kendoDropDownList").value()], hidden: true },
                { field: "ProyectoID", title: _dictionary.Despacho0026[$("#language").data("kendoDropDownList").value()] }
            ],
            dataBound: function (e) {
                $(".k-grid input.k-textbox").prop('readonly', true);
                $(".k-grid td .k-button").text('');
                $(".k-grid td:first-child, .k-grid td:last-child").css('text-overflow', 'clip');
            }
        });
    }
    function CargarProyecto(id, value) {
        Proyecto = {};
        Proyecto = { ProyectoID: parseInt(id), Nombre: value };
    };

    function CargarNumeroControl(id, value) {
        NumeroControl = {};
        NumeroControl = { NumeroControlID: id, NumeroControl: value };
    };
    function RedirectListado() {
        window.location.href = _DashboardDespacho + "?leng=" + $("#language").data("kendoDropDownList").value();
    };
    function LimpiarDatos() {
        $("#grid").data("kendoGrid").dataSource.data([]);
    };

    function ObtenerProyecto() {
        $Proyecto.Proyecto.read({ token: Cookies.get("token") }).done(function (result) {
            ControlErroresObjetosComboBox("ProyectoID", result);
        });
    };
    function LimpiarCamposProyecto() {
        NumeroControl = {};
        $("#grid").data("kendoGrid").dataSource.data([]);
    };
    function ObtenerDatosGrid() {
        loadingStart();
        $DummyDespacho.DummyDespacho.read({ NumeroControl: NumeroControl.NumeroControlID, token: Cookies.get("token") }).done(function (result) {
            if (Error(result)) {
                resultadoJson = result;
                if ($("#grid").data("kendoGrid")) {
                    if (resultadoJson.length > 0) {
                        $("#grid").data("kendoGrid").dataSource.data(resultadoJson);
                        $("#grid").data("kendoGrid").dataSource.page(1);
                    } else {
                        $("#grid").data("kendoGrid").dataSource.data([]);
                        $("#grid").data("kendoGrid").dataSource.page(0);
                    };
                };
                applySecurityPolicy(false);
                FiltrarDatos();
            }
            loadingStop();
        });
    };

    function FiltrarDatos() {
        var ChecksAlmacenaje = $("#ChecksAlmacenaje").val();
        var ds = $("#grid").data("kendoGrid").dataSource;
        var filters = [];

        ds.filter({});

        if (ChecksAlmacenaje == "2") {
            var new_filter = { field: "NumeroUnico", operator: "eq", value: "" };
            filters.push(new_filter);
        }

        if (NumeroControl.NumeroControlID) {
            var new_filter = { field: "NumeroControl", operator: "Contains", value: NumeroControl.NumeroControl ? NumeroControl.NumeroControl : "" };
            filters.push(new_filter);
        };

        ds.filter(filters);
    };

    function NumeroUnicoAutocomplete(container, options) {
        $('<input required data-text-field="NumeroUnico" data-value-field="NumeroUnicoID" data-bind="value:' + options.field + '"/>')
                       .appendTo(container)
                       .kendoComboBox({
                           autoBind: false,
                           dataSource: {
                               type: "json",
                               transport: {
                                   read: $UrlDummyDespacho + "&ItemCode=" + container.parent().children()[1].innerText + "&prueba=a" +"&prueba1=aa" + "&token=" + Cookies.get("token")
                               }
                           },
                           select: function (e) {
                               var dataItem = this.dataItem(e.item.index());
                               lastEditedCellID.NumeroUnico = dataItem.NumeroUnico;
                               $('#grid').data('kendoGrid').refresh();
                           },
                           change: function (e) {
                               
                           }
                       });

      
        lastEditedCellID = options.model;
    };
    function bastonAutoComplete(container, options) {
        $('<input required data-text-field="Baston" data-value-field="BastonID" data-bind="value:' + options.field + '"/>')
                      .appendTo(container)
                      .kendoComboBox({
                          autoBind: false,
                          dataSource: [
                               { "BastonID": "0", "Baston": _dictionary.Despacho0021[$("#language").data("kendoDropDownList").value()] },
                               { "BastonID": "1", "Baston": _dictionary.Despacho0022[$("#language").data("kendoDropDownList").value()] },
                          ],
                          select: function (e) {
                              var dataItem = this.dataItem(e.item.index());
                              
                              if (dataItem.BastonID == 0) {
                                  x += 1;
                                  var baston = [{ "BastonID": "0", "Baston": _dictionary.Despacho0021[$("#language").data("kendoDropDownList").value()] }];
                                  baston = AgregarNuevoBaston(x, baston);
                                  $(this)[0].dataSource.data(baston);
                              } else {
                                  lastEditedBastonCellID.Baston = dataItem.Baston;
                                  $("#grid").data("kendoGrid").refresh();
                              }
                              
                          },
                          open: function (e) {
                              var baston = [{ "BastonID": "0", "Baston": _dictionary.Despacho0021[$("#language").data("kendoDropDownList").value()] }];
                              baston = AgregarNuevoBaston(x, baston);
                              $(this)[0].dataSource.data(baston);
                          },
                          change: function (e) {

                          }
                      });

        lastEditedBastonCellID = options.model;
    };

   
    function validarRequeridosFormaDespacho() {
        var bool = true;
        $("#formDespacho .security_required").each(function (i, elem) {
            if (elem.tagName.toLowerCase() != 'label') {
                if (!$(this).val()) {
                    bool = false;
                    $(this).closest("div").find("label").addClass("error");
                } else {
                    $(this).closest("div").find("label").removeClass("error");
                };
            };
        });
        return bool;
    };

    function Guardar() {
        loadingStart();
        if (validarRequeridosFormaDespacho()) {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;
            var Listado = { Despacho: "" };

            Listado.ListaDespachos = ListadoAGuardar(datasource);

            $DummyDespacho.DummyDespacho.create(Listado, { token: $.cookie("token") }).done(function (result) {// no tengo controlador dummy
                if(Error(result)){
                    displayMessage("notificationslabel0056", "", '0');
                    ObtenerDatosGrid();
                }
                loadingStop();
            });
        } else {
            displayMessage("notificationslabel0031", "", '1');
            loadingStop();
        }
    };

    function ControlErroresObjetosComboBox(control, result) {
        if (Error(result)) {
            $("#" + control).data("kendoComboBox").dataSource.data(result);
        } else {
            $("#" + control).data("kendoComboBox").dataSource.data([]);
        };
    };
    }

    function AgregarNuevoBaston(x, baston) {
        var z = 1;
        for (var i = 0; i <= x; i++) {
            baston.push({ "BastonID": z, "Baston": _dictionary.Despacho0023[$("#language").data("kendoDropDownList").value()] + " " + (z) });
            z++;
        }
        return baston;
    };
    function ListadoAGuardar(datasource) {
        var Listado = {}, z = 0;
        for (var i = 0; i < datasource.length; i++) {
            var NumeroControl = datasource[i].NumeroControl;
            var ItemCode = datasource[i].ItemCode;
            var NumeroUnico = datasource[i].NumeroUnico;
            var TieneDespacho = datasource[i].TieneDespacho;
            var TieneHold = datasource[i].Hold;
            var Etiqueta = datasource[i].Etiqueta;
            var Baston= datasource[i].Baston;
            var ProyectoID = datasource[i].ProyectoID;

            if (TieneHold == "true") {
                displayMessage("notificationslabel0057", "", '2');
                return;
            }

            if (TieneDespacho != "true" && NumeroUnico) {//los que no tengan despacho y tengan numero unico asignado
                Listado[z] = { NumeroControl: NumeroControl, ItemCode: ItemCode, NumeroUnico: NumeroUnico, Etiqueta: Etiqueta, Baston: Baston, ProyectoID: ProyectoID };
                z++;
            }

        };
        return Listado;
    };

    @section JavascriptDocumentReadyFunctions {
    $authorizationModel["Despacho"] = $DespachoModel;
    CargaInicial();
    if (_spoolID != "-1" && _proyectoID != "-1") {
        CargaInicialEdicion();
    }
    }
</script>