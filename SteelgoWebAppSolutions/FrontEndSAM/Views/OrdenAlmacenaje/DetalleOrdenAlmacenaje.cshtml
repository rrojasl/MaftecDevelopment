@{
    ViewBag.Title = "Detalle Orden Almacenaje";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="DetalleOrdenAlmacenaje0018"></span></a>
    </li>
    <li>
        <a href="@Url.Action("DashboardRecepcionAlmacenaje", "DashboardRecepcionAlmacenaje")"><span id="DetalleOrdenAlmacenaje0019"></span></a>
    </li>
    <li>
        <a href="@Url.Action("ListadoOrdenAlmacenaje", "OrdenAlmacenaje")"><span id="DetalleOrdenAlmacenaje0020"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("DetalleOrdenAlmacenaje", "OrdenAlmacenaje")"><span id="DetalleOrdenAlmacenaje0021"></span></a>
    </li>
}

<div class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div id="formOrdenAlmacenaje" class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <span class="folioLabel">
                <span id="DetalleOrdenAlmacenaje0001"></span>
                <span id="spanOrdenAlmacenaje"></span>
                <div class="branchCut"></div>
            </span>
            <div class="formNav clearfix">
                <div class="row">
                    <div class="col-sm-12 col-md-12 col-lg-12">
                         <div class="button-section">
                            <div class="btn-group save-group">
                                <button id="Editar" onclick="javascript:void(0);" type="button" class="btn btn-yellow"><span id="DetalleOrdenAlmacenaje0002"></span></button>
                            </div>
                            <a id="Cancelar" href="#" class="btn btn-black" ><span id="DetalleOrdenAlmacenaje0003"></span></a>
                        </div>
                        <div class="button-section">
                            <div class="dropdown action-group">
                                <a id="Acciones" data-target="#" href="#" data-toggle="dropdown" role="button" ariahaspopup="true" aria-expanded="false" class="btn btn-default">
                                    <span id="DetalleOrdenAlmacenaje0004"></span>
                                    <span class="caretBlue"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="Acciones">
                                    <li><a id="RedirectListado"><span id="DetalleOrdenAlmacenaje0005"></span></a></li>
                                    <li><a><span id="DetalleOrdenAlmacenaje0006"></span></a></li>
                                     <li><a id="NuevaCaptura"><span id="DetalleOrdenAlmacenaje0007"></span></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

         <div class="row">
                <div class="filterForm col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div id="ProyectoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="DetalleOrdenAlmacenaje0008"></label>
                            <input id="ProyectoID" />
                        </div>
                         <div id="FolioCuantificacionDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenAlmacenaje0013"></label>
                            <input id="FolioCuantificacionID" class="" />
                        </div>
                        <div id="ItemCodeDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenAlmacenaje0014"></label>
                            <input id="ItemCode" />
                        </div>
                        <div id="NumeroUnicoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenAlmacenaje0015"></label>
                            <input id="NumeroUnico" />
                        </div>
                    </div>
                </div>
            </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                 <div id="grid"></div>
        </div>
    </div>
</div>

<script>
    @section JavascriptGlobalVariables 
    {
    var FolioCuantificacion = {}, Proyecto = {}, ItemCode = {}, NumeroUnico = {}, _resultadoJson, _esFiltros = false;
    var _ordenAlmacenajeID = getUrlParameter("OrdenAlmacenajeID", "-1");
    var _proyectoID = getUrlParameter("ProyectoID", "-1");
    var _generarOrdenUrl = "@Url.Action("GenerarOrdenAlmacenaje", "OrdenAlmacenaje")";
    var _listadoOrdenUrl = "@Url.Action("ListadoOrdenAlmacenaje", "OrdenAlmacenaje")";
    var $GenerarOrdenAlmacenajeModel = {
        listContainer: {
            create: "#Guardar",
            list: "#grid",
            detail: ".detailLink",
            destroy: ".k-grid-Cancelar"
        },
        properties: {
            username: {
                visible: "",
                editable: "",
                required: ""
            }
        }
    };
    }
    @section JavascriptGlobalFunctions 
    {
    function changeLanguageCall() {
        CargaInicialGrid();
    };
    
    function CargaInicial() {
        $("#spanOrdenAlmacenaje").html(_ordenAlmacenajeID);
        $("#Editar").click(function () { HabilitarCampos(); });

        $("#ProyectoID").kendoComboBox({
            dataTextField: "Nombre",
            dataValueField: "ProyectoID",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarProyecto(dataItem.ProyectoID, dataItem.Nombre);
            },
            change: function (e) {
                var value = this.value();
                LimpiarFiltrosProyecto();

                if (!value) {
                    Proyecto = {};
                } else {
                    ObtenerFoliosCuantificacion();
                }
                Filtros();
            },
            filter: "contains",
        });

        ObtenerProyecto();

        $("#FolioCuantificacionID").kendoComboBox({
            dataTextField: "id",
            dataValueField: "value",
            filter: "contains",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarFolio(dataItem.id);
            },
            change: function (e) {
                var value = this.value();
                limpiarFiltroCuantificacion();

                if (!value) {
                    FolioCuantificacion = {};
                } else {
                    ObtenerItemCodes();
                };
                Filtros();

            },
        });
        
        $("#ItemCode").kendoComboBox({
            dataTextField: "value",
            dataValueField: "id",
            filter: "contains",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarItemCode(dataItem.id);
            },
            change: function (e) {
                var value = this.value();
                limpiarFiltroItemCode();

                if (!value) {
                    ItemCode = {};
                } else {
                    ObtenerNumerosUnicos();
                };
                Filtros();
            },
        });

        $("#NumeroUnico").kendoComboBox({
            dataTextField: "value",
            dataValueField: "id",
            filter: "contains",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarNumeroUnico(dataItem.id);
            },
            change: function (e) {
                var value = this.value();
                if (!value) {
                    NumeroUnico = {};
                }
                Filtros();
            },
        });

        $("#RedirectListado").click(function () {
            window.location.href = _listadoOrdenUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
        });
        $("#NuevaCaptura").click(function () {
            window.location.href = _generarOrdenUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
        });

        $("#Cancelar").click(function () {
            window.location.href = _generarOrdenUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
        });

        CargarDatosGridInicial();
        DesahabilitarCampos();
    };

    function ControlErroresObjetosComboBox(control, result) {
        if (Error(result)) {
            $("#" + control).data("kendoComboBox").dataSource.data(result);
        } else {
            $("#" + control).data("kendoComboBox").dataSource.data([]);
        };
    };

    function CargarProyecto(id, value) {
        Proyecto = {};
        Proyecto = { ProyectoID: id, Nombre: value };
    };

    function CargarFolio(id) {
        FolioCuantificacion = {};
        FolioCuantificacion = { FolioCuantificacionID: id };
    };

    function CargarItemCode(id) {
        ItemCode = {};
        ItemCode = { ItemCodeID: id };
    };

    function CargarNumeroUnico(id) {
        NumeroUnico = {};
        NumeroUnico = { NumeroUnicoID: id };
    };

    function limpiarFiltroCuantificacion() {
        ItemCode = {};
        NumeroUnico = {};
        LimpiarCombo("ItemCode");
        LimpiarCombo("NumeroUnico");
        $("#grid").data("kendoGrid").dataSource.data([]);
    };

    function limpiarFiltroItemCode() {
        NumeroUnico = {};
        LimpiarCombo("NumeroUnico");
        $("#grid").data("kendoGrid").dataSource.data([]);
    };

    function LimpiarFiltrosProyecto() {
        ItemCode = {};
        NumeroUnico = {};
        FolioCuantificacion = {};
        LimpiarCombo("ItemCode");
        LimpiarCombo("FolioCuantificacionID");
        LimpiarCombo("NumeroUnico");
        $("#grid").data("kendoGrid").dataSource.data([]);
    };

    function LimpiarCombo(control) {
        $("#" + control).data("kendoComboBox").value("");
        $("#" + control).data("kendoComboBox").dataSource.data([]);
    };


    function ObtenerProyecto() {
        $Proyecto.Proyecto.read({ token: Cookies.get("token") }).done(function (result) {
            ControlErroresObjetosComboBox("ProyectoID", result);
            $("#ProyectoID").data("kendoComboBox").value(_proyectoID);
            //CargarDatosGrid();
        });
    };

    function ObtenerFoliosCuantificacion() {
        var Listado;
        Listado = { ProyectoID: Proyecto.ProyectoID, TipoListado: "9", token: Cookies.get("token") };

        $folioEntradaMaterial.Listado.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            ControlErroresObjetosComboBox("FolioCuantificacionID", result);
            //CargarDatosGrid();
        });
    };

    function ObtenerItemCodes() {
        var Listado;
        Listado = { FolioCuantificacionID: FolioCuantificacion.FolioCuantificacionID, TipoListado: "10", token: Cookies.get("token") };

        $folioEntradaMaterial.Listado.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            ControlErroresObjetosComboBox("ItemCode", result);
            //CargarDatosGrid();
        });
    };

    function DesahabilitarCampos() {
        $("#ProyectoID").data("kendoComboBox").enable(false);
        $("#FolioCuantificacionID").data("kendoComboBox").enable(false);
        $("#ItemCode").data("kendoComboBox").enable(false);
        $("#NumeroUnico").data("kendoComboBox").enable(false);
        $(".k-button.k-button-icontext.k-grid-Cancelar").addClass("hidden");
    };
    
    function HabilitarCampos() {
        $("#ProyectoID").data("kendoComboBox").enable(false);
        $("#FolioCuantificacionID").data("kendoComboBox").enable(false);
        $("#ItemCode").data("kendoComboBox").enable(false);
        $("#NumeroUnico").data("kendoComboBox").enable(false);
        $(".detailLink").removeAttr("disabled");
        $(".k-button.k-button-icontext.k-grid-Cancelar").removeClass("hidden");
        MostrarColumnaCancelar(true);
    };
    function CargaInicialGrid() {
         $("#grid").kendoGrid({
            dataSource: {
                data: _resultadoJson,
                schema: {
                    model: {
                        fields: {
                            FolioCuantificacion: { type: "string" },
                        }
                    }
                },
                serverPaging: false,
                serverFiltering: false,
                serverSorting: false,
                pageSize: 20,
            },
            autoHeight: true,
            sortable: false,
            scrollable: false,
            detailInit: detailInit,
            columns: [
                { field: "FolioCuantificacion", title: _dictionary.DetalleOrdenAlmacenaje0009[$("#language").data("kendoDropDownList").value()], width: "110px" },
                { field: "", title:"&nbsp;", width: "40px", template: "<a class='detailLink' onclick='CancelarFolio(this)'>Cancelar</a>" },
            ],
            dataBound: function (e) {
                $(".k-grid input.k-textbox").prop('readonly', true);
                $(".k-grid td .k-button").text('');
                $(".k-grid td:first-child, .k-grid td:last-child").css('text-overflow', 'clip');
            }
         }).getKendoGrid();

    };

    function detailInit(e) {
        if (e.data.ItemCodes.length > 0) {
            $("<div/>").appendTo(e.detailCell).kendoGrid({
                dataSource: {
                    data: e.data.ItemCodes,
                    schema: {
                        model: {
                            fields: {
                                FolioCuantificacion: { type: "string" },
                                ItemCodeID: { type: "string" },
                                Codigo: { type: "string" },
                                Descripcion: { type: "string" },
                                D1: { type: "string" },
                                D2: { type: "string" },
                                Cantidad: { type: "string" }
                            }
                        }
                    }
                },
                autoBind: true,
                scrollable: false,
                sortable: true,
                detailInit: detailInitNumerosUnicos,
                columns: [
                    { field: "FolioCuantificacion", title: _dictionary.DetalleOrdenAlmacenaje0009[$("#language").data("kendoDropDownList").value()], width: "110px", hidden: true },
                    { field: "ItemCodeID", title: _dictionary.DetalleOrdenAlmacenaje0010[$("#language").data("kendoDropDownList").value()], width: "110px", hidden: true },
                    { field: "Codigo", title: _dictionary.DetalleOrdenAlmacenaje0011[$("#language").data("kendoDropDownList").value()], width: "70px" },
                    { field: "Descripcion", title: _dictionary.DetalleOrdenAlmacenaje0012[$("#language").data("kendoDropDownList").value()], width: "200px" },
                    { field: "D1", title: _dictionary.DetalleOrdenAlmacenaje0013[$("#language").data("kendoDropDownList").value()], width: "50px" },
                    { field: "D2", title: _dictionary.DetalleOrdenAlmacenaje0014[$("#language").data("kendoDropDownList").value()], width: "50px" },
                    { field: "Cantidad", title: _dictionary.DetalleOrdenAlmacenaje0015[$("#language").data("kendoDropDownList").value()], width: "50px" },
                    //{ field: "", title: "", width: "110px", template: "<a class='detailLink' onclick='CancelarFolioItemCode(this)'>Cancelar</a>" }
                ]
            });
        }
        
    }

    function detailInitNumerosUnicos(e) {
        if (e.data.NumerosUnicos.length > 0) {
            $("<div/>").appendTo(e.detailCell).kendoGrid({
                dataSource: {
                    data: e.data.NumerosUnicos,
                    schema: {
                        model: {
                            fields: {
                                NumeroUnicoID: { type: "string" },
                                NumeroUnico: { type: "string" },
                                FolioCuantificacion: { type: "string" },
                                ItemCodeID: { type: "string" }
                            }
                        }
                    }
                },
                autoBind: true,
                scrollable: false,
                sortable: false,
                columns: [
                    { field: "NumeroUnicoID", title: _dictionary.DetalleOrdenAlmacenaje0016[$("#language").data("kendoDropDownList").value()], width: "110px", hidden: true },
                    { field: "NumeroUnico", title: _dictionary.DetalleOrdenAlmacenaje0017[$("#language").data("kendoDropDownList").value()], width: "110px" },
                    { field: "FolioCuantificacion", title: _dictionary.DetalleOrdenAlmacenaje0009[$("#language").data("kendoDropDownList").value()], width: "110px", hidden: true },
                    { field: "ItemCodeID", title: _dictionary.DetalleOrdenAlmacenaje0010[$("#language").data("kendoDropDownList").value()], width: "110px", hidden: true },
                    { field: "", title: "", width: "110px", template: "<a class='detailLink' onclick='CancelarNumerosUnicos(this)'>Cancelar</a>" },

                ]
            });
        }
    }

    function CargarDatosGridInicial() {
        loadingStart();
       
        //Es un dummy, deberia recibir  la orden de almacenaje
        var Listado = {  TipoListado: "8", token: Cookies.get("token") };

        $DummyGenerarOrdenAlmacenaje.DummyGenerarOrdenAlmacenaje.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            if (Error(result)) {
                _resultadoJson = result;
                if (_resultadoJson.length > 0) {
                    $("#grid").data("kendoGrid").dataSource.data(_resultadoJson);
                } else {
                    $("#grid").data("kendoGrid").dataSource.data([]);
                };
            }
            MostrarColumnaCancelar(false);
            loadingStop();
            applySecurityPolicy(false);
        });
    };

    function MostrarColumnaCancelar(bool) {
        var grid = $("#grid").data("kendoGrid");
        if (bool) {
            grid.showColumn(1);
        } else {
            grid.hideColumn(1);
        };
       
    };

    function Filtros() {
        _esFiltros = true;
        loadingStart();
        var ProyectoID = Proyecto.ProyectoID ? Proyecto.ProyectoID : "";
        var FolioCuantificacionID = FolioCuantificacion.FolioCuantificacionID ? FolioCuantificacion.FolioCuantificacionID : "";
        var ItemCodeid = ItemCode.ItemCodeID ? ItemCode.ItemCodeID : "";

        var Listado = { ProyectoID: ProyectoID, ItemCodeID: ItemCodeid, FolioCuantificacionID: FolioCuantificacionID, TipoListado: "8", token: Cookies.get("token") };

        $DummyGenerarOrdenAlmacenaje.DummyGenerarOrdenAlmacenaje.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            if (Error(result)) {
                _resultadoJson = result;
                if (_resultadoJson.length > 0) {
                    $("#grid").data("kendoGrid").dataSource.data(_resultadoJson);
                } else {
                    $("#grid").data("kendoGrid").dataSource.data([]);
                };
            }
            loadingStop();
            applySecurityPolicy(false);
        });
    };
    function CancelarFolio(row) {
        var folioCuantificacion = $(row).closest("tr").children()[1].innerHTML;
        var grid = $("#grid").data("kendoGrid");
        var tr = $(row).closest("tr");
        grid.removeRow(tr);
        //filtros();
    };
    function CancelarFolioItemCode(row) {
        var folioCuantificacion = $(row).closest("tr").children()[1].innerHTML;
        var ItemCodeID = $(row).closest("tr").children()[2].innerHTML;
        $(row).closest("tbody").find("tr.k-detail-row").css("display", "none");
        $(row).closest("tbody").find(".k-icon").removeClass("k-minus");
        $(row).closest("tbody").find(".k-icon").addClass("k-plus");

        var grid = $("#grid").data("kendoGrid");
        var tr = $(row).closest("tr");
        grid.removeRow(tr);
    };

    function CancelarNumerosUnicos(row) {
        var NumeroUnicoID = $(row).closest("tr").children()[1].innerHTML;
        var folioCuantificacion = $(row).closest("tr").children()[3].innerHTML;
        var itemCodeID = $(row).closest("tr").children()[4].innerHTML;

        if (confirm("Estas seguro de cancelar la orden de almacenaje del numero unico?")) {
            $GenerarOrdenAlmacenaje.GenerarOrdenAlmacenaje.create({}, { numeroUnico: NumeroUnicoID, token: $.cookie("token") }).done(function (result) {
                Error(result);
                Filtros();
            });
        };
    };

    function Error(data) {
        if (data.ReturnCode) {
            if (data.ReturnCode != 200) {
                if (data.ReturnCode == 401) {
                    removeUserSession();
                    return true;
                } else {
                    displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                    return false;
                }
            } else {
                return true;
            }
        } else {
            return true;
        }
    };
    }

    @section JavascriptDocumentReadyFunctions {
    $authorizationModel["Orden Almacenaje"] = $GenerarOrdenAlmacenajeModel;
    CargaInicial();

    }
     @section JavascriptDocumentReadyHomeCookie {
    Cookies.set("home", true, { path: '/' });
    Cookies.set("navegacion", "17", { path: '/' });
    }
</script>