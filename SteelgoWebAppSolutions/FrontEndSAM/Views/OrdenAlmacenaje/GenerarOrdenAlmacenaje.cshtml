
@{
    ViewBag.Title = "Generar Orden Recepcion";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="GenerarOrdenAlmacenaje0001"></span></a>
    </li>
    <li>
        <a href=""><span id="GenerarOrdenAlmacenaje0002"></span></a>
    </li>
    <li>
        <a href="@Url.Action("ListadoOrdenAlmacenaje", "OrdenAlmacenaje")"><span id="GenerarOrdenAlmacenaje0003"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("GenerarOrdenAlmacenaje", "OrdenAlmacenaje")"><span id="GenerarOrdenAlmacenaje0004"></span></a>
    </li>
}

<div class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div id="formOrdenRecepcion" class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="formNav clearfix">
                <div class="row">
                    <div class="col-sm-12 col-md-12 col-lg-12">
                        <div class="button-section">
                            <div class="btn-group save-group">
                                <button id="Guardar" onclick="javascript:void(0);" type="button" class="btn btn-yellow"><span id="GenerarOrdenAlmacenaje0005"></span></button>
                                <button id="dropdown-toggle" type="button" class="btn btn-yellow dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caretWhite"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#" id="GuardarNuevo"><span id="GenerarOrdenAlmacenaje0006"></span></a></li>
                                    <li><a href="#" id="GuardarFormatoEtiquetas"><span id="GenerarOrdenAlmacenaje0007"></span></a></li>
                                </ul>
                            </div>
                           
                            <a id="Cancelar" href="#" class="btn btn-black"><span id="GenerarOrdenAlmacenaje0008"></span></a>
                        </div>
                        <div class="button-section">
                            <div class="dropdown action-group">
                                <a id="Acciones" data-target="#" href="#" data-toggle="dropdown" role="button" ariahaspopup="true" aria-expanded="false" class="btn btn-default">
                                    <span id="GenerarOrdenAlmacenaje0009"></span>
                                    <span class="caretBlue"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="Acciones">
                                    <li><a id="RedirectListado"><span id="GenerarOrdenAlmacenaje0010"></span></a></li>
                                    <li><a><span id="GenerarOrdenAlmacenaje0011"></span></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <div class="row">
                <div class="filterForm col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div id="ProyectoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenRecepcion0006"></label>
                            <input id="ProyectoID" />
                        </div>
                         <div id="FolioCuantificacionDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenAlmacenaje0013"></label>
                            <input id="FolioCuantificacionID" class="" />
                        </div>
                        <div id="ItemCodeDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenAlmacenaje0014"></label>
                            <input id="ItemCode" />
                        </div>
                        <div id="NumeroUnicoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="GenerarOrdenAlmacenaje0015"></label>
                            <input id="NumeroUnico" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                 <div id="grid"></div>
        </div>
    </div>
</div>

<script>
    @section JavascriptGlobalVariables 
    {
    var _listadourl = "@Url.Action("ListadoOrdenAlmacenaje", "OrdenAlmacenaje")";
    var _generarurl = "@Url.Action("GenerarOrdenAlmacenaje", "OrdenAlmacenaje")";
    var FolioCuantificacion = {}, Proyecto = {}, ItemCode = {},
        NumeroUnico = {}, _resultadoJson, checkNodoPrincipal = [],
        checkItemCodesID = [];

    var _folioCuantificacionID = getUrlParameter("FolioCuantificacionID", "-1");
    var _proyectoID = getUrlParameter("ProyectoID", "-1");
    

    var $GenerarOrdenRecepcionModel = {
        listContainer: {
            create: "#Guardar",
            list: "#grid",
            detail: ".detailLink",
            destroy: ".k-grid-Cancelar"
        },
        properties: {
            username: {
                visible: "",
                editable: "",
                required: ""
            }
        }
    };

    }

    @section JavascriptGlobalFunctions 
    {
    function changeLanguageCall() {
        cargarInicialGrid();
    }
    function CargaInicial() {

        $("#Guardar").click(function () {
            GenerarOrdenRecepcion();
        });

        $("#GuardarNuevo").click(function () {
            GenerarOrdenRecepcionNuevo();
        });

        $("#GuardarFormatoEtiquetas").click(function () {
            GenerarOrdenRecepcionFormatoEtiquetas();
        });

        $("#Cancelar").click(function () {
            window.location.href = _generarurl + "?leng=" + $("#language").data("kendoDropDownList").value();
        });

        $("#RedirectListado").click(function () {
            window.location.href = _listadourl + "?leng=" + $("#language").data("kendoDropDownList").value();
        });

        $("#ProyectoID").kendoComboBox({
            dataTextField: "Nombre",
            dataValueField: "ProyectoID",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarProyecto(dataItem.ProyectoID, dataItem.Nombre);
            },
            change: function (e) {
                var value = this.value();
                LimpiarFiltrosProyecto();

                if (!value) {
                    Proyecto = {};
                    CargarDatosGrid();
                } else {
                    ObtenerFoliosCuantificacion();
                }
            },
            filter: "contains",
        });

        ObtenerProyecto();

        $("#FolioCuantificacionID").kendoComboBox({
            dataTextField: "id",
            dataValueField: "value",
            filter: "contains",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarFolio(dataItem.id);
            },
            change: function (e) {
                var value = this.value();
                limpiarFiltroItemCode();

                if (!value) {
                    FolioCuantificacion = {};
                    CargarDatosGrid();
                } else {
                    ObtenerItemCodes();
                };

                
            },
        });
       
        $("#ItemCode").kendoComboBox({
            dataTextField: "value",
            dataValueField: "id",
            filter: "contains",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarItemCode(dataItem.id);
            },
            change: function (e) {
                var value = this.value();
                if (!value) {
                    ItemCode = {};
                }
                CargarDatosGrid();
            },
        });

        $("#NumeroUnico").kendoComboBox({
            dataTextField: "value",
            dataValueField: "id",
            filter: "contains",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarNumeroUnico(dataItem.id);
            },
            change: function (e) {
                var value = this.value();
                if (!value) {
                    NumeroUnico = {};
                }
                CargarDatosGrid();
            },
        });
        
    }
    function cargarInicialGrid() {
        var grid = $("#grid").kendoGrid({
            dataSource: {
                data: _resultadoJson,
                schema: {
                    model: {
                        fields: {
                            FolioCuantificacion: { type: "string" },
                        }
                    }
                },
                serverPaging: false,
                serverFiltering: false,
                serverSorting: false
            },
            detailInit: detailInit,
            columns: [
                { template: '<input type="checkbox" class="master" >', width: 40 },
                { field: "FolioCuantificacion", title: _dictionary.GenerarOrdenAlmacenaje0016[$("#language").data("kendoDropDownList").value()], width: "110px" },
            ],
            //dataBound: onDataBoundPrincipal,
        }).getKendoGrid();


        grid.tbody.on("change", ".master", function () {
            //var checkbox = $(this);
            //var nextRow = checkbox.closest("tr").next();
            //var value = checkbox.closest("tr").children()[2].innerHTML;
          
            //checkNodoPrincipal[value] = { FolioCuantificacionID: value, checked: checkbox.is(":checked") };

            //for (var i in checkItemCodesID) {
            //    if (checkItemCodesID[value, i].FolioCuantificacionID == value) {
            //        checkItemCodesID[value,i].checked = false;
            //    }
            //}

            //if (nextRow.hasClass("k-detail-row")) {               
            //    nextRow.find(":checkbox")
            //        .prop("checked", checkbox.is(":checked"));
            //    nextRow.find(":checkbox")
            //        .prop("disabled", checkbox.is(":checked"));
            //}
        });
    };

    function CargaInicialEdicion() {
        $("#ProyectoID").data("kendoComboBox").value(_proyectoID);
        $("#FolioCuantificacionID").data("kendoComboBox").value(_folioCuantificacionID);

        CargarProyecto(_proyectoID);
        ObtenerFoliosCuantificacion();
        CargarFolio(_folioCuantificacionID);
        ObtenerItemCodes();
        CargarDatosGrid();
    };
    function ControlErroresObjetosComboBox(control, result) {
        if (Error(result)) {
            $("#" + control).data("kendoComboBox").dataSource.data(result);
        } else {
            $("#" + control).data("kendoComboBox").dataSource.data([]);
        };
    };

    function CargarProyecto(id, value) {
        Proyecto = {};
        Proyecto = { ProyectoID: id, Nombre: value };
    };

    function CargarFolio(id) {
        FolioCuantificacion = {};
        FolioCuantificacion = { FolioCuantificacionID: id };
    };
    
    function CargarItemCode(id) {
        ItemCode = {};
        ItemCode = { ItemCodeID: id };
    };

    function CargarNumeroUnico(id) {
        NumeroUnico = {};
        NumeroUnico = { NumeroUnicoID: id };
    };
    
    function limpiarFiltroItemCode() {
        ItemCode = {};
        LimpiarCombo("ItemCode");
        $("#grid").data("kendoGrid").dataSource.data([]);
    };
    
    function LimpiarFiltrosProyecto(){
        LimpiarCombo("ItemCode");
        LimpiarCombo("FolioCuantificacionID");
        $("#grid").data("kendoGrid").dataSource.data([]);
    };

    function LimpiarCombo(control) {
        $("#" + control).data("kendoComboBox").value("");
        $("#" + control).data("kendoComboBox").dataSource.data([]);
    };

    function ControlErroresObjetosComboBox(control, result) {
        if (Error(result)) {
            $("#" + control).data("kendoComboBox").dataSource.data(result);
        } else {
            $("#" + control).data("kendoComboBox").dataSource.data([]);
        };
    };
    function ObtenerProyecto() {
        $Proyecto.Proyecto.read({ token: Cookies.get("token") }).done(function (result) {
            ControlErroresObjetosComboBox("ProyectoID", result);
            CargarDatosGrid();
        });
    };

    function ObtenerFoliosCuantificacion() {
        var Listado;
        Listado = { ProyectoID: Proyecto.ProyectoID, TipoListado: "9", token: Cookies.get("token") };

        $folioEntradaMaterial.Listado.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            ControlErroresObjetosComboBox("FolioCuantificacionID", result);
            CargarDatosGrid();
        });
    };

    function ObtenerItemCodes() {
        var Listado;
        Listado = { FolioCuantificacionID: FolioCuantificacion.FolioCuantificacionID, TipoListado: "10", token: Cookies.get("token") };

        $folioEntradaMaterial.Listado.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            ControlErroresObjetosComboBox("ItemCode", result);
            CargarDatosGrid();
        });
    };

    function CargarDatosGrid() {
        loadingStart();
        var ProyectoID = Proyecto.ProyectoID ? Proyecto.ProyectoID : "";
        var FolioCuantificacionID = FolioCuantificacion.FolioCuantificacionID ? FolioCuantificacion.FolioCuantificacionID : "";
        var ItemCodeid = ItemCode.ItemCodeID ? ItemCode.ItemCodeID : "";
        
        var Listado = { ProyectoID: ProyectoID, ItemCodeID: ItemCodeid, FolioCuantificacionID: FolioCuantificacionID, TipoListado: "8", token: Cookies.get("token") };

        $DummyGenerarOrdenAlmacenaje.DummyGenerarOrdenAlmacenaje.read({}, { data: JSON.stringify(Listado) }).done(function (result) {
            if (Error(result)) {
                        _resultadoJson = result;
                        if (_resultadoJson.length > 0) {
                            $("#grid").data("kendoGrid").dataSource.data(_resultadoJson);
                        } else {
                            $("#grid").data("kendoGrid").dataSource.data([]);
                        };
            }
            loadingStop();
        });
    };

    function NodoPadre(row, id) {
        var checkbox = $(row);
        $(row.parentNode.parentNode.parentNode.parentNode.parentNode.childNodes[2]).find(".materiales").prop("checked", checkbox.is(":checked"));
        $(row.parentNode.parentNode.parentNode.parentNode.parentNode.childNodes[2]).find(".materiales").prop("disabled", checkbox.is(":checked"));

        $(row.parentNode.parentNode.parentNode.parentNode.parentNode.childNodes[2]).find(".materiales").each(function (i, val) {
            var checked = val.checked;
            checkItemCodesID[id, $(val).closest("tr").children()[1].innerHTML] = { FolioCuantificacionID: id, ItemCodeID: $(val).closest("tr").children()[1].innerHTML, checked: checked, TipoMaterial: $(val).closest("tr").children()[7].innerHTML };
        });
        
    };

    function NodoHijo(row,id) {
        var checkbox = $(row);
        checkItemCodesID[id, $(row).closest("tr").children()[1].innerHTML] = { FolioCuantificacionID: id, ItemCodeID: $(row).closest("tr").children()[1].innerHTML, checked: checkbox.is(":checked"), TipoMaterial: $(row).closest("tr").children()[7].innerHTML };
    };

    function GenerarOrdenRecepcionNuevo() {
        var itemCodes = [], x = 0, folios = [];
        OrdenRecepcion = { ID: "", Folios:""};

        for (var i in checkItemCodesID) {
            if (checkItemCodesID[i].checked == true)
            {
                itemCodes[x] = { ID: parseInt(checkItemCodesID[i].ItemCodeID) };
                x++;
            }
        }

        x = 0;
        for (var i in checkNodoPrincipal) {
            if (checkNodoPrincipal[i].checked == true) {
                folios[x] = { ID: parseInt(checkNodoPrincipal[i].FolioCuantificacionID) };
                x++;
            }
        }
        loadingStart();
        OrdenRecepcion.Folios = folios;
        OrdenRecepcion.Items = itemCodes;

        if (itemCodes.length > 0 || folios) {
            $OrdenRecepcion.OrdenRecepcion.create(OrdenRecepcion, { token: $.cookie("token") }).done(function (result) {
                loadingStop();
                if (Error(result)) {
                    var url = "@Url.Action("GenerarOrdenRecepcion", "OrdenRecepcion")";
                    window.location.href = url + "?leng=" + $("#language").data("kendoDropDownList").value();
                }
            });
        } else {
            displayMessage("notificationslabel0044", "", '1');
        }
    };

    function GenerarOrdenRecepcion() {
        var itemCodes = [], x = 0, folios = [];
        OrdenRecepcion = { ID: "", Folios: "" };

        for (var i in checkItemCodesID) {
            if (checkItemCodesID[i].checked == true) {
                itemCodes[x] = { ID: parseInt(checkItemCodesID[i].ItemCodeID) };
                x++;
            }
        }

        x = 0;
        for (var i in checkNodoPrincipal) {
            if (checkNodoPrincipal[i].checked == true) {
                folios[x] = { ID: parseInt(checkNodoPrincipal[i].FolioCuantificacionID) };
                x++;
            }
        }
        loadingStart();
        OrdenRecepcion.Folios = folios;
        OrdenRecepcion.Items = itemCodes;
       

        if (itemCodes.length > 0 || folios) {
            
            $OrdenRecepcion.OrdenRecepcion.create(OrdenRecepcion, { token: $.cookie("token") }).done(function (result) {
                loadingStop();
                if (Error(result)) {
                    var url = "@Url.Action("DetalleOrdenRecepcion", "OrdenRecepcion")";
                    window.location.href = url + "?leng=" + $("#language").data("kendoDropDownList").value() + "&OrdenRecepcionID=" + result.OrdenRecepcionID;
                }
            });
        } else {
            displayMessage("notificationslabel0044", "", '1');
        }
    };
    
    
    function GenerarOrdenRecepcionFormatoEtiquetas() {
        var itemCodes = [], x = 0, folios = [];
        OrdenRecepcion = { ID: "", Folios: "" };

        for (var i in checkItemCodesID) {
            if (checkItemCodesID[i].checked == true) {
                itemCodes[x] = { ID: parseInt(checkItemCodesID[i].ItemCodeID) };
                x++;
            }
        }

        x = 0;
        for (var i in checkNodoPrincipal) {
            if (checkNodoPrincipal[i].checked == true) {
                folios[x] = { ID: parseInt(checkNodoPrincipal[i].FolioCuantificacionID) };
                x++;
            }
        }
        loadingStart();
        OrdenRecepcion.Folios = folios;
        OrdenRecepcion.Items = itemCodes;

        if (itemCodes.length > 0 || folios) {
            
            $OrdenRecepcion.OrdenRecepcion.create(OrdenRecepcion, { token: $.cookie("token") }).done(function (result) {
                loadingStop();
                if (Error(result)) {
                    window.open("@Url.Action("FormatoEtiquetas", "OrdenRecepcion")" + "?leng=" + $("#language").data("kendoDropDownList").value() + "&OrdenRecepcion=" + result.OrdenRecepcionID);
                    window.open("http://www.asp.net");//Webservice

                    var url = "@Url.Action("DetalleOrdenRecepcion", "Cuantificacion")";
                    window.location.href = url + "?leng=" + $("#language").data("kendoDropDownList").value() + "&OrdenRecepcionID=" + result.OrdenRecepcionID;
                }
            });
        } else {
            displayMessage("notificationslabel0044", "", '1');
        }
    };

    function Error(data) {
        if (data.ReturnCode) {
            if (data.ReturnCode != 200) {
                if (data.ReturnCode == 401) {
                    removeUserSession();
                    return true;
                } else {
                    displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                    return false;
                }
            } else {
                return true;
            }
        } else {
            return true;
        }
    };

    }

    function onDataBoundPrincipal(e) {
        console.log("onDataBoundPrincipal");
        var view = this.dataSource.view();
        var body = this.tbody[0];
        for (var i = 0; i < body.children.length; i++) {

            if (checkNodoPrincipal[body.children[i].children[2].innerHTML]) {
                $(body.children[i]).find(".master").attr("checked", checkNodoPrincipal[body.children[i].children[2].innerHTML].checked);
            }

        }
    };

    function onDataBoundNumerosUnicos(e) {
        console.log("onDataBoundAccesorios");
        var view = this.dataSource.view();
        var body = this.tbody[0];
        
            for (var i = 0; i < body.children.length; i++) {

                if (checkItemCodesID[body.children[i].children[8].innerHTML, body.children[i].children[1].innerHTML]) {
                    if (!$(body.children[i]).find(".materiales").is(":disabled"))
                        $(body.children[i]).find(".materiales").attr("checked", checkItemCodesID[body.children[i].children[8].innerHTML, body.children[i].children[1].innerHTML].checked);
                }
            }
        
    };

    function detailInit(e) {
        var checked = "";
        if (e.masterRow[0].children[1].children[0].checked) {
            checked = "checked disabled";
        }

        $("<div/>").appendTo(e.detailCell).kendoGrid({
            dataSource: {
                data: e.data.ItemCodes,
                schema: {
                    model: {
                        fields: {
                            ItemCodeID: { type: "string" },
                            Codigo: { type: "string" },
                            Descripcion: { type: "string" },
                            D1: { type: "string" },
                            D2: { type: "string" },
                            Cantidad: { type: "string" },
                            FolioCuantificacion: { type: "string" },
                        }
                    }
                }
            },
            detailInit: detailInitNumeros,
            //dataBound: onDataBoundNumerosUnicos,
            autoBind: true,
            scrollable: false,
            sortable: false,
            columns: [
                { template: '<input type="checkbox" ' + checked + ' class="materiales" onclick="NodoHijo(this,' + e.data.FolioCuantificacion + ');"/>', headerTemplate: '<label ><input type="checkbox" ' + checked + ' id="checkAll" onclick="NodoPadre(this,' + e.data.FolioCuantificacion + ');"></label>', width: '30px' },
                { field: "ItemCodeID", title: _dictionary.GenerarOrdenAlmacenaje0018[$("#language").data("kendoDropDownList").value()], width: "110px" },
                { field: "Codigo", title: _dictionary.GenerarOrdenAlmacenaje0019[$("#language").data("kendoDropDownList").value()], width: "70px" },
                { field: "Descripcion", title: _dictionary.GenerarOrdenAlmacenaje0020[$("#language").data("kendoDropDownList").value()], width: "200px" },
                { field: "D1", title: _dictionary.GenerarOrdenAlmacenaje0021[$("#language").data("kendoDropDownList").value()], width: "50px" },
                { field: "D2", title: _dictionary.GenerarOrdenAlmacenaje0022[$("#language").data("kendoDropDownList").value()], width: "50px" },
                { field: "Cantidad", title: _dictionary.GenerarOrdenAlmacenaje0023[$("#language").data("kendoDropDownList").value()], width: "50px" },
                { field: "FolioCuantificacion", title: _dictionary.GenerarOrdenAlmacenaje0017[$("#language").data("kendoDropDownList").value()], width: "70px" },
            ]
        });
       
    }


    function detailInitNumeros(e) {
        var checked = "";
        if (e.masterRow[0].children[1].children[0].checked) {
            checked = "checked disabled";
        }
        //if (e.data.Accesorios.length > 0) {
        $("<div/>").appendTo(e.detailCell).kendoGrid({
            dataSource: {
                data: e.data.NumerosUnicos,
                schema: {
                    model: {
                        fields: {
                            FolioCuantificacion: { type: "string" },
                            ItemCodeID: { type: "string" },
                            NumeroUnicoID: { type: "string" },
                            NumeroUnico: { type: "string" }
                        }
                    }
                }
            },
            //dataBound: onDataBoundNumerosUnicos,
            autoBind: true,
            scrollable: false,
            sortable: false,
            columns: [
                { template: '<input type="checkbox" ' + checked + ' class="materiales" onclick="NodoHijo(this,' + e.data.FolioCuantificacion + ');"/>', headerTemplate: '<label ><input type="checkbox" ' + checked + ' id="checkAll" onclick="NodoPadre(this,' + e.data.FolioCuantificacion + ');"></label>', width: '30px' },
                { field: "FolioCuantificacion", title: _dictionary.GenerarOrdenAlmacenaje0024[$("#language").data("kendoDropDownList").value()], width: "110px" },
                { field: "ItemCodeID", title: _dictionary.GenerarOrdenAlmacenaje0025[$("#language").data("kendoDropDownList").value()], width: "70px" },
                { field: "NumeroUnicoID", title: _dictionary.GenerarOrdenAlmacenaje0026[$("#language").data("kendoDropDownList").value()], width: "200px" },
                { field: "NumeroUnico", title: _dictionary.GenerarOrdenAlmacenaje0027[$("#language").data("kendoDropDownList").value()], width: "50px" },
            ]
        });
    }

    @section JavascriptDocumentReadyFunctions 
    {
    $authorizationModel["Orden Recepcion"] = $GenerarOrdenRecepcionModel;
    CargaInicial();
    
    if (_folioCuantificacionID != "-1" && _proyectoID != "-1") {
        CargaInicialEdicion();
    }
    
    }

    @section JavascriptDocumentReadyHomeCookie {
    Cookies.set("home", true, { path: '/' });
    Cookies.set("navegacion", "13", { path: '/' });
    }
</script>