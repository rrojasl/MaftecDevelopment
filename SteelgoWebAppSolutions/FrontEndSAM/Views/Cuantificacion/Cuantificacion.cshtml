
@{
    ViewBag.Title = "Cuantificación";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="Cuantificacion0001"></span></a>
    </li>
    <li>
        <a href="@Url.Action("DashboardRecepcionAlmacenaje", "DashboardRecepcionAlmacenaje")"><span id="Cuantificacion0084"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("Cuantificacion", "Cuantificacion")"><span id="Cuantificacion0002"></span></a>
    </li>
}

<div id="formCuantificacion" class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <span id="divFolio" class="folioLabel hidden">
                <span id="Cuantificacion0079"></span>
                <span id="spanFolio"></span>
                <span id="Cuantificacion0080"></span>
                <span id="Cuantificacion0076" class="statusLabel"></span>
                <span id="Cuantificacion0077" class="statusLabel"></span>
                <span id="Cuantificacion0078" class="statusLabel"></span>
                <span id="Cuantificacion0086" class="statusLabel"></span>
                <div class="branchCut"></div>
            </span>
            <div class="formNav clearfix">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="button-section editButtonSection">
                            <div class="btn-group save-group">
                                <button id="Guardar" onclick="javascript:void(0);" type="button" class="btn btn-yellow creacion"><span id="Cuantificacion0003"></span></button>
                                <button id="Editar" onclick="javascript:void(0);" type="button" class="btn btn-yellow editar" style="display:none"><span id="Cuantificacion0004"></span></button>
                                <button id="dropdown-toggle" type="button" class="btn btn-yellow dropdown-toggle creacion" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caretWhite"></span>
                                </button>
                                <ul class="dropdown-menu creacion">
                                    <li id="MenuTerminar"><a id="TerminaryNuevo" href="#"><span id="Cuantificacion0005"></span></a></li>
                                    <li id="MenuGuardarParcial"><a id="GuardarParcialyNuevo" href="#"><span id="Cuantificacion0008"></span></a></li>
                                    <li id="MenuCerrar"><a id="GuardaryCerrar" href="#"><span id="Cuantificacion0009"></span></a></li>
                                    <li id="guardarBulto"><a id="GuardaryTerminar" href="#"><span id="Cuantificacion0075"></span></a></li>
                                </ul>

                            </div>
                            <a id="Cancelar" href="#" class="btn btn-black"><span id="Cuantificacion0010"></span></a>
                        </div>
                        <div class="button-section ordenrecepcion">
                            <a id="GenerarOrdenRecepcion" href="#" class="btn btn-primary"><span id="Cuantificacion0011"></span></a>
                        </div>
                        <div class="button-section listado">
                            <div class="dropdown action-group">
                                <a id="Acciones" data-target="#" href="#" data-toggle="dropdown" role="button" ariahaspopup="true" aria-expanded="false" class="btn btn-default">
                                    <span id="Cuantificacion0042"></span>
                                    <span class="caretBlue"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="Acciones">
                                    <li><a id="ImprimirOrdenRecepcion"><span id="Cuantificacion0082"></span></a></li>
                                    <li class="incidencia"><a id="IrIncidencia" href="#"><span id="Cuantificacion0083"></span></a></li>
                                    <li id="AccionRegresar"><a id="RegresarListadoPadre" href="#" ><span id="Cuantificacion0085"></span></a></li>
                                </ul>
                            </div>
                        </div>
                        <a id="Imprimir" href="#" class="btn btn-fadeBlue"></a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div id="FolioAvisoEntradaDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0012"></label>
                            <input id="FolioAvisoEntradaID" class="" />
                        </div>
                        <div id="ProyectoDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0013"></label>
                            <input id="ProyectoID" />
                        </div>
                        <div id="FolioCuantificacionDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0014"></label>
                            <input id="FolioCuantificacionID" />
                        </div>
                        <div id="BultoDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0015"></label>
                            <input id="BultoID" disabled="disabled" class="general-input"/>
                        </div>
                        <div id="PackingListDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0016"></label>
                            <input id="PackingList" class="general-input"/>
                        </div>
                        <div id="TipoPackingListDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0017"></label>
                            <input id="TipoPackingListID" />
                        </div>
                        <div id="TipoUsoDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0018"></label>
                            <input id="TipoUsoID" />
                        </div>
                        <div id="massiveUploadDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0019"></label>
                            <div class="row">
                                <div class="col-xs-6 col-sm-4 col-md-4 col-lg-4">
                                    <button id="massiveUpload" class="btn btn-primary"><span id="Cuantificacion0020"></span></button>
                                </div>
                                <div class="col-xs-6 col-sm-8 col-md-8 col-lg-8">
                                    <a href="../FormatoCargaMasiva.csv">
                                        <label id="Cuantificacion0081" class="download"></label>
                                    </a>
                                </div>
                            </div>
                            <input name="txtFileUpload" id="txtFileUpload" type="file" class="hidden" />
                        </div>
                        
                        
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="addedSection clearfix">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-11">
                        <div id="ColadaDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0022"></label>
                            <input id="Colada" class="" />
                        </div>
                        <div id="CantidadDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0023"></label>
                            <input id="Cantidad" class="general-input" />
                        </div>
                        <div id="MMDiv" class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0024"></label>
                            <input id="MM" class="general-input" />
                        </div>
                        <div class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0025"></label>
                            <div class="row">
                                <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3">
                                    <label id="Cuantificacion0026" class="centered"></label>
                                    <input id="todos" class="" type="radio" name="radio" checked value="1">
                                </div>
                                <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3">
                                    <label id="Cuantificacion0027" class="centered"></label>
                                    <input id="vacios" class="" type="radio" name="radio" value="2" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div id="grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                
        <ul id="menu" >
            <li id="NuevoItemCode"><span id="Cuantificacion0089"></span></li>
            <li id="Detallar"><span id="Cuantificacion0087"></span></li>
            <li id="Incidencia" class="incidencia"><span id="Cuantificacion0088"></span></li>
            <li id="NuevaColada"><span id="Cuantificacion0090"></span></li>
        </ul>
    </div>
</div>

<div id="window">
</div>
<input id="hdnNavegacion" type="hidden" value="" />
<script>
    @section JavascriptGlobalVariables 
    {
            var fromButton=false;
            var Proyecto = {}, Cuantificacion = {}, FolioAvisoEntrada = {}, TipoPackingList = {}, TipoUso = {}, resultadoJson,
            itemCodesJson, itemCodesJsonSteelgo, lastEditedCellID = "", lastEditedCellIDSteelgo = "", lastEditedCellIDSColada,
            familiaItemCode = {}, familiaItemCodeSteelgo = {}, ProyectoItemCode = {},
            ProyectoItemCodeSteelgo = {}, TipoPackingListItemCode = {}, TipoPackingListItemCodeSteelgo = {},
            ColadaItemCodeSteelgo = {}, ColadaItemCode = {},
            ctrlDown = false, ctrlKey = 17, vKey = 86, cKey = 67, focusResp = "FolioAvisoEntradaID";;
            var _cuantificacionUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";

            var _folioAvisoEntradaID = getUrlParameter("FolioAvisoEntradaID", "-1");
            var _folioCuantificacion = getUrlParameter("FolioCuantificacionID", "-1");
            //var _folioLlegadaMaterialID = getUrlParameter("FolioLlegadaMaterialID", "-1");
            var _bultoID = getUrlParameter("BultoID", "-1");
            var _detalleBulto = getUrlParameter("DetalleBulto", "-1");
            var _edicion = getUrlParameter("EdicionPackingList", "-1");
            var _incidenciasURL = "@Url.Action("Incidencias", "Incidencias")"; 

            //Mappeo de Controles y sus flechas
            var mapeoNavegacion = {
                "FolioAvisoEntradaID": { 37: "FolioAvisoEntradaID", 38: "FolioAvisoEntradaID", 39: "ProyectoID", 40: "PackingList" },
                "ProyectoID": { 37: "FolioAvisoEntradaID", 38: "ProyectoID", 39: "FolioCuantificacionID", 40: "TipoPackingListID" },
                "FolioCuantificacionID": { 37: "ProyectoID", 38: "FolioCuantificacionID", 39: "PackingList", 40: "TipoUsoID" },
                "BultoID": { 37: "BultoID", 38: "BultoID", 39: "PackingList", 40: "TipoPackingListID" },
                "PackingList": { 37: "FolioCuantificacionID", 38: "FolioAvisoEntradaID", 39: "TipoPackingListID", 40: "Colada" },
                "TipoPackingListID": { 37: "PackingList", 38: "ProyectoID", 39: "TipoUsoID", 40: "Cantidad" },
                "TipoUsoID": { 37: "TipoPackingListID", 38: "FolioCuantificacionID", 39: "Colada", 40: "MM" },
                "Colada": { 37: "TipoUsoID", 38: "PackingList", 39: "Cantidad", 40: "grid" },
                "Cantidad": { 37: "Colada", 38: "TipoPackingListID", 39: "MM", 40: "grid" },
                "MM": { 37: "Cantidad", 38: "TipoUsoID", 39: "grid", 40: "grid" },
                "grid": { 37: "MM", 38: "Colada", 39: "grid", 40: "grid" },
            };


            //Mappeo de tipos de Controles
            //--   Tipos 0 -> Elemento HTML
            //--   Tipos 1 -> Elemento KendoAutocomplete
            //--   Tipos 2 -> Elemento KendoComboBox
            //--   Tipos 3 -> Elemento KendoDropDownList
            //--   Tipos 4 -> Elemento KendoGrid
            var mapeoTiposControles = {
                "FolioAvisoEntradaID": 2,
                "ProyectoID": 2,
                "FolioCuantificacionID": 2,
                "BultoID": 0,
                "PackingList": 0,
                "TipoPackingListID": 2,
                "TipoUsoID": 2,
                "Colada": 2,
                "Cantidad": 0,
                "MM": 0,
                "grid": 4
            };


            var $CuantificacionModel = {
                listContainer: {
                    create: ".creacion",
                    list: ".listado",
                    detail: ".editar",
                    destroy: ".k-grid-Cancelar",
                    createIncidence: ".incidencia"
                },
                properties: {
                    folioAvisoEntradaID: {
                        visible: "#FolioAvisoEntradaDiv",
                        editable: "#FolioAvisoEntradaID",
                        required: "#FolioAvisoEntradaID"
                    },
                    proyecto: {
                        visible: "#ProyectoDiv",
                        editable: "#ProyectoID",
                        required: "#ProyectoID"
                    },
                    folioCuantificacion: {
                        visible: "#FolioCuantificacionDiv",
                        editable: "#FolioCuantificacionID",
                        required: "#FolioCuantificacionID"
                    },
                    bulto: {
                        visible: "#BultoDiv",
                        editable: "#BultoID",
                        required: "#BultoID"
                    },
                    packinglist: {
                        visible: "#PackingListDiv",
                        editable: "#PackingList",
                        required: "#PackingList"
                    },
                    tipoPackingList: {
                        visible: "#TipoPackingListDiv",
                        editable: "#TipoPackingListID",
                        required: "#TipoPackingListID"
                    },
                    tipouso: {
                        visible: "#TipoUsoDiv",
                        editable: "#TipoUsoID",
                        required: "#TipoUsoID"
                    },
                    cargamasiva: {
                        visible: "#massiveUploadDiv",
                        editable: "#massiveUpload",
                        required: "#massiveUpload"
                    },
                    colada: {
                        visible: "#ColadaDiv",
                        editable: "#Colada",
                        required: "#Colada"
                    },
                    cantidad: {
                        visible: "#CantidadDiv",
                        editable: "#Cantidad",
                        required: "#Cantidad"
                    },
                    mm: {
                        visible: "#MMDiv",
                        editable: "#MM",
                        required: "#MM"
                    }
                }
            };


            var $OrdenRecepcionModel = {
                listContainer: {
                    create: ".ordenrecepcion",
                    list: "",
                    detail: "",
                    destroy: "",
                    createIncidence: ""
                },
                properties: {
                }
            };

            var $ItemCodeModel = {
                listContainer: {
                    create: "#grid",
                    list: "#grid",
                    detail: "#grid",
                    destroy: ".k-grid-Cancelar",
                    createIncidence: ""
                },
                properties: {

                }
            };

            var $ColadaModel = {
                listContainer: {
                    create: "",
                    list: "",
                    detail: "",
                    destroy: "",
                    createIncidence: ""
                },
                properties: {

                }
            };

            var $BultoModel = {
                listContainer: {
                    create: "",
                    list: "",
                    detail: "",
                    destroy: "",
                    createIncidence: ""
                },
                properties: {

                }
            };
    };

    function ItemsSumarDuplicados(){
        var ArrTodos = [], results = [], ArrFinal = [];
        var ds = $("#grid").data("kendoGrid").dataSource;
        var data = $("#grid").data("kendoGrid").dataSource.data();
       
        var item = [];

        for (var i = 0; i < data.length; i++) {
            var row = ds.at(i);
            ArrTodos[i] = row.ItemCode;
            item[i] = { ItemCode: row.ItemCode, BultoID: row.BultoID, Descripcion: row.Descripcion, D1: row.D1, D2: row.D2, ItemCodeSteelgo: row.ItemCodeSteelgo, Familia: row.Familia, Cedula: row.Cedula, TipoAcero: row.TipoAcero, Colada: row.Colada, Cantidad: row.Cantidad, MM: row.MM, Detallar: row.Detallar, TieneNU: row.TieneNU, TieneError: row.TieneError };
        };


        var temp = {};
        for (var i = 0; i < item.length ; i++) {
            var obj = item[i];
            if (temp[obj.ItemCode] >= 0) {
                item.splice(i, 1);
                i--;
            }
            temp[obj.ItemCode] = i;
        }
       
        results = ObtenerTodoslosItems(ArrTodos);
        ArrFinal = SumarDuplicados(results, data, ds);
        RemoverItemsGrid(ds, data, ArrFinal);

        if (ArrFinal.length > 0) {
            displayMessage("notificationslabel0049", "", '2');
        }
        var z = 0, ActCantidad = [];
        for (var i = 0; i < item.length; i++) {
            
            for (var x = 0; x < ArrFinal.length; x++) {
                if (ArrFinal[x].ItemCode == item[i].ItemCode) {
                    item[i].Cantidad = ArrFinal[x].Cantidad;
                    ActCantidad[z] = item[i];
                    z++;
                }
            }
        }
       
        $.each(ActCantidad, function (key) {
            var item =
                   { ItemCode: ActCantidad[key].ItemCode, BultoID: ActCantidad[key].BultoID, Descripcion: ActCantidad[key].Descripcion, D1: ActCantidad[key].D1, D2: ActCantidad[key].D2, ItemCodeSteelgo: ActCantidad[key].ItemCodeSteelgo, Familia: ActCantidad[key].Familia, Cedula: ActCantidad[key].Cedula, TipoAcero: ActCantidad[key].TipoAcero, Colada: ActCantidad[key].Colada, Cantidad: ActCantidad[key].Cantidad, MM: ActCantidad[key].MM, Detallar: ActCantidad[key].Detallar, TieneNU: ActCantidad[key].TieneNU, TieneError: ActCantidad[key].TieneError };
            $("#grid").data("kendoGrid").dataSource.insert(item);
        });

        ordenamientoGrid();
    };

    function RemoverItemsGrid(ds, data, ArrFinal) {
        for (var i = 0; i < data.length; i++) {
            var row = ds.at(i);
            for (var x = 0; x < ArrFinal.length; x++) {
                if (ArrFinal[x].ItemCode == row.ItemCode) {
                    ds.remove(row);
                    i = -1;
                }
            }
        }
    };

    function ObtenerTodoslosItems(ArrTodos) {
        var arr = ArrTodos;
        var sorted_arr = arr.sort();
        var results = [];
        for (var i = 0; i < arr.length - 1; i++) {
            if (sorted_arr[i + 1] == sorted_arr[i]) {
                results.push(sorted_arr[i]);
            }
        }
        return results;
    };

    function SumarDuplicados(results, data, ds) {
        var z = 0;
        var ArrFinal = [];
        var results = unique(results);
        for (var x = 0; x < results.length; x++) {
            var sum = 0;
            ArrFinal[z] = { ItemCode: results[x], Cantidad: sum };
            for (var i = 0; i < data.length; i++) {
                var row = ds.at(i);
                if (results[x] == row.ItemCode) {
                    sum += row.Cantidad;
                    ArrFinal[z].Cantidad = sum;
                }
            }
            z++;
        }
        return ArrFinal;
    };


    function unique(list) {
        var result = [];
        $.each(list, function (i, e) {
            if ($.inArray(e, result) == -1) {
                console.log(e)
                result.push(e);
            }
        });
        return result;
    }

    @section JavascriptGlobalFunctions 
    {
        function changeLanguageCall() {
            var tmp=removeGrid($("#grid"));
            LoadGridQuantification();
            $("#grid").data("kendoGrid").dataSource.data(tmp);
        }

        function cargaInicial() {
            //$("#Ciclo").click(function () {
            //    ItemsSumarDuplicados();
            //});

            document.getElementById('txtFileUpload').addEventListener('change', upload, false);
            document.getElementById("txtFileUpload").addEventListener("click", function (event) {
                this.value = null;
            });
            $("#guardarBulto").css("display", "none");
            $("#MenuTerminar").css("display", "block");
            $("#MenuGuardarParcial").css("display", "block");
            $("#MenuCerrar").css("display", "block");
            $("#AccionRegresar").css("display", "none");

            //Botones
            $("#Guardar").click(function () {
                var idguardado = 3;
                if (_detalleBulto != "-1") {
                    idguardado = 5;
                }
                if (validarRequeridosFormaCuantificacion()) {
                    GuardarParcial(false, idguardado);
                } else{
                    displayMessage("notificationslabel0031", "", '1');
                }
            });

            $("#Editar").click(function (e) { BotonEdicion(); });
            $("#TerminaryNuevo").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    TerminaryNuevo();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#GuardarParcialyNuevo").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    GuardarParcial(true,3);
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#GuardaryCerrar").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    GuardaryCerrar();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#GuardaryTerminar").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    GuardaryTerminar();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
          
            $("#GenerarOrdenRecepcion").click(function () {
                if(validarRequeridosFormaCuantificacion()){
                    GenerarOrdenRecepcion();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#massiveUpload").click(function () { $(".k-upload-files.k-reset").find("li").remove(); });
            $("#RegresarListadoPadre").click(function () {
                RegresarListadoPadre();
            });
           

            $("#Cancelar").click(function () { Cancelar(); });
            $("#IrIncidencia").click(function () { Incidencias(); });

            $("#FolioAvisoEntradaID").kendoComboBox({
                    dataTextField: "value",
                    dataValueField: "id",
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        CargarFolioAvisoEntrada(dataItem.id,dataItem.value);
                   
                    },
                    change: function (e) {
                        var value = this.value();

                        limpiarfiltrosFolioAvisoEntrada();
                        $("#TipoPackingListID").data("kendoComboBox").enable(true);
                        if (!value || this.selectedIndex == -1) {
                            messageindexKendoCombobox(this);
                            FolioAvisoEntrada = {};
                            this.value("");
                        } else {
                            ObtenerDatosDelFolioAvisoLlegada();
                        }
                    
                    },
                    filter: "contains",
            });
            ObtenerFoliosAvisoLlegada();
            $("#FolioAvisoEntradaID").data("kendoComboBox").input.focus();

            $("#ProyectoID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "ProyectoID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarProyecto(dataItem.ProyectoID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value || this.selectedIndex == -1) {
                        messageindexKendoCombobox(this);
                        Proyecto = {};
                        this.value("");
                    } else {
                        ObtenerTipoUsoPorProyecto(FolioAvisoEntrada.FolioAvisoEntradaID, Proyecto.ProyectoID);
                    }
                    //ObtenerColada("Colada", 0, 0);
                },
                filter: "contains",
            });
            
            $("#FolioCuantificacionID").kendoComboBox({
                dataTextField: "FolioCuantificacionID",
                dataValueField: "FolioAvisoEntradaID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarFolioCuantificacion(dataItem.FolioCuantificacionID);
                },
                change: function (e) {
                    var value = this.value();
                    limpiarfiltrosFolioLlegada();
                    if (!value || this.selectedIndex == -1) {
                        messageindexKendoCombobox(this);
                        Cuantificacion = {};
                        this.value("");
                        $("#TipoPackingListID").data("kendoComboBox").enable(true);
                    } else {
                        ObtenerDatosDelFolioAvisoLlegadaCuantificacion(FolioAvisoEntrada.FolioAvisoEntradaID, Cuantificacion.FolioCuantificacionID);// debe de ponerse el folio de llegada de material
                    }
            },
                filter: "contains",
            });

            $("#TipoPackingListID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "id",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarTipoPackingList(dataItem.id, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value || this.selectedIndex == -1) {
                        messageindexKendoCombobox(this);
                        TipoPackingList = {};
                        this.value("");
                        changeValueColumnMMPackingList("");
                    } else {
                        if (value == "2") {
                            changeValueColumnMMNoAplica();
                        } else {
                            changeValueColumnMMPackingList();
                        }
                    };
                },
                filter: "contains",
            });
            obtenerTipoPackingList("TipoPackingListID");

            $("#TipoUsoID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "id",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarTipoUso(dataItem.id, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value || this.selectedIndex == -1) {
                        messageindexKendoCombobox(this);
                        TipoUso = {};
                        this.value("");
                    };
                },
                filter: "contains",
            });
            ObtenerTipoUso();


            $("#Colada").kendoAutoComplete({
                dataTextField: "Nombre",
                dataValueField: "ColadaID",
                autoBind: false,
                minLength: 3,
                dataSource: {
                    type: "json",
                    serverFiltering: true,
                    transport: {
                        read: {
                            url: function (op) {
                                var val="";
                                if(op.filter){
                                    val = op.filter.filters[0].value;
                                }
                                return $URLColada + "proyectoID=" + (Proyecto.ProyectoID ? Proyecto.ProyectoID : -1) + "&token=" + Cookies.get("token") + "&paginaID=" + Cookies.get("navegacion") + "&texto=" + val + "&idioma=" + $("#language").data("kendoDropDownList").value() + "&id=0&mostrarOpcion=0"
                            }
                        }
                    },
                },
                change: function (e) {
                    var value = this.value();
                    if (!value || !e.sender.current()) {
                        messageindexKendoCombobox(this);
                        this.value("");
                    }else{
                        changeValueColumnColada($("#Colada").data("kendoAutoComplete").value());
                        $("#Colada").data("kendoAutoComplete").value("");
                    }
                },
               
                filter: "contains",
            });
            

            $("#Cantidad").keydown(function (e) {
                if (e.keyCode == 13) {
                    if (esNumero(this.value)) {
                        changeValueColumnCantidad(this.value);
                    }
                    $("#Cantidad").val("");
                }
            });

            $("#MM").keydown(function (e) {
                if (e.keyCode == 13) {
                    if (esNumero(this.value)) {
                        changeValueColumnMM(this.value);
                    }
                    $("#MM").val("");
                }
            });

            //$('input:radio').click(function () {
            //    if ($(this).val() === '1') {
            //        changeValueColumnsAll();
            //    } else if ($(this).val() === '2') {
            //        changeValueColumnsClear();
            //    }
            //});

            //Por default tubos
            CargarTipoPackingList(1, "");
           $("#TipoPackingListID").data("kendoComboBox").value(1);

            
        };
       
        function Cancelar() {
            var detalleIdeaUrl = "@Url.Action("DashboardRecepcionAlmacenaje", "DashboardRecepcionAlmacenaje")";
            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
        };

        function RegresarListadoPadre() {
            window.location.href = _cuantificacionUrl + "?leng=" + $("#language").data("kendoDropDownList").value() + "&EdicionPackingList=1&FolioAvisoEntradaID=" + _folioAvisoEntradaID + "&FolioCuantificacionID=" + _folioCuantificacion;
        };

        function cargaInicialEdicionDetalleBulto() {
            DetalleBultoObtenerDatosDelFolioAvisoLlegadaCuantificacion(_folioAvisoEntradaID, _folioCuantificacion, _bultoID);

        };
        

        function cargaInicialEdicion() {
            $("#AccionRegresar").css("display", "none");
            $("#FolioAvisoEntradaID").data("kendoComboBox").value(_folioAvisoEntradaID);
            $("#FolioCuantificacionID").data("kendoComboBox").text(_folioCuantificacion != "-1" ? _folioCuantificacion : "");
            CargarFolioCuantificacion(_folioCuantificacion);
            CargarFolioAvisoEntrada(_folioAvisoEntradaID, _folioAvisoEntradaID);

            ObtenerDatosDelFolioAvisoLlegada();
            ObtenerDatosDelFolioAvisoLlegadaCuantificacion(_folioAvisoEntradaID, _folioCuantificacion);
        };

        function BotonEdicion() {
            loadingStart();
            $("#dropdown-toggle").show();
            $("#Editar").css("display", "none");
            $("#Guardar").css("display", "block");
            habilitarControles();
        };

        function BotonAlta() {
            $("#dropdown-toggle").hide();
            $("#Editar").css("display", "block");
            $("#Guardar").css("display", "none");
            deshabilitarControles();
        };

        function habilitarControles() {
                $("#FolioAvisoEntradaID").data("kendoComboBox").enable(true);
                $("#ProyectoID").data("kendoComboBox").enable(true);
                $("#FolioCuantificacionID").data("kendoComboBox").enable(true);
                $("#PackingList").removeAttr("disabled");
                $("#TipoUsoID").data("kendoComboBox").enable(true);
                $("#massiveUpload").removeAttr("disabled");
                $("#Colada").data("kendoAutoComplete").enable(true);
                $("#Cantidad").removeAttr("disabled");
                $("#MM").removeAttr("disabled");
                $(".k-button.k-button-icontext.k-grid-add").removeClass("k-state-disabled");
                $("input:radio").removeAttr("disabled");
                $(".k-button.k-button-icontext.k-grid-Cancelar").removeClass("hidden");
                if (_detalleBulto != "-1") {
                    DeshabilitarControlesDetalleBulto();
                };
                CambiarEstatus();
        }

        function CambiarEstatus() {
                    $CambiarEstatusCuantificacion.CambiarEstatusCuantificacion.update({}, {
                        FolioCuantificacion: _folioCuantificacion, AvisoEntrada: FolioAvisoEntrada.FolioAvisoEntradaID,
                        bultoID: _bultoID,
                        token: Cookies.get("token")
                    }).done(function (data) {
                        
                        loadingStop();
                        Error(data);
                        CargarLabelEstatus("En Proceso de Recepción");

                    });
        };
        function deshabilitarControles() {
            $("#FolioAvisoEntradaID").data("kendoComboBox").enable(false);
            $("#ProyectoID").data("kendoComboBox").enable(false);
            $("#FolioCuantificacionID").data("kendoComboBox").enable(false);
            $("#BultoID").attr("disabled", "disabled");
            $("#PackingList").attr("disabled", "disabled");
            $("#TipoPackingListID").data("kendoComboBox").enable(false);
            $("#TipoUsoID").data("kendoComboBox").enable(false);
            $("#massiveUpload").attr("disabled", "disabled");
            $("#Colada").data("kendoAutoComplete").enable(false);
            $("#Cantidad").attr("disabled", "disabled");
            $("#MM").attr("disabled", "disabled");
            $(".k-button.k-button-icontext.k-grid-add").addClass("k-state-disabled");
            $("input:radio").attr('disabled', "disabled");
            $(".k-button.k-button-icontext.k-grid-Cancelar").addClass("hidden");
        };


        function CargarProyecto(id, value) {
            Proyecto = {};
            Proyecto = { ProyectoID: id, Nombre: value };
        };
        
        function CargarProyectoItemCode(id, value) {
            ProyectoItemCode = {};
            ProyectoItemCode = { ProyectoID: id, Nombre: value };
        };
        function CargarTipoPackingListItemCode(id, value) {
            TipoPackingListItemCode = {};
            TipoPackingListItemCode = { TipoPackingListID: id, Nombre: value };
        };
        
        function CargarColadaItemCode(id, value) {
            ColadaItemCode = {};
            ColadaItemCode = { ColadaID: id, Nombre: value };
        };

        function CargarProyectoItemCodeSteelgo(id, value) {
            ProyectoItemCodeSteelgo = {};
            ProyectoItemCodeSteelgo = { ProyectoID: id, Nombre: value };
        };
        
        //function CargarTipoPackingListItemCodeSteelgo(id, value) {
        //    TipoPackingListItemCodeSteelgo = {};
        //    TipoPackingListItemCodeSteelgo = { TipoPackingListID: id, Nombre: value };
        //};

        function CargarColadaItemCodeSteelgo(id, value) {
            ColadaItemCodeSteelgo = {};
            ColadaItemCodeSteelgo = { ColadaID: id, Nombre: value };
        };

        function CargarFolioAvisoEntrada(id, value) {
            FolioAvisoEntrada = {};
            FolioAvisoEntrada = { FolioAvisoEntradaID: id, FolioLlegadaMaterial: value };
        };
        
        function CargarTipoPackingList(id, value) {
            TipoPackingList = {};
            TipoPackingList = { TipoPackingListID: id, Nombre: value };
        };
        
        function CargarTipoUso(id, value) {
            TipoUso = {};
            TipoUso = { TipoUsoID: id, Nombre: value };
        };

        function CargarFolioCuantificacion(id) {
            Cuantificacion = {};
            Cuantificacion = { FolioCuantificacionID: id };
        };

        function CargarFamiliaItemCode(id) {
            familiaItemCode = {};
            familiaItemCode = { FamiliaID: id };
        };
        
        function CargarFamiliaItemCodeSteelgo(id) {
            familiaItemCodeSteelgo = {};
            familiaItemCodeSteelgo = { FamiliaID: id };
        };

        function validarRequeridosFormaColadaCuantificacion() {
            var bool = true;
            $("#formCuantificacion .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    if ($(elem).attr("id") == "ProyectoID") {
                        if (!$(this).val()) {
                            bool = false;
                            $(this).closest("div").find("label").addClass("error");
                        } else {
                            $(this).closest("div").find("label").removeClass("error");
                        };
                    };
                };
            });
            return bool;
        };

        function validarRequeridosFormaCuantificacion() {
            var bool = true;
            $("#formCuantificacion .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    if (!$(this).val()) {
                        bool = false;
                        $(this).closest("div").find("label").addClass("error");
                    } else {
                        $(this).closest("div").find("label").removeClass("error");
                    };
                };
            });
            return bool;
        };

        function ocultarStatus() {
            $("#Cuantificacion0076").hide();
            $("#Cuantificacion0077").hide();
            $("#Cuantificacion0078").hide();
            $("#Cuantificacion0086").hide();
        };

        function GenerarOrdenRecepcion() {
            if (_folioCuantificacion!="-1"){
                var detalleIdeaUrl = "@Url.Action("GenerarOrdenRecepcion", "OrdenRecepcion")";
                window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value() + "&FolioAvisoEntradaID=" + FolioAvisoEntrada.FolioAvisoEntradaID + "&ProyectoID=" + Proyecto.ProyectoID;
            } else {
                displayMessage("notificationslabel0040", "", '1');
            } 
        };

        function LoadGridQuantification() {
            $("#grid").kendoGrid({
                dataSource: {
                    data: resultadoJson,
                    autoSync: true,
                    schema: {
                        model: {
                            fields: {
                                ItemCode: { type: "string", editable: true },
                                BultoID: { type: "string", editable: true },
                                Descripcion: { type: "string", editable: false },
                                D1: { type: "number", editable: false },
                                D2: { type: "number", editable: false },
                                ItemCodeSteelgo: { type: "string", editable: true },
                                Familia: { type: "string", editable: false },
                                Cedula: { type: "string", editable: false },
                                TipoAcero: { type: "string", editable: false },
                                Colada: { type: "string", editable: true },
                                Cantidad: { type: "number", editable: true },
                                MM: { type: "string", editable: true },
                                Detallar: { type: "string", defaultValue: "No", editable: false },
                                TieneNU: { type: "string", defaultValue: "No", editable: false },
                                TieneError: { type: "boolean", defaultValue: false, editable: false }
                            }
                        }
                    },
                    serverPaging: false,
                    serverFiltering: false,
                    serverSorting: false,
                    aggregate: [
                                 { field: "Descripcion", aggregate: "count" },
                                 { field: "Cantidad", aggregate: "sum" }
                    ]
                },
                dataBound:function(e){
                    $(".k-button.k-button-icontext.k-grid-add").on("click",function(){
                        fromButton=true;
                    })
                },
                autoHeight: true,
                sortable: true,
                scrollable: true,
                filterable: getKendoGridFilterable($("#language").data("kendoDropDownList").value()),
                pageable: false,
                groupable: true,
                selectable: true,
                editable:  true,
                edit: function(e) {
                    if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Item Code"] != 'undefined') && (typeof returnOfSecurityCheck["Item Code"]["detail"] != 'undefined') && !returnOfSecurityCheck["Item Code"]["detail"]) {
                        this.closeCell();
                    }
                    if(fromButton){
                        fromButton=false;
                        $("#grid").data("kendoGrid").current($("#grid tr[data-uid] td:first"));
                    }
                },
                toolbar: [
                        "create"
                ],
                navigatable: true,
                columns: [
                    { field: "ItemCode",        title: _dictionary.Cuantificacion0028[$("#language").data("kendoDropDownList").value()], filterable: true, width: "120px", editor: itemCodeAutocomplete },
                    { field: "Descripcion",     title: _dictionary.Cuantificacion0029[$("#language").data("kendoDropDownList").value()], filterable: true, width: "150px", aggregates: ["count"], footerTemplate: "Total Count: #=count#", groupFooterTemplate: "Count: #=count#" },
                    { field: "D1",              title: _dictionary.Cuantificacion0030[$("#language").data("kendoDropDownList").value()], filterable: true, width: "80px" },
                    { field: "D2",              title: _dictionary.Cuantificacion0031[$("#language").data("kendoDropDownList").value()], filterable: true, width: "80px" },
                    { field: "ItemCodeSteelgo", title: _dictionary.Cuantificacion0032[$("#language").data("kendoDropDownList").value()], filterable: true, width: "180px", editor: itemCodeSteelgoAutocomplete },
                    { field: "Familia",         title: _dictionary.Cuantificacion0033[$("#language").data("kendoDropDownList").value()], filterable: true, width: "110px" },
                    { field: "Cedula",          title: _dictionary.Cuantificacion0034[$("#language").data("kendoDropDownList").value()], filterable: true, width: "110px" },
                    { field: "TipoAcero",       title: _dictionary.Cuantificacion0035[$("#language").data("kendoDropDownList").value()], filterable: true, width: "130px" },
                    { field: "Colada",          title: _dictionary.Cuantificacion0036[$("#language").data("kendoDropDownList").value()], filterable: true, width: "110px", editor: ColadaAutocomplete },
                    { field: "Cantidad",        title: _dictionary.Cuantificacion0037[$("#language").data("kendoDropDownList").value()], filterable: true, width: "120px", aggregates: ["sum"], footerTemplate: "Total SUM: #=sum#", groupFooterTemplate: "SUM: #=sum#" },
                    { field: "MM",              title: _dictionary.Cuantificacion0038[$("#language").data("kendoDropDownList").value()], filterable: true, width: "80px"},
                    { field: "Detallar",        title: _dictionary.Cuantificacion0039[$("#language").data("kendoDropDownList").value()], filterable: true, width: "120px" },
                    { field: "TieneNU",         title: _dictionary.Cuantificacion0040[$("#language").data("kendoDropDownList").value()], filterable: true, width: "150px" },
                    { command: { text: _dictionary.Cuantificacion0043[$("#language").data("kendoDropDownList").value()], click: CancelarInformacionItem }, title: " ", width: "99px" },
                    { field: "TieneError", title: _dictionary.Cuantificacion0041[$("#language").data("kendoDropDownList").value()], filterable: true, width: "120px", hidden: true },
                    { field: "BultoID", title: _dictionary.Cuantificacion0044[$("#language").data("kendoDropDownList").value()], filterable: true, width: "120px", hidden: true }
                ]
            });
            var grid = $("#grid").data("kendoGrid");
            var dispositivo = navigator.userAgent.toLowerCase();
            if (!dispositivo.match(/(iphone|ipod|ipad|android)/)) {
                grid.table.bind("keypress", function (e) {
                    //keydown(e);
                    if (e.which !== 0 && e.charCode !== 0 && !e.ctrlKey && !e.metaKey && !e.altKey) {
                        //get currently navigated cell, this id follows user's navigation
                        var activeCell = $("#grid_active_cell");

                        //don't do anything if already editing cell        
                        if (activeCell.hasClass("k-edit-cell")) return;

                        grid.editCell(activeCell);
                        var input = activeCell.find("input");

                        //number datatype editor loses key press character when entering edit
                        if (input.last().attr('data-type') === 'number') {
                            input.val(String.fromCharCode(e.keyCode | e.charCode));
                        } else {
                            input.val("");
                        }
                    }
                });
                
            };
            //Kendo "Enter" key input is captured through this binding
            $("#grid table").on("keydown", "tr", function (e) {
                var code = (e.keyCode ? e.keyCode : e.which);
                if (code == 13) { //If key is ENTER
                    console.log("--KendoEnter--");
                    //find index of the td element
                    var tdIndex = $(e.target).closest('td').index();
                    //get the next row's cell
                    var nextRow = $(e.target).closest('tr').next();
                    var nextRowCell = $(nextRow).find('td:eq(' + tdIndex + ')');
                    //Check if the next row is the last one and add one
                    if (nextRowCell.length == 0) {
                        var grids = $("#grid").data("kendoGrid");
                        if (grids) {
                            var dataSource = grids.dataSource;
                            var total = dataSource.data().length;
                            //dataSource.insert(total, {});
                            grids.addRow();
                        }
                        //find index of the td element
                        tdIndex = $(e.target).closest('td').index();
                        //get the next row's cell
                        nextRow = $(e.target).closest('tr').next();
                        nextRowCell = $(nextRow).find('td:eq(' + tdIndex + ')');
                        grids.current(nextRowCell);
                        //$("#grid tr[data-uid] td:first").trigger("click");
                        setTimeout(function () {
                            console.log("--Changing Current--");
                            var grid = $("#grid").data("kendoGrid");
                            //grid.current(nextRowCell);
                            $("#grid tr[data-uid] td:first").trigger("click");
                            $("#grid tr[data-uid] input:first").focus();
                        }, 0);
                    }else{
                        $("#grid").data("kendoGrid").current(nextRowCell);
                    }
                }
            });


            
                $("#menu").kendoContextMenu({
                    target: "#grid",
                    filter: "td",
                    select: function (e) {
                        var grid = $('#grid').data("kendoGrid");
                        var filaseleccionada = grid.dataItem($('.k-grid').find("tr.k-state-selected"));

                        if (e.item.id == "NuevoItemCode") {
                            VentanaModal(1);
                            return;
                        }
                        if (e.item.id == "NuevaColada") {
                            VentanaModal(3);
                            return;
                        };

                        if (typeof (filaseleccionada) != undefined) {
                            var valor = filaseleccionada.BultoID;
                            var ItemCode = filaseleccionada.ItemCode;



                            if (e.item.id == "Incidencia") {
                                if (!(ItemCode.indexOf("Bulto") != -1)) {
                                    window.open(_incidenciasURL + "?leng=" + $("#language").data("kendoDropDownList").value() + "&LevantarIncidencia=1&ReferenciaID=" + (ItemCode ? ItemCode : "-1") + "&TipoIncidencia=7&Clasificacion=1");
                                } else {
                                    displayMessage("notificationslabel0076", "", '1');
                                };
                                return;
                            }
                            //Si se trata del detalle de un bulto,
                            //no se puede generar otro bulto
                            if (_bultoID != "-1") {
                                if (!valor) {
                                    displayMessage("notificationslabel0043", "", '1');
                                    return;
                                }
                            } else {
                                if (ItemCode.indexOf("Bulto") != -1) {
                                    if (valor) {
                                        var url = "@Url.Action("Cuantificacion", "Cuantificacion")";
                                        window.location.href = url + "?leng=" + $("#language").data("kendoDropDownList").value() + "&DetalleBulto=1&FolioAvisoEntradaID=" + FolioAvisoEntrada.FolioAvisoEntradaID + "&FolioCuantificacionID=" + Cuantificacion.FolioCuantificacionID + "&BultoID=" + valor;
                                    } else {
                                        displayMessage("notificationslabel0040", "", '1');
                                    }
                                } else {
                                    displayMessage("notificationslabel0042", "", '1');
                                }
                            }
                        }
                    }
                });
            
            $("#grid").on("mousedown", "tr[role='row']", function (e) {
                $('#grid').data("kendoGrid").select(e.target.parentElement);
                $("#grid thead .k-state-selected> .k-link").css({
                    "color": "black"
                });

                if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Item Code"] != 'undefined') && (typeof returnOfSecurityCheck["Item Code"]["detail"] != 'undefined') && !returnOfSecurityCheck["Item Code"]["detail"]) {
                    $("#menu").empty();
                    e.preventDefault();
                }
                if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Item Code"] != 'undefined') && (typeof returnOfSecurityCheck["Item Code"]["create"] != 'undefined') && !returnOfSecurityCheck["Item Code"]["create"]) {
                    $("#NuevoItemCode").empty();
                }
                if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Colada"] != 'undefined') && (typeof returnOfSecurityCheck["Colada"]["create"] != 'undefined') && !returnOfSecurityCheck["Colada"]["create"]) {
                    $("#NuevaColada").empty();
                }
                if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Bulto"] != 'undefined') && (typeof returnOfSecurityCheck["Bulto"]["create"] != 'undefined') && !returnOfSecurityCheck["Bulto"]["create"]) {
                    $("#Detallar").empty();
                }
            });

            //if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Item Code"] != 'undefined') && (typeof returnOfSecurityCheck["Item Code"]["create"] != 'undefined') && !returnOfSecurityCheck["Item Code"]["create"]) {
                //$(".k-grid-add").addClass("k-state-disabled");
            //}
        };

        function CancelarInformacionItem(e) {
            e.preventDefault();
            if ((typeof returnOfSecurityCheck != 'undefined') && (typeof returnOfSecurityCheck["Item Code"] != 'undefined') && (typeof returnOfSecurityCheck["Item Code"]["detail"] != 'undefined') && returnOfSecurityCheck["Item Code"]["destroy"]) {
                loadingStart();
                var dataItem = $("#grid").data("kendoGrid").dataItem($(e.currentTarget).closest("tr"));
                var ItemCode = dataItem.ItemCode ? dataItem.ItemCode : "";
                var bultoID = dataItem.BultoID ? dataItem.BultoID : "-1";
                var folioAvisoLlegadaID = FolioAvisoEntrada.FolioAvisoEntradaID;
                var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";
                var validarBulto = "-1";

                if (folioCuantificacionID == "-1" || !ItemCode ) {
                    var grid = $("#grid").data("kendoGrid");
                    var tr = $(e.currentTarget).closest("tr");
                    grid.removeRow(tr);
                    loadingStop();
                    return;
                } 

                if (_detalleBulto != "-1") {
                    validarBulto = _bultoID
                } else {
                    validarBulto = bultoID
                }

                $ValidarItemCodeNuCuantificacion.ValidarItemCodeNuCuantificacion.read({ folioAvisoLlegadaID: folioAvisoLlegadaID, folioCuantificacionID: folioCuantificacionID, ItemCode: ItemCode, bultoID: validarBulto, detalleBulto: _detalleBulto, token: Cookies.get("token") }).done(function (data) {
                    if (!data) {
                        if (confirm("Estas seguro de cancelar el Item Code?")) {
                            $ValidarItemCodeNuCuantificacion.ValidarItemCodeNuCuantificacion.destroy({}, { folioAvisoLlegadaID: folioAvisoLlegadaID, folioCuantificacionID: folioCuantificacionID, BultoID: validarBulto, ItemCode: ItemCode,detalleBulto: _detalleBulto, token: Cookies.get("token") }).done(function (data) {
                                var grid = $("#grid").data("kendoGrid");
                                var tr = $(e.currentTarget).closest("tr");
                                grid.removeRow(tr);

                                if (_detalleBulto == "-1") {
                                    var datasource = $("#grid").data("kendoGrid").dataSource.data();
                                    if (!datasource.length) {
                                        $("#TipoPackingListID").data("kendoComboBox").enable(true);
                                    }
                                }
                                loadingStop();
                            });
                        } else {
                            loadingStop();
                        };
                    } else {
                        displayMessage("notificationslabel0039", "", '1');
                        loadingStop();
                        e.preventDefault();
                    };
                });
            }
            
        };

        function ObtenerFoliosAvisoLlegada() {
            $FoliosCuantificacion.FoliosCuantificacion.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("FolioAvisoEntradaID", result);
            });
        };

        function ObtenerProyecto(id) {
            $ObtenerDatosFolioAvisoEntrada.ObtenerDatosFolioAvisoEntrada.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox(id, result);
            });
        };

        function obtenerTipoPackingList(id) {
            $TipoPackingList.TipoPackingList.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox(id, result);
            });
        };

        function ObtenerTipoUso() {
            $TipoUso.TipoUso.read({ agregarOpcion: 0, paginaID: Cookies.get("navegacion"), token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("TipoUsoID", result);
            });
        };

        function ObtenerDatosDelFolioAvisoLlegada() {
            $ObtenerDatosFolioAvisoEntrada.ObtenerDatosFolioAvisoEntrada.read({ folioAvisoLlegadaID: FolioAvisoEntrada.FolioAvisoEntradaID, token: Cookies.get("token") }).done(function (result) {
                if (Error(result)) {
                    if (result.Proyecto.length == 0) {
                        ObtenerProyecto("ProyectoID");
                    } else {
                        ControlErroresObjetosComboBox("ProyectoID", result.Proyecto);
                    };
                    ControlErroresObjetosComboBox("FolioCuantificacionID", result.FolioLlegada);
                } else {
                    limpiarfiltrosFolioAvisoEntrada();
                };
            });
        };

        function VentanaModal(id) {

            var modalTitle = "";
            var content = "";
            var window = $("#window");
            var height = "";
            var mostrarpopup = true;
            switch (id) {
                case 1:
                    modalTitle = "Item Code";
                    content = "@Url.Action("ItemCode", "PopUps")";
                    height = "10%";
                    if (!validarRequeridosFormaCuantificacion()) {
                        mostrarpopup = false;
                        displayMessage("notificationslabel0031", "", '1');
                    } 
                    break;
                case 2:
                    modalTitle = "Item Code Steelgo";
                    content = "@Url.Action("ItemCodeSteelgo", "PopUps")";
                    height = "55%";
                    break;
                case 3:
                        modalTitle = "Colada";
                        content = "@Url.Action("Colada", "PopUps")";
                        height = "30%";
                    if (!validarRequeridosFormaColadaCuantificacion()) {
                        mostrarpopup = false;
                        displayMessage("notificationslabel0031", "", '1');
                    };
                    break;
            };

            if(mostrarpopup){
                window.kendoWindow({
                    actions: false,
                    content: content,
                    modal: true,
                    title: modalTitle,
                    resizable: true,
                    actions: ["Close"],
                    visible: false,
                    width: "32.6%",
                    minWidth: 660,
                    height: height,
                    iframe: true,
                    position: {
                        top: "10%",
                        left: "20%"
                    }
                }).data("kendoWindow");

                //Se actualiza el tamaño
                $("#window").data("kendoWindow").setOptions({
                    width: "32.6%",
                    height: height,
                });

                window.data("kendoWindow").title(modalTitle);
                window.data("kendoWindow").center().open();
            }
        };

        function DeshabilitarControlesDetalleBulto() {
            $("#FolioAvisoEntradaID").data("kendoComboBox").enable(false);
            $("#ProyectoID").data("kendoComboBox").enable(false);
            $("#FolioCuantificacionID").data("kendoComboBox").enable(false);
            $("#BultoID").attr("disabled", "disabled");
            $("#PackingList").attr("disabled", "disabled");
            $("#TipoPackingListID").data("kendoComboBox").enable(false);
            $("#TipoUsoID").data("kendoComboBox").enable(false);
        };
        
        function DetalleBultoObtenerDatosDelFolioAvisoLlegadaCuantificacion(folio, cuantificacion, bulto) {
            $("#guardarBulto").css("display", "block");
            $("#MenuTerminar").css("display", "none");
            $("#MenuGuardarParcial").css("display", "none");
            $("#MenuCerrar").css("display", "none");
            $("#AccionRegresar").css("display", "block");

            DeshabilitarControlesDetalleBulto();
            $("#FolioAvisoEntradaID").data("kendoComboBox").value(folio);
            $("#FolioCuantificacionID").data("kendoComboBox").text(cuantificacion);
            CargarFolioCuantificacion(cuantificacion);
            CargarFolioAvisoEntrada(folio, folio);
            ObtenerDatosDelFolioAvisoLlegada();

            //Obtener la informacion del folio cuantificacion y aviso entrada
            ObtenerDatosDelFolioAvisoLlegadaCuantificacion(folio, cuantificacion);

        };

        function ObtenerTipoUsoPorProyecto(folio, proyecto)
        {
            $ObtenerDatosFolioAvisoEntrada.ObtenerDatosFolioAvisoEntrada.read({ folioAvisoLlegadaID: folio, proyectoID: proyecto, token: Cookies.get("token") }).done(function (result) {
                if (Error(result)) {
                    $("#TipoUsoID").data("kendoComboBox").value(result.id);
                    CargarTipoUso(result.id, $("#TipoUsoID").data("kendoComboBox").text());
                } else {
                    limpiarfiltrosFolioAvisoEntrada();
                };
            });
        }

        function ObtenerDatosDelFolioAvisoLlegadaCuantificacion(folio, cuantificacion) {
            loadingStart();
            $ObtenerDatosFolioLlegadaMaterial.ObtenerDatosFolioLlegadaMaterial.read({ folioAvisoLlegadaID: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacion: cuantificacion, detalleBulto: _detalleBulto==0?"-1":_detalleBulto, token: Cookies.get("token") }).done(function (result) {
                if (Error(result)) {
                    _folioCuantificacion = cuantificacion;
                    $("#ProyectoID").data("kendoComboBox").value(result.ProyectoID);
                    $("#BultoID").val(_bultoID == -1 ? 0 : _bultoID);
                    $("#PackingList").val(result.PackingList);
                    $("#TipoPackingListID").data("kendoComboBox").value(result.TipoPackingList.id);
                    $("#TipoPackingListID").data("kendoComboBox").enable(false);
                    $("#TipoUsoID").data("kendoComboBox").value(result.TipoUso.id);
                    CargarLabelEstatus(result.Estatus);
                    CargarProyecto(result.ProyectoID, $("#ProyectoID").data("kendoComboBox").text());
                    CargarTipoPackingList(result.TipoPackingList.id, $("#TipoPackingListID").data("kendoComboBox").text());
                    CargarTipoUso($("#TipoUsoID").data("kendoComboBox").value(), $("#TipoUsoID").data("kendoComboBox").text());
                    cargarGridPackingList();

                } else {
                    limpiarfiltrosFolioCuantificacion();
                    loadingStop();
                };
            });
        }
        
        function CargarLabelEstatus(status) {
            ocultarStatus();
            cargarTituloFolio();
            if (status == "En Proceso de Recepción") {
                $("#Cuantificacion0076").show();
            }

            if (status == "Terminado") {
                $("#Cuantificacion0077").show();
            }

            if (status == "Cerrado") {
                $("#Cuantificacion0078").show();
            }

            if (status == "Recepción Terminada") {
                $("#Cuantificacion0086").show();
            }
        };

        function ActualizarPaginaPadre() {
            //ObtenerColada("Colada", 0, 0);
        };

        function ObtenerColada(id, opciones, mostrarOpcion) {
            if (Proyecto.ProyectoID){
                $Colada.Colada.read({ proyectoID: Proyecto.ProyectoID, token: Cookies.get("token"),paginaID: Cookies.get("navegacion"), idioma: $("#language").data("kendoDropDownList").value(), id: opciones, mostrarOpcion: mostrarOpcion }).done(function (result) {
                    ControlErroresObjetosComboBox(id, result);
                });
            } else {
                $("#Colada").data("kendoComboBox").value("");
                $("#Colada").data("kendoComboBox").dataSource.data([]);
            }
        };

        function ObtenerFamiliaItemCode() {
            $Familia.Familia.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("Familia_ItemCode", result);
            });
        };

        function ObtenerFamiliaItemCodeSteelgo() {
            $Familia.Familia.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("Familia_ItemCodeSteelgo", result);
            });
        };

        function changeValueColumnColada(value) {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                if ($('input:checked').val() == "2") {
                    if(!this.get("Colada")){
                        this.set("Colada", value);
                    }
                }else{
                    this.set("Colada", value);
                }
            });
        };

        function changeValueColumnCantidad(value) {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                if ($('input:checked').val() == "2") {
                    if (!this.get("Cantidad")) {
                        this.set("Cantidad", value);
                    }
                }else{
                    this.set("Cantidad", value);
                }
            });
        };

        function changeValueColumnMMPackingList() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                    this.set("MM", "");
            });
        };
        function changeValueColumnMM(value) {
            //var allData = $("#grid").data("kendoGrid").dataSource.data();
            //var query = new kendo.data.Query(allData);
            //var result = query.data;
            //var datasource = result;
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                if ($('input:checked').val() == "2") {
                    if (!this.get("MM")) {
                        if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                            this.set("MM", value);
                        } else {
                            this.set("MM", "N/A");
                        }
                    }
                }else{
                    if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                        this.set("MM", value);
                    } else {
                        this.set("MM", "N/A");
                    }
                }
            });
        };

        function changeValueColumnMMNoAplica() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("MM", "N/A");
            });
            
        }

        function changeValueColumnsAll() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("Colada", $("#Colada").data("kendoAutoComplete").value());
                this.set("Cantidad", $("#Cantidad").val());
                if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                    this.set("MM", $("#MM").val());
                } else {
                    this.set("MM", "N/A");
                }
            });
        }

        function changeValueColumnsClear() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("Colada", "");
                this.set("Cantidad", "");
                if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                    this.set("MM", "");
                } else {
                    this.set("MM", "N/A");
                }
            });
        }

        function limpiarfiltrosFolioAvisoEntrada() {
            $("#ProyectoID").data("kendoComboBox").dataSource.data([]);
            $("#ProyectoID").data("kendoComboBox").value("");
            $("#FolioCuantificacionID").data("kendoComboBox").dataSource.data([]);
            $("#FolioCuantificacionID").data("kendoComboBox").value("");
            $("#BultoID").val("");
            $("#PackingList").val("");
            //$("#TipoPackingListID").data("kendoComboBox").value("");
            $("#TipoUsoID").data("kendoComboBox").value("");
            $("#grid").data("kendoGrid").dataSource.data([]);
            _folioCuantificacion = "-1";
            _folioAvisoEntradaID = "-1";
            Cuantificacion = {};
            Proyecto = {};
            //TipoPackingList = {};
            TipoUso = {};
            limpiarTituloFolio();
        }
        function LimpiarColada() {
            $("#Colada").data("kendoComboBox").dataSource.data([]);
        }

        function ControlErroresObjetosComboBox(control, result) {
            if (Error(result)) {
                $("#" + control).data("kendoComboBox").dataSource.data(result);
            } else {
                $("#" + control).data("kendoComboBox").dataSource.data([]);
            };
        };

        function limpiarfiltrosFolioCuantificacion() {
            Proyecto = {};
            //TipoPackingList = {};
            TipoUso = {};
            _folioCuantificacion = "-1";
            $("#ProyectoID").data("kendoComboBox").value("");
            $("#BultoID").val("");
            $("#PackingList").val("");
            //$("#TipoPackingListID").data("kendoComboBox").value("");
            $("#TipoUsoID").data("kendoComboBox").value("");
            $("#grid").data("kendoGrid").dataSource.data([]);
            limpiarTituloFolio();
        }

        function limpiarfiltrosFolioLlegada() {
            Proyecto = {};
            //TipoPackingList = {};
            TipoUso = {};
            _folioCuantificacion = "-1";
            $("#ProyectoID").data("kendoComboBox").value("");
            $("#BultoID").val("");
            $("#PackingList").val("");
            //$("#TipoPackingListID").data("kendoComboBox").value("");
            //$("#TipoUsoID").data("kendoComboBox").value("");
            $("#grid").data("kendoGrid").dataSource.data([]);
            limpiarTituloFolio();
        }
        
        function cargarTituloFolio() {
            $("#divFolio").removeClass("hidden");
            $("#spanFolio").html(_folioCuantificacion);
        };

        function limpiarTituloFolio() {
            $("#divFolio").addClass("hidden");
            $("#spanFolio").html("");
        }

        function Incidencias() {
            window.open(_incidenciasURL + "?leng=" + $("#language").data("kendoDropDownList").value() + "&LevantarIncidencia=1&ReferenciaID=" + _folioCuantificacion + "&TipoIncidencia=4&Clasificacion=1");
        };

        function GuardaryTerminar() {
            loadingStart();
            var j = 0, z = 0, cerrar = true, incompletos = false;
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.data;
            var datasource = result;
            var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

            ListadoCuantificacionIncompletos = [];
            ListadoCuantificacion = [];

            CargarDefaults();
            //ItemsSumarDuplicados();

            for (var i = 0; i < datasource.length; i++) {
                var ItemCode = datasource[i].ItemCode;
                var BultoID = datasource[i].BultoID;
                var Descripcion = datasource[i].Descripcion;
                var D1 = datasource[i].D1;
                var D2 = datasource[i].D2;
                var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
                var Familia = datasource[i].Familia;
                var Cedula = datasource[i].Cedula;
                var TipoAcero = datasource[i].TipoAcero;
                var Colada = datasource[i].Colada;
                var Cantidad = datasource[i].Cantidad;
                var MM = datasource[i].MM == "N/A" ? 0 : !datasource[i].MM ? 0 : datasource[i].MM;
                var Detallar = datasource[i].Detallar;
                var TieneNU = datasource[i].TieneNU;
                var TieneError = datasource[i].TieneError;
                var TipoUsoID = TipoUso.TipoUsoID;

                if (_detalleBulto != "-1") {
                    BultoID = _bultoID;
                };

                if (ItemCode.indexOf("Bulto") == -1) {
                    //if (!ItemCode || (!D1 && D1 < 0) || (!D2 && D2 < 0) || !ItemCodeSteelgo || !Colada || !Familia || !Descripcion || !Cedula || !Cantidad) { // informacion incompleta
                    if (!ItemCode || !Cantidad) {
                        if (ItemCode) {
                            datasource[i].TieneError = true;
                            ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true, TipoUsoID: TipoUsoID };
                            z++;
                        }
                    } else { // informacion completa
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                        j++;
                    }
                } else {
                    ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                    j++;
                }
            };


            if (!ListadoCuantificacion.length && ListadoCuantificacionIncompletos.length) {
                llenarGrid(null, ListadoCuantificacionIncompletos);
                ordenamientoGrid();
                loadingStop();
                return;
            }

            if (!ListadoCuantificacion.length && !ListadoCuantificacionIncompletos.length) {
                displayMessage("notificationslabel0046", '', '1');
                loadingStop();
                return;
            }
            var ArrayCuantificacion = ArregloFolioCuantificacion(folioAvisoEntradaID, folioCuantificacionID);

            if (ListadoCuantificacionIncompletos.length) {
                incompletos = true;
                cerrar = false;
            }

            var i = 0, error = "";
            if (folioCuantificacionID != -1) {
                $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data.FolioCuantificacionID;
                    if (Error(data)) {
                        $("#grid").data("kendoGrid").dataSource.data([]);
                        llenarGrid(null, ListadoCuantificacionIncompletos);
                            $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 4 }).done(function (data) {
                                error = ErrorInsertandoItems(data,error, ListadoCuantificacion[i]);
                                if (ErrorBool(data)) {
                                    AccionesGuardaryTerminar(data);
                                } else {
                                    cargarGridErrores(ListadoCuantificacion[i]);
                                }
                                i++;
                                CicloGuardaryTerminar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i,error);
                            });
                    } else {
                        loadingStop();
                    }
                });
            } else {
                $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    if (Error(data)) {
                        _folioCuantificacion = data.FolioCuantificacionID;
                        $("#grid").data("kendoGrid").dataSource.data([]);
                        llenarGrid(null, ListadoCuantificacionIncompletos);
                        $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 4 }).done(function (data) {
                            error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                            if (ErrorBool(data)) {
                                AccionesGuardaryTerminar(data);
                            } else {
                                cargarGridErrores(ListadoCuantificacion[i]);
                            }
                            i++;
                            CicloGuardaryTerminar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
                        });
                    } else {
                        loadingStop();
                    }
                });
            };
        };

        function CicloGuardaryTerminar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i,error) {
            if (ListadoCuantificacion[i]) {
                $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 4 }).done(function (data) {
                    error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                    if (ErrorBool(data)) {
                        AccionesGuardaryTerminar(data);
                    } else {
                        cargarGridErrores(ListadoCuantificacion[i]);
                    };
                    i++;
                    CicloGuardaryTerminar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
                });
            } else {
                loadingStop();
                ordenamientoGrid();
                if (error) {
                    displayMessage("notificationslabel0081", error, '2');
                    CambiarEstatusNoCompleto();
                    return;
                }
                
                if (incompletos) {
                    displayMessage("notificationslabel0037", "", '1');
                    CambiarEstatusNoCompleto();
                    return;
                }
                AccionesGuardaryTerminar(null);
                ocultarStatus();
                cargarTituloFolio();
                $("#Cuantificacion0077").show();
                applySecurityPolicy(false);
            };
        };

        function AccionesGuardaryTerminar(data) {
            cargarGridcompletos(data);
            ordenamientoGrid();
            BotonAlta();
            $("#FolioCuantificacionID").data("kendoComboBox").value(_folioCuantificacion);
            CargarFolioCuantificacion(_folioCuantificacion);
            ObtenerDatosDelFolioAvisoLlegada();
        };

        function TerminaryNuevo() {
            loadingStart();
            //var filters = $("#grid").data("kendoGrid").dataSource.filter();
            //var allData = $("#grid").data("kendoGrid").dataSource.data();
            //var query = new kendo.data.Query(allData);
            //var result = query.filter(filters).data;
            //var datasource = result;

            var j = 0, z = 0, cerrar=true, incompletos=false;
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.data;
            var datasource = result;
            var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

            ListadoCuantificacionIncompletos = [];
            ListadoCuantificacion = [];

            CargarDefaults();
            //ItemsSumarDuplicados();

            for (var i = 0; i < datasource.length; i++) {
                var ItemCode = datasource[i].ItemCode;
                var BultoID = datasource[i].BultoID;
                var Descripcion = datasource[i].Descripcion;
                var D1 = datasource[i].D1;
                var D2 = datasource[i].D2;
                var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
                var Familia = datasource[i].Familia;
                var Cedula = datasource[i].Cedula;
                var TipoAcero = datasource[i].TipoAcero;
                var Colada = datasource[i].Colada;
                var Cantidad = datasource[i].Cantidad;
                var MM = datasource[i].MM == "N/A" ? 0 : !datasource[i].MM ? 0 : datasource[i].MM;
                var Detallar = datasource[i].Detallar;
                var TieneNU = datasource[i].TieneNU;
                var TieneError = datasource[i].TieneError;
                var TipoUsoID = TipoUso.TipoUsoID;

                if (_detalleBulto != "-1") {
                    BultoID = _bultoID;
                };


                if (ItemCode.indexOf("Bulto") == -1) {
                    //if (!ItemCode || (!D1 && D1 < 0) || (!D2 && D2 < 0) || !ItemCodeSteelgo || !Colada || !Familia || !Descripcion || !Cedula || !Cantidad) { // informacion incompleta
                    if (!ItemCode || !Cantidad) {
                        if (ItemCode) {
                            datasource[i].TieneError = true;
                            ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true, TipoUsoID: TipoUsoID };
                            z++;
                        }
                    } else { // informacion completa
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                        j++;
                    }
                } else {
                    if (BultoID) {
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                        j++;
                    } else {
                        datasource[i].TieneError = true;
                        ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true, TipoUsoID: TipoUsoID };
                        z++;
                    }
                }
            };


            if (!ListadoCuantificacion.length && ListadoCuantificacionIncompletos.length) {
                llenarGrid(null, ListadoCuantificacionIncompletos);
                ordenamientoGrid();
                loadingStop();
                return;
            }

            if (!ListadoCuantificacion.length && !ListadoCuantificacionIncompletos.length) {
                displayMessage("notificationslabel0046", '', '1');
                loadingStop();
                return;
            }
            var ArrayCuantificacion = ArregloFolioCuantificacion(folioAvisoEntradaID, folioCuantificacionID);

            if (ListadoCuantificacionIncompletos.length) {
                incompletos = true;
                cerrar = false;
            }

            var i = 0, error = "";
            if (folioCuantificacionID != -1) {
                $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data.FolioCuantificacionID;
                    $("#grid").data("kendoGrid").dataSource.data([]);
                    llenarGrid(null, ListadoCuantificacionIncompletos);

                    $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 1 }).done(function (data) {
                        error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                        if (ErrorBool(data)) {
                            AccionesTerminaryNuevo(data);
                        } else {
                            cargarGridErrores(ListadoCuantificacion[i]);
                        }
                        i++;
                        CicloTerminaryNuevo(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
                    })

                });
            } else {
                $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data.FolioCuantificacionID;
                    $("#grid").data("kendoGrid").dataSource.data([]);
                    llenarGrid(null, ListadoCuantificacionIncompletos);
                    $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 1 }).done(function (data) {
                        error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                        if (ErrorBool(data)) {
                            AccionesTerminaryNuevo(data);
                        } else {
                            cargarGridErrores(ListadoCuantificacion[i]);
                        };
                        i++;
                        CicloTerminaryNuevo(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
                    });
                });
            }
        };


    function CicloTerminaryNuevo(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i,error) {
        if (ListadoCuantificacion[i]) {
            $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 1 }).done(function (data) {
                    error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                    if (ErrorBool(data)) {
                        AccionesTerminaryNuevo(data);
                    } else {
                        cargarGridErrores(ListadoCuantificacion[i]);
                    }
                    i++;
                    CicloTerminaryNuevo(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
            });
        } else {
            loadingStop();
            ordenamientoGrid();
            if (error) {
                displayMessage("notificationslabel0081", error, '2');
                BotonAlta();
                CambiarEstatusNoCompleto();
                applySecurityPolicy(false);
                return;
            }

            if (incompletos) {
                displayMessage("notificationslabel0037", "", '1');
                BotonAlta();
                CambiarEstatusNoCompleto();
                applySecurityPolicy(false);
                return;
            }
           
            var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";
            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
            
            AccionesTerminaryNuevo(null);
            applySecurityPolicy(false);
        }
    };

    function AccionesTerminaryNuevo(data) {
        cargarGridcompletos(data);
        ordenamientoGrid();
        BotonAlta();
        $("#FolioCuantificacionID").data("kendoComboBox").value(_folioCuantificacion);
        CargarFolioCuantificacion(_folioCuantificacion);
        ObtenerDatosDelFolioAvisoLlegada();
    };

    function GuardaryCerrar() {
        loadingStart();
        var j = 0, z = 0, incompletos = false, cerrar = true;
        var allData = $("#grid").data("kendoGrid").dataSource.data();
        var query = new kendo.data.Query(allData);
        var result = query.data;
        var datasource = result;
        var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
        var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";
        //var filters = $("#grid").data("kendoGrid").dataSource.filter();            
        //var query = new kendo.data.Query(allData);
        //var result = query.filter(filters).data;
        //var datasource = result;
        CargarDefaults();
        //ItemsSumarDuplicados();

        ListadoCuantificacionIncompletos = [];
        ListadoCuantificacion = [];

        for (var i = 0; i < datasource.length; i++) {
            var ItemCode = datasource[i].ItemCode;
            var BultoID = datasource[i].BultoID;
            var Descripcion = datasource[i].Descripcion;
            var D1 = datasource[i].D1;
            var D2 = datasource[i].D2;
            var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
            var Familia = datasource[i].Familia;
            var Cedula = datasource[i].Cedula;
            var TipoAcero = datasource[i].TipoAcero;
            var Colada = datasource[i].Colada;
            var Cantidad = datasource[i].Cantidad;
            var MM = datasource[i].MM == "N/A" ? 0 : !datasource[i].MM ? 0 : datasource[i].MM;
            var Detallar = datasource[i].Detallar;
            var TieneNU = datasource[i].TieneNU;
            var TieneError = datasource[i].TieneError;
            var TipoUsoID = TipoUso.TipoUsoID;

            if (_detalleBulto != "-1") {
                BultoID = _bultoID;
            };


            if (ItemCode.indexOf("Bulto") == -1) {
                //if (!ItemCode || (!D1 && D1 != 0) || (!D2 && D2 != 0) || !ItemCodeSteelgo || !Colada || !Familia || !Descripcion || !Cedula || !Cantidad) { // informacion incompleta
                if (!ItemCode || !Cantidad) {
                    if (ItemCode) {
                        datasource[i].TieneError = true;
                        ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true, TipoUsoID: TipoUsoID };
                        z++;
                    }
                } else { // informacion completa
                    ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                    j++;
                }
            } else {
                if (BultoID) {
                    ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                    j++;
                } else {
                    datasource[i].TieneError = true;
                    ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true, TipoUsoID: TipoUsoID };
                    z++;
                }
            }
        };

        var ArrayCuantificacion = ArregloFolioCuantificacion(folioAvisoEntradaID, folioCuantificacionID);


        if (ListadoCuantificacionIncompletos.length) {
            incompletos = true;
            cerrar = false;
        }

        if (!ListadoCuantificacion.length && ListadoCuantificacionIncompletos.length) {
            llenarGrid(null, ListadoCuantificacionIncompletos);
            ordenamientoGrid();
            loadingStop();
            return;
        }

        if (!ListadoCuantificacion.length && !ListadoCuantificacionIncompletos.length) {
            displayMessage("notificationslabel0046", '', '1');
            loadingStop();
            return;
        }
        var i = 0, error = "";
        if (folioCuantificacionID != -1) {
            $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                _folioCuantificacion = data.FolioCuantificacionID;
                $("#grid").data("kendoGrid").dataSource.data([]);
                llenarGrid(null, ListadoCuantificacionIncompletos);

                $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 2 }).done(function (data) {
                    error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                    if (ErrorBool(data)) {
                        AccionesGuardarGuardaryCerrar(data);
                    } else {
                        cargarGridErrores(ListadoCuantificacion[i]);
                    }
                    i++;
                    CicloGuardaryCerrar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
                });

            });
        } else {
            $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                _folioCuantificacion = data.FolioCuantificacionID;
                $("#grid").data("kendoGrid").dataSource.data([]);
                llenarGrid(null, ListadoCuantificacionIncompletos);

                $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 2 }).done(function (data) {
                    error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                    if (ErrorBool(data)) {
                        AccionesGuardarGuardaryCerrar(data);
                    } else {
                        cargarGridErrores(ListadoCuantificacion[i]);
                    }
                    i++;
                    CicloGuardaryCerrar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
                });

            });
        }
    };

    function CicloGuardaryCerrar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error) {
        if (ListadoCuantificacion[i]) {
            $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: 2 }).done(function (data) {
                error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                if (ErrorBool(data)) {
                    AccionesGuardarGuardaryCerrar(data);
                } else {
                    cargarGridErrores(ListadoCuantificacion[i]);
                }
                i++;
                CicloGuardaryCerrar(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, error);
            });
        } else {
            loadingStop();
            ordenamientoGrid();
           
            if (error) {
                displayMessage("notificationslabel0081", error, '2');
                BotonAlta();
                CambiarEstatusNoCompleto();
                applySecurityPolicy(false);
                return;
            }
            if (incompletos) {
                displayMessage("notificationslabel0037", "", '1');
                BotonAlta();
                CambiarEstatusNoCompleto();
                applySecurityPolicy(false);
                return;
            }
            AccionesGuardarGuardaryCerrar(null);
            ocultarStatus();
            cargarTituloFolio();
            $("#Cuantificacion0078").show();
            applySecurityPolicy(false);
        }
    };
    function CambiarEstatusNoCompleto() {
        $FoliosCuantificacion.FoliosCuantificacion.create({}, { folioCuantificacionID: _folioCuantificacion, token: Cookies.get("token") }).done(function (data) {
            Error(data);
        });
    };
        
        function AccionesGuardarGuardaryCerrar(data) {
            cargarGridcompletos(data);
            ordenamientoGrid();
            BotonAlta();
            $("#FolioCuantificacionID").data("kendoComboBox").value(_folioCuantificacion);
            CargarFolioCuantificacion(_folioCuantificacion);
            ObtenerDatosDelFolioAvisoLlegada();
        };


        function GuardarParcial(guardarynuevo, idGuardado) {
            loadingStart();
            var j = 0, z = 0;
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.data;
            var datasource = result;
            var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

            ListadoCuantificacionIncompletos = [];
            ListadoCuantificacion = [];

            CargarDefaults();
            //ItemsSumarDuplicados();

            for (var i = 0; i < datasource.length; i++) {
                var ItemCode = datasource[i].ItemCode;
                var BultoID = datasource[i].BultoID;
                var Descripcion = datasource[i].Descripcion;
                var D1 = datasource[i].D1;
                var D2 = datasource[i].D2;
                var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
                var Familia = datasource[i].Familia;
                var Cedula = datasource[i].Cedula;
                var TipoAcero = datasource[i].TipoAcero;
                var Colada = datasource[i].Colada?datasource[i].Colada:"Sin Colada PL";
                var Cantidad = datasource[i].Cantidad;
                var MM = datasource[i].MM == "N/A" ? 0 : !datasource[i].MM ? 0 : datasource[i].MM;
                var Detallar = datasource[i].Detallar;
                var TieneNU = datasource[i].TieneNU;
                var TieneError = datasource[i].TieneError;
                var TipoUsoID = TipoUso.TipoUsoID;

                if (_detalleBulto != "-1") {
                    BultoID = _bultoID;
                };
                

                if (ItemCode.indexOf("Bulto") == -1) {
                    //if (!ItemCode || (!D1 && D1 < 0) || (!D2 && D2 < 0) || !Colada || !Familia || !Descripcion || !Cedula || !Cantidad) { // informacion incompleta
                    if (!ItemCode) {
                        //datasource[i].TieneError = true;
                        //ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true, TipoUsoID: TipoUsoID };
                        //z++;
                    } else { // informacion completa
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                        j++;
                    }
                } else {
                    ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError, TipoUsoID: TipoUsoID };
                    j++;
                }
            };

            
            if (!ListadoCuantificacion.length && ListadoCuantificacionIncompletos.length) {
                llenarGrid(null, ListadoCuantificacionIncompletos);
                ordenamientoGrid();
                loadingStop();
                return;
            }
            
            if (!ListadoCuantificacion.length && !ListadoCuantificacionIncompletos.length) {
                displayMessage("notificationslabel0046", '', '1');
                loadingStop();
                return;
            } 
            var ArrayCuantificacion = ArregloFolioCuantificacion(folioAvisoEntradaID, folioCuantificacionID);

            if (folioCuantificacionID != -1) {
                EdicionListadoCuantificacionParcial(ArrayCuantificacion, false, false, folioAvisoEntradaID, ListadoCuantificacion, ListadoCuantificacionIncompletos, guardarynuevo, idGuardado);
            } else {
                GuardarListadoCuantificacionParcial(ArrayCuantificacion, false, false, folioAvisoEntradaID, ListadoCuantificacion, ListadoCuantificacionIncompletos, guardarynuevo, idGuardado);
            };
            
        };

        function ErrorInsertandoItems(data, error, Listado) {
            if (data.ReturnCode) {
                if (data.ReturnCode != 200) {
                    if (data.ReturnCode == 401) {
                        removeUserSession();
                        return error;
                    } else {
                        error += "," + Listado.ItemCode;
                        //cargarGridErrores(ListadoCuantificacion);
                        //ordenamientoGrid();
                        //displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                        return error;
                    }
                }
            }
            return error;
        };

        function GuardarListadoCuantificacionParcial(ArrayCuantificacion, cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, ListadoCuantificacionIncompletos, guardarynuevo, idGuardado) {
            var i = 0, error = "";
            $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                _folioCuantificacion = data.FolioCuantificacionID;
                if (Error(data)) {
                        $("#grid").data("kendoGrid").dataSource.data([]);
                        llenarGrid(null, ListadoCuantificacionIncompletos);

                        $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: idGuardado }).done(function (data) {
                            error = ErrorInsertandoItems(data, error, ListadoCuantificacion[i]);
                            if (ErrorBool(data)) {
                                AccionesAltaGuardadoParcial(data);
                            } else {
                                cargarGridErrores(ListadoCuantificacion[i]);
                            };
                            i++;
                            cicloGuardadoParcial(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, idGuardado, guardarynuevo, error);
                        });                    
                } else {
                    loadingStop();
                }
            });
        };

      
        function EdicionListadoCuantificacionParcial(ArrayCuantificacion, cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, ListadoCuantificacionIncompletos, guardarynuevo, idGuardado) {
                var i = 0, error = "";
                $GuardarFolioLlegadaCuantificacion.GuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(ArrayCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data.FolioCuantificacionID;
                    if (Error(data)) {
                        $("#grid").data("kendoGrid").dataSource.data([]);
                        llenarGrid(null, ListadoCuantificacionIncompletos);

                        $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: idGuardado }).done(function (data) {
                            error = ErrorInsertandoItems(data,error, ListadoCuantificacion[i]);
                            if (ErrorBool(data)) {
                                AccionesAltaGuardadoParcial(data);
                            } else {
                                cargarGridErrores(ListadoCuantificacion[i]);
                            };
                            i++;
                            cicloGuardadoParcial(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, idGuardado, guardarynuevo, error);
                        });
                    } else {
                        loadingStop();
                    };
                });
        };

        function cicloGuardadoParcial(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, idGuardado, guardarynuevo,error) {
            if (ListadoCuantificacion[i]) {
                $ListadoCuantificacion.ListadoCuantificacion.create({}, { cerrar: cerrar, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: _folioCuantificacion, cuantificacion: JSON.stringify(ListadoCuantificacion[i]), token: Cookies.get("token"), idGuardado: idGuardado }).done(function (data) {
                        error = ErrorInsertandoItems(data,error, ListadoCuantificacion[i]);
                        if (ErrorBool(data)) {
                            AccionesAltaGuardadoParcial(data);
                        } else {
                            cargarGridErrores(ListadoCuantificacion[i]);
                        };
                        i++;
                        cicloGuardadoParcial(cerrar, incompletos, folioAvisoEntradaID, ListadoCuantificacion, i, idGuardado, guardarynuevo, error);
                });
            } else {
                loadingStop();
                ordenamientoGrid();
                if (error) {
                    displayMessage("notificationslabel0081", error, '2');
                    ordenamientoGrid();
                    CambiarEstatusNoCompleto();
                    return;
                }
                AccionesAltaGuardadoParcial(null);
                applySecurityPolicy(false);
                if (guardarynuevo) {
                    var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";
                    window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
                }
            };
        };
        
        function ArregloFolioCuantificacion(folioAvisoEntradaID, folioCuantificacionID) {
            Cuantificacion = { FolioAvisollegadaId: "", ProyectoID: "", FolioCuantificacionID: "", BultoID: "", PackingList: "", TipoPackingList: "", TipoUso: "" };
            Cuantificacion.FolioAvisollegadaId = FolioAvisoEntrada.FolioAvisoEntradaID;
            Cuantificacion.ProyectoID = Proyecto.ProyectoID;
            Cuantificacion.FolioCuantificacionID = folioCuantificacionID;
            Cuantificacion.BultoID = $("#BultoID").val();
            Cuantificacion.PackingList = $("#PackingList").val();
            Cuantificacion.TipoPackingList = TipoPackingList.TipoPackingListID;
            Cuantificacion.TipoUso = TipoUso.TipoUsoID;
            return Cuantificacion;
        };


        function AccionesEdicionGuardadoParcial(data) {
            cargarGridcompletos(data);
            ordenamientoGrid();
            BotonEdicion();
            ocultarStatus();
            cargarTituloFolio();
            $("#Cuantificacion0076").show();
            displayMessage("notificationslabel0038", '', '0');
            $("#FolioCuantificacionID").data("kendoComboBox").value(_folioCuantificacion);
            CargarFolioCuantificacion(_folioCuantificacion);
            ObtenerDatosDelFolioAvisoLlegada();
        };

        function AccionesAltaGuardadoParcial(data) {
            cargarGridcompletos(data);
            ordenamientoGrid();
            BotonAlta();
            ocultarStatus();
            cargarTituloFolio();
            $("#Cuantificacion0076").show();
            displayMessage("notificationslabel0038", '', '0');
            $("#FolioCuantificacionID").data("kendoComboBox").value(_folioCuantificacion);
            CargarFolioCuantificacion(_folioCuantificacion);
            ObtenerDatosDelFolioAvisoLlegada();
        };

        function cargarGridcompletos(dataJson) {
            if (dataJson) {
                $.each(dataJson, function (key) {
                    var item =
                           { ItemCode: dataJson[key].ItemCode, BultoID: dataJson[key].BultoID, Descripcion: dataJson[key].Descripcion, D1: dataJson[key].D1, D2: dataJson[key].D2, ItemCodeSteelgo: dataJson[key].ItemCodeSteelgo, Familia: dataJson[key].Familia, Cedula: dataJson[key].Cedula, TipoAcero: dataJson[key].TipoAcero, Colada: dataJson[key].Colada, Cantidad: dataJson[key].Cantidad, MM: dataJson[key].MM, Detallar: dataJson[key].Detallar, TieneNU: dataJson[key].TieneNU, TieneError: dataJson[key].TieneError };
                    $("#grid").data("kendoGrid").dataSource.insert(item);
                });
            }
        };
        function cargarGridErrores(incompletos) {
            if (incompletos) {
                var item =
                       { ItemCode: incompletos.ItemCode, BultoID: incompletos.BultoID, Descripcion: incompletos.Descripcion, D1: incompletos.D1, D2: incompletos.D2, ItemCodeSteelgo: incompletos.ItemCodeSteelgo, Familia: incompletos.Familia, Cedula: incompletos.Cedula, TipoAcero: incompletos.TipoAcero, Colada: incompletos.Colada, Cantidad: incompletos.Cantidad, MM: incompletos.MM, Detallar: incompletos.Detallar, TieneNU: incompletos.TieneNU, TieneError: true };
                    $("#grid").data("kendoGrid").dataSource.insert(item);
            }
        };
       
        function llenarGrid(dataJson, incompletos) {
            $("#grid").data("kendoGrid").dataSource.data([]);
            if (dataJson) {
                $.each(dataJson, function (key) {
                    var item =
                           { ItemCode: dataJson[key].ItemCode, BultoID: dataJson[key].BultoID, Descripcion: dataJson[key].Descripcion, D1: dataJson[key].D1, D2: dataJson[key].D2, ItemCodeSteelgo: dataJson[key].ItemCodeSteelgo, Familia: dataJson[key].Familia, Cedula: dataJson[key].Cedula, TipoAcero: dataJson[key].TipoAcero, Colada: dataJson[key].Colada, Cantidad: dataJson[key].Cantidad, MM: dataJson[key].MM, Detallar: dataJson[key].Detallar, TieneNU: dataJson[key].TieneNU, TieneError: dataJson[key].TieneError };
                    $("#grid").data("kendoGrid").dataSource.insert(item);
                });
            };
            if (incompletos) {
                $.each(incompletos, function (key) {
                    var item =
                           { ItemCode: incompletos[key].ItemCode, BultoID: incompletos[key].BultoID, Descripcion: incompletos[key].Descripcion, D1: incompletos[key].D1, D2: incompletos[key].D2, ItemCodeSteelgo: incompletos[key].ItemCodeSteelgo, Familia: incompletos[key].Familia, Cedula: incompletos[key].Cedula, TipoAcero: incompletos[key].TipoAcero, Colada: incompletos[key].Colada, Cantidad: incompletos[key].Cantidad, MM: incompletos[key].MM, Detallar: incompletos[key].Detallar, TieneNU: incompletos[key].TieneNU, TieneError: incompletos[key].TieneError };
                    $("#grid").data("kendoGrid").dataSource.insert(item);
                });
            }
        };

        function ordenamientoGrid() {
            var dsSort = [];
            dsSort.push({ field: "TieneError", dir: "desc" });
            $("#grid").data('kendoGrid').dataSource.sort(dsSort);
            $('#grid').data('kendoGrid').refresh();

            var grid = $("#grid").data("kendoGrid");
            var gridData = grid.dataSource.view();

            for (var i = 0; i < gridData.length; i++) {
                if (gridData[i].TieneError == true) {
                    grid.table.find("tr[data-uid='" + gridData[i].uid + "']").css("background-color", "#FFCCCC");
                }
            }
        };

        function cargarGridPackingList() {
            $CargarGridCuantificacion.CargarGridCuantificacion.read({}, { token: Cookies.get("token"), folioCuantificacion: Cuantificacion.FolioCuantificacionID, bultoID: $("#BultoID").val() }).done(function (result) {
                if (Error(result)) {
                    if ($("#grid").data("kendoGrid")) {
                        if (result.length) {
                            $("#grid").data("kendoGrid").dataSource.data(result);
                            if (TipoPackingList.TipoPackingListID == "2") {
                                changeValueColumnMMNoAplica();
                            }
                        } else {
                            $("#grid").data("kendoGrid").dataSource.data([]);
                        };
                    };
                }
                loadingStop();
            });
        };

        function cargarItemCodeAutocomplete(value) {
            if (value != "Bulto") {
                $ItemCode.ItemCode.read({}, { itemCodeID: value, token: Cookies.get("token") }).done(function (data) {
                    itemCodesJson = data;
                    if (itemCodesJson) {
                        if (itemCodesJson.ItemCode == value) {
                            lastEditedCellID.ItemCode = itemCodesJson.ItemCode;
                            lastEditedCellID.Colada = itemCodesJson.ColadaNombre;
                            //lastEditedCellID.Cantidad = itemCodesJson.Cantidad;
                            lastEditedCellID.MM = TipoPackingList.TipoPackingListID == "2" ? "N/A" : 0; //itemCodesJson.MM;
                            lastEditedCellID.Detallar = "No";
                            lastEditedCellID.Descripcion = itemCodesJson.Descripcion;
                            lastEditedCellID.D1 = itemCodesJson.Diametro1;
                            lastEditedCellID.D2 = itemCodesJson.Diametro2;
                            lastEditedCellID.ItemCodeSteelgo = itemCodesJson.ItemCodeSteelgo;
                            lastEditedCellID.Familia = itemCodesJson.FamiliaAcero;
                            lastEditedCellID.Cedula = itemCodesJson.Cedula;
                            lastEditedCellID.TipoAcero = itemCodesJson.TipoAcero;
                        } else {
                            //lastEditedCellID.ItemCode = itemCodesJson.ItemCode;
                            lastEditedCellID.Colada = "";
                            lastEditedCellID.Cantidad = 0;
                            lastEditedCellID.MM = TipoPackingList.TipoPackingListID == "2" ? "N/A" : 0;//itemCodesJson.MM;
                            lastEditedCellID.Detallar = "No";
                        };
                    }
                    $('#grid').data('kendoGrid').refresh();
                });
            } else {
                lastEditedCellID.ItemCode = "Bulto";
                lastEditedCellID.Descripcion = "";
                lastEditedCellID.D1 = 0;
                lastEditedCellID.D2 = 0;
                lastEditedCellID.ItemCodeSteelgo = "";
                lastEditedCellID.Colada = "";
                lastEditedCellID.MM = "N/A";
                lastEditedCellID.Detallar = "Si";
                lastEditedCellID.Cantidad = 1;
                lastEditedCellID.TieneNU = "No";
                lastEditedCellID.Familia = "";
                lastEditedCellID.Cedula = "";
                lastEditedCellID.TipoAcero = "";
                $('#grid').data('kendoGrid').refresh();
            }
        };

        function cargarItemCodeSteelgoAutocomplete(value) {
                $ItemCodeSteelgo.ItemCodeSteelgo.read({}, { itemID: value, token: Cookies.get("token") }).done(function (data) {
                    itemCodesJsonSteelgo = data;
                    if (itemCodesJsonSteelgo) {
                        if (itemCodesJsonSteelgo.Codigo == value) {
                            lastEditedCellIDSteelgo.ItemCodeSteelgo = itemCodesJsonSteelgo.Codigo;
                            lastEditedCellIDSteelgo.Descripcion = itemCodesJsonSteelgo.DescripcionEspanol
                            lastEditedCellIDSteelgo.D1 = itemCodesJsonSteelgo.Diametro1
                            lastEditedCellIDSteelgo.D2 = itemCodesJsonSteelgo.Diametro2
                            lastEditedCellIDSteelgo.Familia = itemCodesJsonSteelgo.Familia;
                            lastEditedCellIDSteelgo.Cedula = itemCodesJsonSteelgo.Cedula;
                            lastEditedCellIDSteelgo.TipoAcero = itemCodesJsonSteelgo.TipoAcero;
                            lastEditedCellID.Detallar = "No";
                        }
                    }
                    $('#grid').data('kendoGrid').refresh();

                });
        };

        function itemCodeAutocomplete(container, options) {
            $('<input data-text-field="Codigo" data-value-field="ItemCodeID" data-bind="value:' + options.field + '"/>')
                .appendTo(container)
                .kendoAutoComplete({
                    autoBind: false,
                    dataSource: {
                        type: "json",
                        transport: {
                            read: $URLItemCode + "TipoPackingListID=" + TipoPackingList.TipoPackingListID + "&token=" + Cookies.get("token") + "&paginaID=" + Cookies.get("navegacion") + "&idioma=" + $("#language").data("kendoDropDownList").value() + "&proyectoID=" + (Proyecto.ProyectoID?Proyecto.ProyectoID:"-1")
                        }
                    },
                    dataBound: function dataBound(e) {
                        var widget = e.sender;
                        $('body *').removeAttr('unselectable');
                        widget.ul.find("li").removeAttr("unselectable");
                    },
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        if (dataItem.ItemCodeID == -1) {
                            VentanaModal(1);
                            e.preventDefault();
                            lastEditedCellID.ItemCode = "";
                            $('#grid').data('kendoGrid').refresh();
                        }
                    },
                    change: function (e) {
                        var value = this.value();
                        console.log("cel");
                        console.log(e.sender.current());
                        if (!e.sender.current()) {
                            lastEditedCellID.ItemCode = "";
                            lastEditedCellID.Descripcion = "";
                            lastEditedCellID.D1 = 0;
                            lastEditedCellID.D2 = 0;
                            lastEditedCellID.ItemCodeSteelgo = "";
                            lastEditedCellID.Colada = "";
                            lastEditedCellID.MM = "";
                            lastEditedCellID.Detallar = "No";
                            lastEditedCellID.Cantidad = 0;
                            lastEditedCellID.TieneNU = "No";
                            lastEditedCellID.Familia = "";
                            lastEditedCellID.Cedula = "";
                            lastEditedCellID.TipoAcero = "";
                            $('#grid').data('kendoGrid').refresh();
                        } else {
                            if (_detalleBulto != "-1" && value == "Bulto") {
                                lastEditedCellID.ItemCode = "Bulto";
                                lastEditedCellID.Descripcion = "";
                                lastEditedCellID.D1 = 0;
                                lastEditedCellID.D2 = 0;
                                lastEditedCellID.ItemCodeSteelgo = "";
                                lastEditedCellID.Colada = "";
                                lastEditedCellID.MM = "N/A";
                                lastEditedCellID.Detallar = "Si";
                                lastEditedCellID.Cantidad = 1;
                                lastEditedCellID.TieneNU = "No";
                                lastEditedCellID.Familia = "";
                                lastEditedCellID.Cedula = "";
                                lastEditedCellID.TipoAcero = "";
                                displayMessage("notificationslabel0043", "", '1');
                            }
                            else {
                                cargarItemCodeAutocomplete(value);
                            }
                        };
                    }
                });
            lastEditedCellID = options.model;
        };


        function itemCodeSteelgoAutocomplete(container, options) {
            $('<input data-text-field="value" data-value-field="id" data-bind="value:' + options.field + '"/>')
                .appendTo(container)
                .kendoAutoComplete({
                    autoBind: false,
                    dataSource: {
                        type: "json",
                        transport: {
                            read: $URLItemCodeSteelgo + "&ItemCode=" + container.parent().children()[0].firstChild.data + "&token=" + Cookies.get("token")
                        },
                    },
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        if (dataItem.id == 0) {
                            VentanaModal(2);
                            e.preventDefault();
                            lastEditedCellIDSteelgo.ItemCodeSteelgo = "";
                            $('#grid').data('kendoGrid').refresh();
                        }
                    },
                    change: function (e) {
                        var value = this.value();
                        if (!e.sender.current()) {
                            lastEditedCellIDSteelgo.ItemCodeSteelgo = "";
                            lastEditedCellIDSteelgo.Descripcion = "";
                            lastEditedCellIDSteelgo.D1 = "";
                            lastEditedCellIDSteelgo.D2 = "";
                            lastEditedCellIDSteelgo.Familia ="";
                            lastEditedCellIDSteelgo.Cedula = "";
                            lastEditedCellIDSteelgo.TipoAcero = "";
                            lastEditedCellID.Detallar = "No";
                            $('#grid').data('kendoGrid').refresh();
                        } else {
                            cargarItemCodeSteelgoAutocomplete(value);
                        };
                      
                    }
                });
            lastEditedCellIDSteelgo = options.model;
        };

        //function cargarColadaAutocomplete() {
        //    var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
        //    Client.add('DummyTipoAcero');

        //    Client.DummyTipoAcero.read({}, {  familiaAcero:"", proyectoid: "",token: Cookies.get("token") }).done(function (data) {
        //        console.log("DummyTipoAcero="+ data);
        //        tipoAceroJson = data;
        //    });
        //};
        
        function ColadaAutocomplete(container, options) {
            $('<input data-text-field="Nombre" data-value-field="ColadaID" data-bind="value:' + options.field + '"/>')
                .appendTo(container)
                .kendoComboBox({
                    autoBind: false,
                    dataSource: {
                        type: "json",
                        serverFiltering: true,
                        transport: {
                            read: $URLColada + "itemcode=" + (container.parent().children()[0].firstChild?container.parent().children()[0].firstChild.data:"") + "&token=" + Cookies.get("token") + "&paginaID=" + Cookies.get("navegacion") + "&idioma=" + $("#language").data("kendoDropDownList").value() + "&id=0&mostrarOpcion=0"
                            }
                    },
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        if (dataItem.ColadaID == 0) {
                            VentanaModal(3);
                            e.preventDefault();
                        }
                    },
                    change: function (e) {
                        var value = this.text();
                        if (this.selectedIndex == -1) {
                            lastEditedCellIDSColada.Colada = "";
                        } else {
                            lastEditedCellIDSColada.Colada = value;
                        }
                        $('#grid').data('kendoGrid').refresh();
                    },
                    filter: "contains",
                });

            lastEditedCellIDSColada = options.model;
        };
        
        function ObtenerItemCodeSteelgo(dataJson, key, error) {
            if (dataJson[key]) {
                $ItemCodeSteelgo.ItemCodeSteelgo.read({}, { itemID: dataJson[key].ItemCode, itemsteelgo: "", token: Cookies.get("token") }).done(function (data) {
                    itemCodesJsonSteelgo = data;
                    if (data) {
                        error = ErrorInsertandoItems(data, error, dataJson[key]);
                        if (ErrorBool(data)) {
                            var item =
                                                   { ItemCode: dataJson[key].ItemCode, Descripcion: itemCodesJsonSteelgo.DescripcionEspanol, D1: itemCodesJsonSteelgo.Diametro1, D2: itemCodesJsonSteelgo.Diametro2, ItemCodeSteelgo: itemCodesJsonSteelgo.Codigo, Familia: itemCodesJsonSteelgo.Familia, Cedula: itemCodesJsonSteelgo.Cedula, TipoAcero: itemCodesJsonSteelgo.TipoAcero, Colada: itemCodesJsonSteelgo.ColadaNombre, Cantidad: dataJson[key].Cantidad, MM: "", Detallar: "No", TieneNU: "No", TieneError: false };
                            $("#grid").data("kendoGrid").dataSource.insert(item);
                        } else {
                            cargarGridErrores(dataJson[key]);
                        }
                    } else {
                        error += "," + dataJson[key].ItemCode;
                        cargarGridErrores(dataJson[key]);
                    };
                   
                    key++;
                    ObtenerItemCodeSteelgo(dataJson, key, error);
                });
            } else {
                loadingStop();
                ordenamientoGrid();
                if (error) {
                    displayMessage("notificationslabel0047", error, '2');
                    return;
                }
            };
        };

        function ObtenerItemCodeSteelgoDuplicados(dataJson, key, error,guardarynuevo, idGuardado) {
            if (dataJson[key]) {
                $ItemCodeSteelgo.ItemCodeSteelgo.read({}, { itemID: dataJson[key].ItemCode, itemsteelgo: "", token: Cookies.get("token") }).done(function (data) {
                    itemCodesJsonSteelgo = data;
                    if (data) {
                        error = ErrorInsertandoItems(data, error, dataJson[key]);
                        if (ErrorBool(data)) {
                            var item =
                                                   { ItemCode: dataJson[key].ItemCode, Descripcion: itemCodesJsonSteelgo.DescripcionEspanol, D1: itemCodesJsonSteelgo.Diametro1, D2: itemCodesJsonSteelgo.Diametro2, ItemCodeSteelgo: itemCodesJsonSteelgo.Codigo, Familia: itemCodesJsonSteelgo.Familia, Cedula: itemCodesJsonSteelgo.Cedula, TipoAcero: itemCodesJsonSteelgo.TipoAcero, Colada: itemCodesJsonSteelgo.ColadaNombre, Cantidad: dataJson[key].Cantidad, MM: "", Detallar: "No", TieneNU: "No", TieneError: false };
                            $("#grid").data("kendoGrid").dataSource.insert(item);
                        } else {
                            cargarGridErrores(dataJson[key]);
                        }
                    } else {
                        error += "," + dataJson[key].ItemCode;
                        cargarGridErrores(dataJson[key]);
                    };

                    key++;
                    ObtenerItemCodeSteelgoDuplicados(dataJson, key, error, guardarynuevo, idGuardado);
                });
            } else {
                loadingStop();
                ordenamientoGrid();
                GuardarParcial(guardarynuevo, idGuardado);

                if (error) {
                    displayMessage("notificationslabel0047", error, '2');
                    return;
                }
            };
        };
        function CancelarPadre() { };
        function browserSupportFileUpload() {
            var isCompatible = false;
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                isCompatible = true;
            }
            return isCompatible;
        };

        function upload(evt) {
            if (!(/\.(csv)$/i).test(evt.target.files[0].name)) {
                displayMessage("notificationslabel0018", "", '1');
                event.preventDefault();
            } else {
                if (!browserSupportFileUpload()) {
                    displayMessage("notificationslabel0019", "", '1');
                } else {
                    var dataJson = null;
                    var file = evt.target.files[0];
                    var reader = new FileReader();
                    reader.readAsText(file);

                    reader.onload = function (event) {
                        var csvData = event.target.result;
                        dataJson = $.parseJSON(csvJSON(csvData));

                        if (dataJson && dataJson.length > 0) {
                            //$.each(dataJson, function (key) {
                            var i = 0, error = "";
                            loadingStart();
                                ObtenerItemCodeSteelgo(dataJson, i, error);
                                //var item =
                                //       { ItemCode: dataJson[key].ItemCode, Descripcion: dataJson[key].Descripcion, D1: dataJson[key].D1, D2: dataJson[key].D2, ItemCodeSteelgo: dataJson[key].ItemCodeSteelgo, Familia: dataJson[key].Familia, Cedula: dataJson[key].Cedula, TipoAcero: dataJson[key].TipoAcero, Colada: dataJson[key].Colada, Cantidad: dataJson[key].Cantidad, MM: dataJson[key].MM, Detallar: "No", TieneNU: "No", TieneError: false };
                                //$("#grid").data("kendoGrid").dataSource.insert(item);
                            //});
                            document.getElementById('txtFileUpload').addEventListener('change', upload, false);
                        } else {
                            displayMessage("notificationslabel0020", "", '1');
                        }
                    };
                    reader.onerror = function () {
                        displayMessage("notificationslabel0021", file.fileName, '1');
                    };
                }
            }
        };
        //funciones para controlar los eventos
        //13 enter
        //17 control
        //37 left arrow
        //38 up arrow
        //39 right arrow
        //40 down arrow
        function keydown(e) {
            /*
            if (e.keyCode == 13 || e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40) {
                var elementFocused = $(':focus');
                var focused = $(':focus').attr("id");
                var mapeo = "";
                if (typeof (focused) === 'undefined') {
                    focused = focusResp;
                }
                mapeo = mapeoNavegacion[focused][e.keyCode];
            }

            switch (e.keyCode) {
                case ctrlKey:
                    ctrlDown = true;
                    break;
                case 37: case 38: case 39: case 40:
                    if (ctrlDown) {
                        switch (mapeoTiposControles[mapeo]) {
                            case 0:
                                $("#" + mapeo).focus();
                                break;
                            case 1:
                                break;
                            case 2:
                                $("#" + mapeo).data("kendoComboBox").input.focus();
                                focusResp = mapeo;
                                break;
                            case 3:
                                break;
                            case 4:
                                $(".k-grid-add").focus();
                                focusResp = mapeo;
                                break;
                        }
                    }
                    break;
            }
            //if (e.keyCode == ctrlKey) ctrlDown = true;
            */
        }

        function ActualizarCookie() {
            Cookies.set("navegacion", $("#hdnNavegacion").val(), { path: '/' });
        };
        
        function ErrorBool(data) {
            if (data.ReturnCode) {
                if (data.ReturnCode != 200) {
                    if (data.ReturnCode == 401) {
                        removeUserSession();
                        return true;
                    } else {
                        //displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                        return false;
                    }
                } else {
                    return true;
                }
            } else {
                return true;
            }
        };

        function Error(data) {
            if(data)
            {
                if (data.ReturnCode) {
                    if (data.ReturnCode != 200) {
                        if (data.ReturnCode == 401) {
                            removeUserSession();
                            return true;
                        } else {
                            displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                            return false;
                        }
                    } else {
                        return true;
                    }
                } else {
                    return true;
                }
            } else {
                return false;
            }
        };


        }

        function imprimirEtiquetas() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;
            var _tieneNU = false;
            var strItemCodes = "";
            var x = 0;
            for (i = 0; i < datasource.length; i++) {
                if (datasource[i].TieneNU) {
                    _tieneNU = true;
                    if (x == 0) {
                        strItemCodes = datasource[i].ItemCode;
                    } else {
                        strItemCodes += "," + datasource[i].ItemCode;
                    }
                    x++;
                };
       
            };

            if (_tieneNU) {
                Cookies.set("ItemCodes", strItemCodes, {path: '/'});
                window.open("@Url.Action("FormatoEtiquetas", "Cuantificacion")");
            } else {
                displayMessage("notificationslabel0022", "", '1');
                return;
            }

        };
        function csvJSON(csv) {
            var lines = csv.split("\n");
            var records = [];
            var z = 0;
            for (var i = 1; i < lines.length; i++) {
                if (lines[i]) {
                    records[z] = { ItemCode: lines[i].split(",")[0], Descripcion: "", MM: "", D1: 0, D2: 0, ItemCodeSteelgo: "", Familia: "", Cedula: "", TipoAcero: "", Colada: "", Cantidad: Number(lines[i].split(",")[1]), Detallar: "No", TieneNU: "No", TieneError: false };
                    z++;
                }
            }
            return JSON.stringify(records);
        };
    

        function CargarDefaults() {
            $("#formCuantificacion :not(.security_required)").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    switch ($(elem).attr("id")) {
                        case 'ProyectoID':
                            if (!$("#ProyectoID").data("kendoComboBox").value().length > 0) {
                                CargarProyecto(1, "");
                            }
                            break;
                        case 'TipoUsoID':
                            if (!$("#TipoUsoID").data("kendoComboBox").value().length > 0) {
                                CargarTipoUso(1, "");
                            }
                            break;
                    };
                };
            });
        };
        @section JavascriptDocumentReadyFunctions 
        {
            var dispositivo = navigator.userAgent.toLowerCase();
            /*
            if (!dispositivo.match(/(iphone|ipod|ipad|android)/)) {
                $(document).keydown(function (e) {
                    keydown(e);
                }).keyup(function (e) {
                    if (e.keyCode == ctrlKey) ctrlDown = false;
                });
            };
            */
            cargaInicial();

            //detallar un bulto
            if (_detalleBulto!="-1") {
                cargaInicialEdicionDetalleBulto();
            }

            ////edicion de un folio cuantificacion
            if (_edicion != "-1") {
                cargaInicialEdicion();
            };

            $("#massiveUpload").click( function () {
                $("#txtFileUpload").click();
            });

            $("#hdnNavegacion").val(Cookies.get("navegacion"));
            $authorizationModel["Orden Recepcion"] = $OrdenRecepcionModel
            $authorizationModel["Cuantificacion"] = $CuantificacionModel;
            $authorizationModel["Item Code"] = $ItemCodeModel;
            $authorizationModel["Colada"] = $ColadaModel;
            $authorizationModel["Bulto"] = $BultoModel;
            
    }

    @section JavascriptDocumentReadyHomeCookie {
        Cookies.set("home", true, { path: '/' });
        Cookies.set("navegacion", "12", { path: '/' });
    } 
</script>
