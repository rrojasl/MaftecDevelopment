
@{
    ViewBag.Title = "Cuantificación";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="Cuantificacion0001"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("Cuantificacion", "Cuantificacion")"><span id="Cuantificacion0002"></span></a>
    </li>
}

<div class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div id="formCuantificacion" class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <span id="divFolio" class="folioLabel hidden">
                <span id="Cuantificacion0079"></span>
                <span id="spanFolio"></span>
                <span id="Cuantificacion0080"></span>
                <span id="Cuantificacion0076" class="statusLabel"></span>
                <span id="Cuantificacion0077" class="statusLabel"></span>
                <span id="Cuantificacion0078" class="statusLabel"></span>
                <div class="branchCut"></div>
            </span>
            <div class="formNav clearfix">
                <div class="row">
                    <div class="col-sm-12 col-md-12 col-lg-12">
                        <div class="button-section">
                            <div class="btn-group save-group">
                                <button id="Guardar" onclick="javascript:void(0);" type="button" class="btn btn-yellow"><span id="Cuantificacion0003"></span></button>
                                <button id="Editar" onclick="javascript:void(0);" type="button" class="btn btn-yellow" style="display:none"><span id="Cuantificacion0004"></span></button>
                                <button id="dropdown-toggle" type="button" class="btn btn-yellow dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caretWhite"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li id="MenuTerminar"><a id="TerminaryNuevo" href="#"><span id="Cuantificacion0005"></span></a></li>
                                    <li id="MenuGuardarParcial"><a id="GuardarParcialyNuevo" href="#"><span id="Cuantificacion0008"></span></a></li>
                                    <li id="MenuCerrar"><a id="GuardaryCerrar" href="#"><span id="Cuantificacion0009"></span></a></li>
                                    <li id="guardarBulto"><a id="GuardaryTerminar" href="#"><span id="Cuantificacion0075"></span></a></li>
                                </ul>

                            </div>
                            <a id="Cancelar" href="#" class="btn btn-black"><span id="Cuantificacion0010"></span></a>
                        </div>
                        <div class="button-section">
                            <a id="GenerarOrdenRecepcion" href="#" class="btn btn-primary"><span id="Cuantificacion0011"></span></a>
                        </div>
                        <div class="button-section">
                            <div class="dropdown action-group">
                                <a id="Acciones" data-target="#" href="#" data-toggle="dropdown" role="button" ariahaspopup="true" aria-expanded="false" class="btn btn-default">
                                    <span id="Cuantificacion0042"></span>
                                    <span class="caretBlue"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="Acciones">
                                </ul>
                            </div>
                        </div>
                        <a id="Imprimir" href="#" class="btn btn-fadeBlue"></a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="filterForm col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div id="FolioAvisoEntradaDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0012"></label>
                            <input id="FolioAvisoEntradaID" class="" />
                        </div>
                        <div id="ProyectoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0013"></label>
                            <input id="ProyectoID" />
                        </div>
                        <div id="FolioCuantificacionDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0014"></label>
                            <input id="FolioCuantificacionID" />
                        </div>
                        <div id="BultoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0015"></label>
                            <input id="BultoID"  disabled="disabled"/>
                        </div>
                        <div id="PackingListDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0016"></label>
                            <input id="PackingList" />
                        </div>
                        <div id="TipoPackingListDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0017"></label>
                            <input id="TipoPackingListID" />
                        </div>
                        <div id="TipoUsoDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0018"></label>
                            <input id="TipoUsoID" />
                        </div>
                        <div id="massiveUploadDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0019"></label>
                            <button id="massiveUpload" class="btn btn-primary"><span id="Cuantificacion0020"></span></button>
                            <input name="txtFileUpload" id="txtFileUpload" type="file" class="hidden"/>
                        </div>
                       
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
                <div class="filterForm col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div id="ColadaDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0022"></label>
                            <input id="Colada" class="" />
                        </div>
                        <div id="CantidadDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0023"></label>
                            <input id="Cantidad" class="" />
                        </div>
                        <div id="MMDiv" class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0024"></label>
                            <input id="MM" class="" />
                        </div>
                        <div class="form-group col-sm-6 col-md-4 col-lg-3">
                            <label id="Cuantificacion0025"></label>
                            <label id="Cuantificacion0026"></label>
                            <input id="todos" class="" type="radio" name="radio" checked value="1">
                            <label id="Cuantificacion0027"></label>
                            <input id="vacios" class="" type="radio" name="radio" value="2"/>
                        </div>
                    </div>
                </div>
            </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div id="grid"></div>
        </div>

        
        <ul id="menu">
            <li>Detallar
            </li>
        </ul>

    </div>
</div>

<div id="window">
@*Contenido de la ventana modal *@
        <div id="modalItemCode" style="display: none">
            <div class="alert-container">
                <div class="message">
                    Mensaje de éxito/error/advertencia
                </div>
            </div>
            <div id="Proyecto_ItemCodeDiv" class="form-group">
                <label id="Cuantificacion0055"></label>
                <input id="Proyecto_ItemCode" class="" />
            </div>
            <div id="TipoMaterial_ItemCodeDiv" class="form-group">
                <label id="Cuantificacion0056"></label>
                <input id="TipoMaterial_ItemCode" class="" />
            </div>
            <div id="Colada_ItemCodeDiv" class="form-group">
                <label id="Cuantificacion0057"></label>
                <input id="Colada_ItemCode" class="" />
            </div>
            <div id="ItemCode_ItemCodeDiv" class="form-group">
                <label id="Cuantificacion0045"></label>
                <input id="ItemCode_ItemCode" class="" />
            </div>
            <div id="Descripcion_ItemCodeDiv" class="form-group">
                <label id="Cuantificacion0046"></label>
                <input id="Descripcion_ItemCode" class="" />
            </div>
            <div id="Familia_ItemCodeDiv" class="form-group">
                <label id="Cuantificacion0047"></label>
                <input id="Familia_ItemCode" class="" />
            </div>
            <div class="buttonSave">
                <a id="GuardarItemCode" href="#" class="btn btn-primary">
                    <span id="Cuantificacion0048"></span>
                </a>
                <a id="CancelarItemCode" href="#" class="btn btn-primary">
                    <span id="Cuantificacion0049"></span>
                </a>
            </div>
        </div>
    
    <div id="modalItemCodeSteelgo" style="display: none">
            <div class="alert-container">
                <div class="message">
                    Mensaje de éxito/error/advertencia
                </div>
            </div>
            <div id="Descripcion_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0051"></label>
                <input id="Descripcion_ItemCodeSteelgo" class="" />
            </div>
            <div id="Familia_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0052"></label>
                <input id="Familia_ItemCodeSteelgo" class="" />
            </div>
            <div id="Peso_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0069"></label>
                <input id="Peso_ItemCodeSteelgo" class="" />
            </div>
            <div id="Diametro1_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0070"></label>
                <input id="Diametro1_ItemCodeSteelgo" class="" />
            </div>
            <div id="Diametro2_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0071"></label>
                <input id="Diametro2_ItemCodeSteelgo" class="" />
            </div>
            <div id="Area_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0072"></label>
                <input id="Area_ItemCodeSteelgo" class="" />
            </div>
            <div id="Cedula_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0073"></label>
                <input id="Cedula_ItemCodeSteelgo" class="" />
            </div>
            <div id="Codigo_ItemCodeSteelgoDiv" class="form-group">
                <label id="Cuantificacion0074"></label>
                <input id="Codigo_ItemCodeSteelgo" class="" />
            </div>
            <div class="buttonSave">
                <a id="GuardarItemCodeSteelgo" href="#" class="btn btn-primary">
                    <span id="Cuantificacion0053"></span>
                </a>
                <a id="CancelarItemCodeSteelgo" href="#" class="btn btn-primary">
                    <span id="Cuantificacion0054"></span>
                </a>
            </div>
    </div>

    <div id="modalColada" style="display: none">
            <div class="alert-container">
                <div class="message">
                    Mensaje de éxito/error/advertencia
                </div>
            </div>
            <div id="Fabricante_ColadaDiv" class="form-group">
                <label id="Cuantificacion0061"></label>
                <input id="Fabricante_Colada" class="" />
            </div>
            <div id="Acero_ColadaDiv" class="form-group">
                <label id="Cuantificacion0062"></label>
                <input id="Acero_Colada" class="" />
            </div>
            <div id="Proyecto_ColadaDiv" class="form-group">
                <label id="Cuantificacion0063"></label>
                <input id="Proyecto_Colada" class="" />
            </div>
            <div id="NumeroColada_ColadaDiv" class="form-group">
                <label id="Cuantificacion0066"></label>
                <input id="NumeroColada_Colada" class="" />
            </div>
            <div id="NumeroCertificado_ColadaDiv" class="form-group">
                <label id="Cuantificacion0067"></label>
                <input id="NumeroCertificado_Colada" class="" />
            </div>
            <div id="HoldCalidad_ColadaDiv" class="form-group">
                <label id="Cuantificacion0068"></label>
                <input id="HoldCalidad_Colada" type="checkbox" class="" />
            </div>
            <div class="buttonSave">
                <a id="GuardarColada" href="#" class="btn btn-primary">
                    <span id="Cuantificacion0064"></span>
                </a>
                <a id="CancelarColada" href="#" class="btn btn-primary">
                    <span id="Cuantificacion0065"></span>
                </a>
            </div>
        </div>
</div>

<script>
    @section JavascriptGlobalVariables 
    {
            var Proyecto = {}, Cuantificacion = {}, FolioAvisoEntrada = {}, TipoPackingList = {}, TipoUso = {}, resultadoJson,
            itemCodesJson, itemCodesJsonSteelgo, lastEditedCellID = "", lastEditedCellIDSteelgo = "", lastEditedCellIDSColada,
            familiaItemCode = {}, familiaItemCodeSteelgo = {}, ProyectoItemCode = {},
            ProyectoItemCodeSteelgo = {}, TipoPackingListItemCode = {}, TipoPackingListItemCodeSteelgo = {},
            ColadaItemCodeSteelgo = {}, ColadaItemCode = {}, FabricanteColada = {}, AceroColada = {}, ProyectoColada = {};
           
            var _folioAvisoEntradaID = getUrlParameter("FolioAvisoEntradaID", "-1");
            var _folioCuantificacion = getUrlParameter("FolioCuantificacionID", "-1");
            var _folioLlegadaMaterialID = getUrlParameter("FolioLlegadaMaterialID", "-1");
            var _bultoID = getUrlParameter("BultoID", "-1");
            var _detalleBulto = getUrlParameter("DetalleBulto", "-1");
            var _edicion = getUrlParameter("Edicion", "-1");



            var $CuantificacionModel = {
                listContainer: {
                    create: ".nextStepButtonSection",
                    list: ".actionButtonSection",
                    detail: ".editButtonSection",
                    destroy: ""
                },
                properties: {
                    folioAvisoEntradaID: {
                        visible: "#FolioAvisoEntradaDiv",
                        editable: "#FolioAvisoEntradaID",
                        required: "#FolioAvisoEntradaID"
                    },
                    proyecto: {
                        visible: "#ProyectoDiv",
                        editable: "#ProyectoID",
                        required: "#ProyectoID"
                    },
                    folioCuantificacion: {
                        visible: "#FolioCuantificacionDiv",
                        editable: "#FolioCuantificacionID",
                        required: "#FolioCuantificacionID"
                    },
                    bulto: {
                        visible: "#BultoDiv",
                        editable: "#BultoID",
                        required: "#BultoID"
                    },
                    packinglist: {
                        visible: "#PackingListDiv",
                        editable: "#PackingList",
                        required: "#PackingList"
                    },
                    tipoPackingList: {
                        visible: "#TipoPackingListDiv",
                        editable: "#TipoPackingListID",
                        required: "#TipoPackingListID"
                    },
                    tipouso: {
                        visible: "#TipoUsoDiv",
                        editable: "#TipoUsoID",
                        required: "#TipoUsoID"
                    },
                    cargamasiva: {
                        visible: "#massiveUploadDiv",
                        editable: "#massiveUpload",
                        required: "#massiveUpload"
                    },
                    colada: {
                        visible: "#ColadaDiv",
                        editable: "#Colada",
                        required: "#Colada"
                    },
                    cantidad: {
                        visible: "#CantidadDiv",
                        editable: "#Cantidad",
                        required: "#Cantidad"
                    },
                    mm: {
                        visible: "#MMDiv",
                        editable: "#MM",
                        required: "#MM"
                    }
                }
            };


            var $ItemCodeModel = {
                listContainer: {
                    create: "",
                    list: "",
                    detail: "",
                    destroy: ""
                },
                properties: {
                    proyecto: {
                        visible: "#Proyecto_ItemCodeDiv",
                        editable: "#Proyecto_ItemCode",
                        required: "#Proyecto_ItemCode"
                    },
                    tipomaterial: {
                        visible: "#TipoMaterial_ItemCodeDiv",
                        editable: "#TipoMaterial_ItemCode",
                        required: "#TipoMaterial_ItemCode"
                    },
                    colada: {
                        visible: "#Colada_ItemCodeDiv",
                        editable: "#Colada_ItemCode",
                        required: "#Colada_ItemCode"
                    },
                    codigo: {
                        visible: "#ItemCode_ItemCodeDiv",
                        editable: "#ItemCode_ItemCode",
                        required: "#ItemCode_ItemCode"
                    },
                    descripcion: {
                        visible: "#Descripcion_ItemCodeDiv",
                        editable: "#Descripcion_ItemCode",
                        required: "#Descripcion_ItemCode"
                    },
                    familia: {
                        visible: "#Familia_ItemCodeDiv",
                        editable: "#Familia_ItemCode",
                        required: "#Familia_ItemCode"
                    }
                }
            };
            
            var $ItemCodeSteelgoModel = {
                listContainer: {
                    create: "",
                    list: "",
                    detail: "",
                    destroy: ""
                },
                properties: {
                    descripcion: {
                        visible: "#Descripcion_ItemCodeSteelgoDiv",
                        editable: "#Descripcion_ItemCodeSteelgo",
                        required: "#Descripcion_ItemCodeSteelgo"
                    },
                    familia: {
                        visible: "#Familia_ItemCodeSteelgoDiv",
                        editable: "#Familia_ItemCodeSteelgo",
                        required: "#Familia_ItemCodeSteelgo"
                    },
                    peso: {
                        visible: "#Peso_ItemCodeSteelgoDiv",
                        editable: "#Peso_ItemCodeSteelgo",
                        required: "#Peso_ItemCodeSteelgo"
                    },
                    diametro1: {
                        visible: "#Diametro1_ItemCodeSteelgoDiv",
                        editable: "#Diametro1_ItemCodeSteelgo",
                        required: "#Diametro1_ItemCodeSteelgo"
                    },
                    diametro2: {
                        visible: "#Diametro2_ItemCodeSteelgoDiv",
                        editable: "#Diametro2_ItemCodeSteelgo",
                        required: "#Diametro2_ItemCodeSteelgo"
                    },
                    area: {
                        visible: "#Area_ItemCodeSteelgoDiv",
                        editable: "#Area_ItemCodeSteelgo",
                        required: "#Area_ItemCodeSteelgo"
                    },
                    cedula: {
                        visible: "#Cedula_ItemCodeSteelgoDiv",
                        editable: "#Cedula_ItemCodeSteelgo",
                        required: "#Cedula_ItemCodeSteelgo"
                    },
                    codigo: {
                        visible: "#Codigo_ItemCodeSteelgoDiv",
                        editable: "#Codigo_ItemCodeSteelgo",
                        required: "#Codigo_ItemCodeSteelgo"
                    }
                }
            };


            var $ColadaModel = {
                listContainer: {
                    create: "",
                    list: "",
                    detail: "",
                    destroy: ""
                },
                properties: {
                    fabricante: {
                        visible: "#Fabricante_ColadaDiv",
                        editable: "#Fabricante_Colada",
                        required: "#Fabricante_Colada"
                    },
                    acero: {
                        visible: "#Acero_ColadaDiv",
                        editable: "#Acero_Colada",
                        required: "#Acero_Colada"
                    },
                    proyecto: {
                        visible: "#Proyecto_ColadaDiv",
                        editable: "#Proyecto_Colada",
                        required: "#Proyecto_Colada"
                    },
                    numerocolada: {
                        visible: "#NumeroColada_ColadaDiv",
                        editable: "#NumeroColada_Colada",
                        required: "#NumeroColada_Colada"
                    },
                    numerocertificado: {
                        visible: "#NumeroCertificado_ColadaDiv",
                        editable: "#NumeroCertificado_Colada",
                        required: "#NumeroCertificado_Colada"
                    },
                    holdcalidad: {
                        visible: "#HoldCalidad_ColadaDiv",
                        editable: "#HoldCalidad_Colada",
                        required: "#HoldCalidad_Colada"
                    }
                }
            };

    };

    @section JavascriptGlobalFunctions 
    {
        function changeLanguageCall() {
            LoadGridQuantification();
        }

        function cargaInicial() {
            document.getElementById('txtFileUpload').addEventListener('change', upload, false);
            document.getElementById("txtFileUpload").addEventListener("click", function (event) {
                this.value = null;
            });

            $("#guardarBulto").css("display", "none");
            $("#MenuTerminar").css("display", "block");
            $("#MenuGuardarParcial").css("display", "block");
            $("#MenuCerrar").css("display", "block");
           

            $("#menu").kendoContextMenu({
                target: "#grid",
                filter: "td",
                select: function (e) {               
                    var grid = $('#grid').data("kendoGrid");
                    var filaseleccionada = grid.dataItem($('.k-grid').find("tr.k-state-selected"));
                    var valor = filaseleccionada.BultoID;
                    var ItemCode = filaseleccionada.ItemCode;

                    //Si se trata del detalle de un bulto,
                    //no se puede generar otro bulto
                    if (_bultoID != "-1") {
                        if (!valor) {
                            displayMessage("notificationslabel0043", "", '1');
                            return;
                        }
                    } else {
                        if (ItemCode=="Bulto") {
                            if (valor) {
                                var url = "@Url.Action("Cuantificacion", "Cuantificacion")";
                                window.location.href = url + "?leng=" + $("#language").data("kendoDropDownList").value() + "&DetalleBulto=1&FolioAvisoEntradaID=" + FolioAvisoEntrada.FolioAvisoEntradaID + "&FolioCuantificacionID=" + Cuantificacion.FolioCuantificacionID + "&BultoID=" + valor + "&FolioLlegadaMaterialID=" + FolioAvisoEntrada.FolioLlegadaMaterial;
                            } else {
                                displayMessage("notificationslabel0040", "", '1');
                            }
                        } else {
                            displayMessage("notificationslabel0042", "", '1');
                        }
                    }
                }
            });

            $("#grid").on("mousedown", "tr[role='row']", function (e) {
                $('#grid').data("kendoGrid").select(e.target.parentElement);
            });

            //Botones

            $("#Guardar").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    SavePartially(false);
                } else{
                    displayMessage("notificationslabel0031", "", '1');
                }
            });

            $("#Editar").click(function (e) { BotonEdicion(); });
            $("#TerminaryNuevo").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    FinishAndNew();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#GuardarParcialyNuevo").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    SavePartially(true);
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#GuardaryCerrar").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    SaveAndClose();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#GuardaryTerminar").click(function () {
                if(validarRequeridosFormaCuantificacion()) {
                    SaveAndFinish();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#Cancelar").click(function () { Cancel(); }); 
            $("#GenerarOrdenRecepcion").click(function () {
                if(validarRequeridosFormaCuantificacion()){
                    GenerarOrdenRecepcion();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            $("#massiveUpload").click(function () { $(".k-upload-files.k-reset").find("li").remove(); });

            $("#CancelarItemCode").click(function () { CancelarModalItemCode(); });
            $("#CancelarItemCodeSteelgo").click(function () { CancelarItemCodeSteelgo(); });
            $("#CancelarColada").click(function () { CancelarColada(); });
            
            $("#GuardarItemCode").click(function () {
                if (validarRequeridosModalItemCode()) {
                    GuardarItemCode();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });

            $("#GuardarItemCodeSteelgo").click(function () {
                if (validarRequeridosModalItemCodeSteelgo()) {
                    GuardarItemCodeSteelgo();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });

            $("#GuardarColada").click(function () {
                if (validarRequeridosModalColada()) {
                    GuardarColada();
                } else {
                    displayMessage("notificationslabel0031", "", '1');
                }
            });
            
            $("#FolioAvisoEntradaID").kendoComboBox({
                    dataTextField: "value",
                    dataValueField: "id",
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        CargarFolioAvisoEntrada(dataItem.id,dataItem.value);
                   
                    },
                    change: function (e) {
                        var value = this.value();
                        limpiarfiltrosFolioAvisoEntrada();
                        $("#TipoPackingListID").data("kendoComboBox").enable(true);
                        if (value)
                        {
                            ObtenerDatosDelFolioAvisoLlegada();
                        } else {
                            FolioAvisoEntrada = {};
                        }
                    
                    },
                    filter: "contains",
            });
            ObtenerFoliosAvisoLlegada();

            $("#ProyectoID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "ProyectoID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarProyecto(dataItem.ProyectoID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        Proyecto = {};
                    } 
                },
                filter: "contains",
            });
            //ObtenerProyecto("ProyectoID");


            $("#FolioCuantificacionID").kendoComboBox({
                dataTextField: "FolioCuantificacionID",
                dataValueField: "FolioAvisoEntradaID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarFolioCuantificacion(dataItem.FolioCuantificacionID);
                },
                change: function (e) {
                    var value = this.value();
                    limpiarfiltrosFolioCuantificacion();
                    if(value){
                        ObtenerDatosDelFolioAvisoLlegadaCuantificacion(FolioAvisoEntrada.FolioAvisoEntradaID, Cuantificacion.FolioCuantificacionID);// debe de ponerse el folio de llegada de material
                    } else {
                        Cuantificacion = {};
                        $("#TipoPackingListID").data("kendoComboBox").enable(true);
                    }
            },
                filter: "contains",
            });

            $("#TipoPackingListID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "TipoMaterialID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarTipoPackingList(dataItem.TipoMaterialID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        TipoPackingList = {};
                    } else {
                        var grid = $("#grid").data("kendoGrid");
                        if (value == "2") {
                            changeValueColumnMMNoAplica();
                        }
                    };
                },
                filter: "contains",
            });
            obtenerTipoPackingList("TipoPackingListID");

            $("#TipoUsoID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "id",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarTipoUso(dataItem.id, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        TipoUso = {};
                    };
                },
                filter: "contains",
            });
            ObtenerTipoUso();

            $("#Colada").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "TransportistaID",
                change: function (e) {
                    var value = this.value();
                    changeValueColumnColada($("#Colada").data("kendoComboBox").text());
                },
                filter: "contains",
            });
            ObtenerColada("Colada");

            $("#Cantidad").keyup(function () {
                changeValueColumnCantidad(this.value);
            });

            $("#MM").keyup(function () {
                    changeValueColumnMM(this.value);
            });
            $('input:radio').click(function () {
                if ($(this).val() === '1') {
                    changeValueColumnsAll();
                } else if ($(this).val() === '2') {
                    changeValueColumnsClear();
                }
            });


            //Ventana Modal ItemCode
            $("#Proyecto_ItemCode").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "ProyectoID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarProyectoItemCode(dataItem.ProyectoID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        ProyectoItemCode = {};
                    }
                },
                filter: "contains",
            });
            ObtenerProyecto("Proyecto_ItemCode");
           
            $("#TipoMaterial_ItemCode").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "TipoMaterialID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarTipoPackingListItemCode(dataItem.TipoMaterialID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        TipoPackingListItemCode = {};
                    }
                },
                filter: "contains",
            });
            obtenerTipoPackingList("TipoMaterial_ItemCode");

            $("#Colada_ItemCode").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "TransportistaID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarColadaItemCode(dataItem.TransportistaID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        ColadaItemCode = {};
                    }
                },
                filter: "contains",
            });
            ObtenerColada("Colada_ItemCode");

            $("#Familia_ItemCode").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "FamiliaAceroID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarFamiliaItemCode(dataItem.FamiliaAceroID);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        familiaItemCode = {};
                    };
                },
                filter: "contains",
            });
            ObtenerFamiliaItemCode();

            //Ventana Modal ItemCodeSteelgo
            $("#Proyecto_ItemCodeSteelgo").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "ProyectoID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarProyectoItemCodeSteelgo(dataItem.ProyectoID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        ProyectoItemCodeSteelgo = {};
                    }
                },
                filter: "contains",
            });
            ObtenerProyecto("Proyecto_ItemCodeSteelgo");

            $("#TipoMaterial_ItemCodeSteelgo").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "TipoMaterialID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarTipoPackingListItemCodeSteelgo(dataItem.TipoMaterialID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        TipoPackingListItemCodeSteelgo = {};
                    }
                },
                filter: "contains",
            });
            obtenerTipoPackingList("TipoMaterial_ItemCodeSteelgo");
            
            $("#Colada_ItemCodeSteelgo").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "TransportistaID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarColadaItemCodeSteelgo(dataItem.TransportistaID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        ColadaItemCodeSteelgo = {};
                    }
                },
                filter: "contains",
            });
            ObtenerColada("Colada_ItemCodeSteelgo");

            $("#Familia_ItemCodeSteelgo").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "FamiliaAceroID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarFamiliaItemCodeSteelgo(dataItem.FamiliaAceroID);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        familiaItemCodeSteelgo = {};
                    };
                },
                filter: "contains",
            });
            ObtenerFamiliaItemCodeSteelgo();


            //Ventana Modal Colada
            $("#Fabricante_Colada").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "FabricanteID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarFabricanteColada(dataItem.FabricanteID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        FabricanteColada = {};
                    };
                },
                filter: "contains",
            });
            ObtenerFabricanteColada();


            $("#Acero_Colada").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "AceroID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarAceroColada(dataItem.AceroID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        AceroColada = {};
                    };
                },
                filter: "contains",
            });
            ObtenerAceroColada();
            
            $("#Proyecto_Colada").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "ProyectoID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarProyectoColada(dataItem.ProyectoID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        ProyectoColada = {};
                    }
                },
                filter: "contains",
            });
            ObtenerProyecto("Proyecto_Colada");

        };

        function cargaInicialEdicionDetalleBulto() {
            DetalleBultoObtenerDatosDelFolioAvisoLlegadaCuantificacion(_folioAvisoEntradaID, _folioCuantificacion, _bultoID, _folioLlegadaMaterialID);

        };

        function cargaInicialEdicion() {
            $("#FolioAvisoEntradaID").data("kendoComboBox").value(_folioLlegadaMaterialID);
            $("#FolioCuantificacionID").data("kendoComboBox").text(_folioCuantificacion);
            CargarFolioCuantificacion(_folioCuantificacion);
            CargarFolioAvisoEntrada(_folioAvisoEntradaID, _folioLlegadaMaterialID);

            ObtenerDatosDelFolioAvisoLlegada();
            ObtenerDatosDelFolioAvisoLlegadaCuantificacion(_folioAvisoEntradaID, _folioCuantificacion);
            
        };

        function BotonEdicion() {
            $("#dropdown-toggle").show();
            $("#Editar").css("display", "none");
            $("#Guardar").css("display", "block");
            habilitarControles();
        };

        function BotonAlta() {
            $("#dropdown-toggle").hide();
            $("#Editar").css("display", "block");
            $("#Guardar").css("display", "none");
            deshabilitarControles();
        };

        function habilitarControles() {
            
                $("#FolioAvisoEntradaID").data("kendoComboBox").enable(true);
                $("#ProyectoID").data("kendoComboBox").enable(true);
                $("#FolioCuantificacionID").data("kendoComboBox").enable(true);
                $("#BultoID").removeAttr("disabled");
                $("#PackingList").removeAttr("disabled");
                $("#TipoPackingListID").data("kendoComboBox").enable(true);
                $("#TipoUsoID").data("kendoComboBox").enable(true);
                $("#massiveUpload").attr("disabled", "disabled");
                $("#Colada").data("kendoComboBox").enable(true);
                $("#Cantidad").removeAttr("disabled");
                $("#MM").removeAttr("disabled");
                $(".k-button").addClass("k-state-disabled").removeClass("k-grid-add");
                $("input:radio").removeAttr("disabled");

                if (_detalleBulto != "-1") {
                    DeshabilitarControlesDetalleBulto();
                }
        }

        function deshabilitarControles() {
            $("#FolioAvisoEntradaID").data("kendoComboBox").enable(false);
            $("#ProyectoID").data("kendoComboBox").enable(false);
            $("#FolioCuantificacionID").data("kendoComboBox").enable(false);
            $("#BultoID").attr("disabled", "disabled");
            $("#PackingList").attr("disabled", "disabled");
            $("#TipoPackingListID").data("kendoComboBox").enable(false);
            $("#TipoUsoID").data("kendoComboBox").enable(false);
            $("#massiveUpload").attr("disabled", "disabled");
            $("#Colada").data("kendoComboBox").enable(false);
            $("#Cantidad").attr("disabled", "disabled");
            $("#MM").attr("disabled", "disabled");
            $(".k-button").addClass("k-state-disabled").removeClass("k-grid-add");
            $("input:radio").attr('disabled', "disabled");
        };

        function CargarProyecto(id, value) {
            Proyecto = {};
            Proyecto = { ProyectoID: id, Nombre: value };
        };
        
        function CargarProyectoItemCode(id, value) {
            ProyectoItemCode = {};
            ProyectoItemCode = { ProyectoID: id, Nombre: value };
        };
        function CargarTipoPackingListItemCode(id, value) {
            TipoPackingListItemCode = {};
            TipoPackingListItemCode = { TipoPackingListID: id, Nombre: value };
        };

        function CargarColadaItemCode(id, value) {
            ColadaItemCode = {};
            ColadaItemCode = { ColadaID: id, Nombre: value };
        };

        function CargarProyectoItemCodeSteelgo(id, value) {
            ProyectoItemCodeSteelgo = {};
            ProyectoItemCodeSteelgo = { ProyectoID: id, Nombre: value };
        };
        
        function CargarTipoPackingListItemCodeSteelgo(id, value) {
            TipoPackingListItemCodeSteelgo = {};
            TipoPackingListItemCodeSteelgo = { TipoPackingListID: id, Nombre: value };
        };

        function CargarColadaItemCodeSteelgo(id, value) {
            ColadaItemCodeSteelgo = {};
            ColadaItemCodeSteelgo = { ColadaID: id, Nombre: value };
        };

        function CargarFolioAvisoEntrada(id, value) {
            FolioAvisoEntrada = {};
            FolioAvisoEntrada = { FolioAvisoEntradaID: id, FolioLlegadaMaterial: value };
        };

        function CargarTipoPackingList(id, value) {
            TipoPackingList = {};
            TipoPackingList = { TipoPackingListID: id, Nombre: value };
        };

        function CargarTipoUso(id, value) {
            TipoUso = {};
            TipoUso = { TipoUsoID: id, Nombre: value };
        };

        function CargarFolioCuantificacion(id) {
            Cuantificacion = {};
            Cuantificacion = { FolioCuantificacionID: id };
        };

        function CargarFamiliaItemCode(id) {
            familiaItemCode = {};
            familiaItemCode = { FamiliaID: id };
        };
        
        function CargarFamiliaItemCodeSteelgo(id) {
            familiaItemCodeSteelgo = {};
            familiaItemCodeSteelgo = { FamiliaID: id };
        };

        function CargarFabricanteColada(id, value) {
            FabricanteColada = {};
            FabricanteColada = { FabricanteID: id, Nombre: value };
        };

        function CargarAceroColada(id, value) {
            AceroColada = {};
            AceroColada = { AceroID: id, Nombre: value };
        };
        
        function CargarProyectoColada(id, value) {
            ProyectoColada = {};
            ProyectoColada = { ProyectoID: id, Nombre: value };
        };

        function CancelarModalItemCode() {
            LimpiarModalItemCode();
            cerrarVentanaModal();
            cancelarvalidacionRequeridosModalItemCode();
        };

        function CancelarItemCodeSteelgo() {
            LimpiarModalItemCodeSteelgo();
            cerrarVentanaModal();
            cancelarvalidacionRequeridosModalItemCodeSteelgo();
        };

        function CancelarColada() {
            LimpiarModalColada();
            cerrarVentanaModal();
            cancelarvalidacionRequeridosModalColada();
        };
        
        function LimpiarModalItemCode() {
            $("#ItemCode_ItemCode").val("");
            $("#Descripcion_ItemCode").val("");
            $("#Familia_ItemCode").data("kendoComboBox").value("");
            $("#Proyecto_ItemCode").data("kendoComboBox").value("");
            $("#TipoMaterial_ItemCode").data("kendoComboBox").value("");
            $("#Colada_ItemCode").data("kendoComboBox").value("");
            
            familiaItemCode = {};
            ProyectoItemCode = {};
            TipoPackingListItemCode = {};
            ColadaItemCode = {};
        };

        function LimpiarModalItemCodeSteelgo() {
            $("#Descripcion_ItemCodeSteelgo").val("");
            $("#Familia_ItemCodeSteelgo").data("kendoComboBox").value("");
            $("#Peso_ItemCodeSteelgo").val("");
            $("#Diametro1_ItemCodeSteelgo").val("");
            $("#Diametro2_ItemCodeSteelgo").val("");
            $("#Area_ItemCodeSteelgo").val("");
            $("#Cedula_ItemCodeSteelgo").val("");
            $("#Codigo_ItemCodeSteelgo").val("");

            familiaItemCodeSteelgo = {};
        };

        function LimpiarModalColada() {
            $("#Fabricante_Colada").data("kendoComboBox").value("");
            $("#Acero_Colada").data("kendoComboBox").value("");
            $("#Proyecto_Colada").data("kendoComboBox").value("");
            $("#NumeroColada_Colada").val("");
            $("#NumeroCertificado_Colada").val("");
            $("#HoldCalidad_Colada").attr("checked", false);

            FabricanteColada = {};
            AceroColada = {};
            ProyectoColada = {};

        };

        function cancelarvalidacionRequeridosModalItemCode() {
            $("#modalItemCode .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    $(this).closest("div").find("label").removeClass("error");
                    $(this).closest("div").removeClass("clearfix");
                };
            });
        };

        function cancelarvalidacionRequeridosModalItemCodeSteelgo() {
            $("#modalItemCodeSteelgo .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    $(this).closest("div").find("label").removeClass("error");
                    $(this).closest("div").removeClass("clearfix");
                };
            });
        };

        function cancelarvalidacionRequeridosModalColada() {
            $("#modalColada .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    $(this).closest("div").find("label").removeClass("error");
                    $(this).closest("div").removeClass("clearfix");
                };
            });
        };

        function cerrarVentanaModal() {
            $("#window").data("kendoWindow").close();
        };

        function validarRequeridosFormaCuantificacion() {
            var bool = true;
            $("#formAvisoLlegada .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    if (!$(this).val()) {
                        bool = false;
                        $(this).closest("div").find("label").addClass("error");
                    } else {
                        $(this).closest("div").find("label").removeClass("error");
                    };
                };
            });
            return bool;
        };

        function validarRequeridosModalItemCode() {
            var bool = true;
            $("#modalItemCode .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    if (!$(this).val()) {
                        bool = false;
                        $(this).closest("div").find("label").addClass("error");
                        $(this).closest("div").addClass("clearfix");
                    } else {
                        $(this).closest("div").find("label").removeClass("error");
                        $(this).closest("div").removeClass("clearfix");
                    };
                };
            });
            return bool;
        };

        function validarRequeridosModalItemCodeSteelgo() {
            var bool = true;
            $("#modalItemCodeSteelgo .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    if (!$(this).val()) {
                        bool = false;
                        $(this).closest("div").find("label").addClass("error");
                        $(this).closest("div").addClass("clearfix");
                    } else {
                        $(this).closest("div").find("label").removeClass("error");
                        $(this).closest("div").removeClass("clearfix");
                    };
                };
            });
            return bool;
        };

        function validarRequeridosModalColada() {
            var bool = true;
            $("#modalColada .security_required").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    if ($(this).attr("id") == "HoldCalidad_Colada") {
                        if (!$(this).is(':checked')) {
                            bool = false;
                            $(this).closest("div").find("label").addClass("error");
                            $(this).closest("div").addClass("clearfix");
                        } else {
                            $(this).closest("div").find("label").removeClass("error");
                            $(this).closest("div").removeClass("clearfix");
                        }
                    } else {
                        if (!$(this).val()) {
                            bool = false;
                            $(this).closest("div").find("label").addClass("error");
                            $(this).closest("div").addClass("clearfix");
                        } else {
                            $(this).closest("div").find("label").removeClass("error");
                            $(this).closest("div").removeClass("clearfix");
                        };
                    }
                };
            });
            return bool;
        };

        function ocultarStatus() {
            $("#Cuantificacion0076").hide();
            $("#Cuantificacion0077").hide();
            $("#Cuantificacion0078").hide();
        };

        function GenerarOrdenRecepcion() {
            var detalleIdeaUrl = "@Url.Action("GenerarOrdenRecepcion", "Cuantificacion")";
            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value() + "&FolioAvisoEntradaID=" + FolioAvisoEntrada.FolioAvisoEntradaID + "&ProyectoID=" + Proyecto.ProyectoID;
        };

        function GuardarItemCode() {
            ItemCode = { ProyectoID: "", TipoPackingList: "", ColadaID: "", ItemCode: "", Descripcion: "", FamiliaID: "" };
            ItemCode.ProyectoID = ProyectoItemCode.ProyectoID;
            ItemCode.TipoPackingList = TipoPackingListItemCode.TipoPackingListID;
            ItemCode.ColadaID = ColadaItemCode.ColadaID;
            ItemCode.ItemCode = $("#ItemCode_ItemCode").val();
            ItemCode.Descripcion = $("#Descripcion_ItemCode").val();
            ItemCode.FamiliaID = !familiaItemCode.FamiliaID ? "-1" : familiaItemCode.FamiliaID;

            $DummyItemCode.DummyItemCode.create({}, { data: JSON.stringify(ItemCode), token: Cookies.get("token") }).done(function (data) {
                LimpiarModalItemCode();
                if (Error(data)) {
                    $("#window").data("kendoWindow").close();
                };
            });

        };
        
        function GuardarItemCodeSteelgo() {
            ItemCodeSteelgo = { Descripcion: "", FamiliaID: "", Peso: "", Diametro1: "", Diametro2: "", Area: "", Cedula: "", Codigo: "" };
            ItemCodeSteelgo.Descripcion = $("#Descripcion_ItemCodeSteelgo").val();
            ItemCodeSteelgo.FamiliaID = !familiaItemCodeSteelgo.FamiliaID ? "-1" : familiaItemCode.FamiliaID;
            ItemCodeSteelgo.Peso = $("#Peso_ItemCodeSteelgo").val();
            ItemCodeSteelgo.Diametro1 = $("#Diametro1_ItemCodeSteelgo").val();
            ItemCodeSteelgo.Diametro2 = $("#Diametro2_ItemCodeSteelgo").val();
            ItemCodeSteelgo.Area = $("#Area_ItemCodeSteelgo").val();
            ItemCodeSteelgo.Cedula = $("#Cedula_ItemCodeSteelgo").val();
            ItemCodeSteelgo.Codigo = $("#Codigo_ItemCodeSteelgo").val();
          
            $DummyItemCodeSteelgo.DummyItemCodeSteelgo.create({}, { data: JSON.stringify(ItemCodeSteelgo), token: Cookies.get("token") }).done(function (data) {
                LimpiarModalItemCodeSteelgo();
                if (Error(data)) {
                    $("#window").data("kendoWindow").close();
                };
            });

        };

        function GuardarColada() {
            ColadaModal = { FabricanteID: "", AceroID: "", ProyectoID: "", NumeroColada: "", NumeroCertificado: "", HoldCalidad: "" };
            ColadaModal.FabricanteID = FabricanteColada.FabricanteID;
            ColadaModal.AceroID = AceroColada.AceroID;
            ColadaModal.ProyectoID = ProyectoColada.ProyectoID;
            ColadaModal.NumeroColada = $("#NumeroColada_Colada").val();
            ColadaModal.NumeroCertificado = $("#NumeroCertificado_Colada").val();
            ColadaModal.HoldCalidad = $("#HoldCalidad_Colada").is(":checked");

            $DummyColada.DummyColada.create({}, { data: JSON.stringify(ColadaModal), token: Cookies.get("token") }).done(function (data) {
                LimpiarModalColada();
                if (Error(data)) {
                    $("#window").data("kendoWindow").close();
                    ObtenerColada("Colada");
                    ObtenerColada("Colada_ItemCode");
                    ObtenerColada("Colada_ItemCodeSteelgo");
                }
            });
        };

        function LoadGridQuantification() {
            $("#grid").kendoGrid({
                dataSource: {
                    data: resultadoJson,
                    autoSync: true,
                    schema: {
                        model: {
                            fields: {
                                ItemCode: { type: "string", editable: true },
                                BultoID: { type: "string", editable: true },
                                Descripcion: { type: "string", editable: false },
                                D1: { type: "number", editable: true },
                                D2: { type: "number", editable: true },
                                ItemCodeSteelgo: { type: "string", editable: true },
                                Familia: { type: "string", editable: false },
                                Cedula: { type: "string", editable: false },
                                TipoAcero: { type: "string", editable: false },
                                Colada: { type: "string", editable: true },
                                Cantidad: { type: "number", editable: true },
                                MM: { type: "string", editable: true },
                                Detallar: { type: "string", defaultValue: false, editable: false },
                                TieneNU: { type: "boolean", defaultValue: false, editable: false },
                                TieneError: { type: "boolean", defaultValue: false, editable: false }
                            }
                        }
                    },
                    pageSize: 20,
                    serverPaging: false,
                    serverFiltering: false,
                    serverSorting: false,
                    aggregate: [
                                 { field: "Descripcion", aggregate: "count" },
                                 { field: "Cantidad", aggregate: "sum" }
                    ]
                },
                autoHeight: true,
                sortable: true,
                scrollable: false,
                filterable: true,
                pageable: false,
                groupable: true,
                editable:  {
                    mode: "incell",
                    confirmation: false
                },
                selectable: true,
                edit: function(e) {
                    if (e.model.TieneNU) {
                        //No se permite la edición de los que tengan
                        //asignado numero unico o sean bultos
                        this.closeCell();
                    }
                },
                toolbar: [
                        "create"
                ],
                allowCopy: true,
                navigatable: true,
                columns: [
                    { field: "ItemCode", title: _dictionary.Cuantificacion0028[$("#language").data("kendoDropDownList").value()], editor: itemCodeAutocomplete, filterable: true, width: 120 },
                    { field: "BultoID", title: _dictionary.Cuantificacion0044[$("#language").data("kendoDropDownList").value()], filterable: true, hidden: true },
                    { field: "Descripcion", title: _dictionary.Cuantificacion0029[$("#language").data("kendoDropDownList").value()], filterable: true, aggregates: ["count"], footerTemplate: "Total Count: #=count#", groupFooterTemplate: "Count: #=count#" },
                    { field: "D1", title: _dictionary.Cuantificacion0030[$("#language").data("kendoDropDownList").value()], filterable: true, width: 80 },
                    { field: "D2", title: _dictionary.Cuantificacion0031[$("#language").data("kendoDropDownList").value()], filterable: true, width: 80 },
                    { field: "ItemCodeSteelgo", title: _dictionary.Cuantificacion0032[$("#language").data("kendoDropDownList").value()], editor: itemCodeSteelgoAutocomplete, filterable: true },
                    { field: "Familia", title: _dictionary.Cuantificacion0033[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "Cedula", title: _dictionary.Cuantificacion0034[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "TipoAcero", title: _dictionary.Cuantificacion0035[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "Colada", title: _dictionary.Cuantificacion0036[$("#language").data("kendoDropDownList").value()], editor: ColadaAutocomplete, filterable: true },
                    { field: "Cantidad", title: _dictionary.Cuantificacion0037[$("#language").data("kendoDropDownList").value()], filterable: true, aggregates: ["sum"], footerTemplate: "Total SUM: #=sum#", groupFooterTemplate: "SUM: #=sum#" },
                    { field: "MM", title: _dictionary.Cuantificacion0038[$("#language").data("kendoDropDownList").value()], filterable: true, width:80},
                    { field: "Detallar", title: _dictionary.Cuantificacion0039[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "TieneNU", title: _dictionary.Cuantificacion0040[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "TieneError", title: _dictionary.Cuantificacion0041[$("#language").data("kendoDropDownList").value()], filterable: true, hidden: true },
                    { command: { text: _dictionary.Cuantificacion0043[$("#language").data("kendoDropDownList").value()], click: cancelarItemCode }, title: " ", width: "99px" }
                ]
            });
        };

        function cancelarItemCode(e) {
            e.preventDefault();
            var dataItem = $("#grid").data("kendoGrid").dataItem($(e.currentTarget).closest("tr"));
            var ItemCode = dataItem.ItemCode;
            var bultoID = dataItem.BultoID;
            var folioAvisoLlegadaID = FolioAvisoEntrada.FolioAvisoEntradaID;
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID;

            //Si no tiene registro de bulto se puede borrar sin pasar por las validaciones.
            if (!bultoID) {
                var grid = $("#grid").data("kendoGrid");
                var tr = $(e.currentTarget).closest("tr");
                grid.removeRow(tr);
                return;
            }

            //Viene del detalle del Bulto
            if (_bultoID != "-1") {
                $DumyValidarItemCodeNuCuantificacion.DumyValidarItemCodeNuCuantificacion.read({ folioAvisoLlegadaID: folioAvisoLlegadaID, folioCuantificacionID: folioCuantificacionID, ItemCode: ItemCode, BultoID: _bultoID, token: Cookies.get("token") }).done(function (data) {
                    if (data) {
                        if (confirm("Estas seguro de cancelar el Item Code?")) {
                            $DumyValidarItemCodeNuCuantificacion.DumyValidarItemCodeNuCuantificacion.destroy({}, { folioAvisoLlegadaID: folioAvisoLlegadaID, folioCuantificacionID: folioCuantificacionID, BultoID: _bultoID, ItemCode: ItemCode, token: Cookies.get("token") }).done(function (data) {
                                var grid = $("#grid").data("kendoGrid");
                                var tr = $(e.currentTarget).closest("tr");
                                grid.removeRow(tr);
                            });
                        };
                    } else {
                        displayMessage("notificationslabel0039", "", '1');
                        e.preventDefault();
                    };
                });

            } else {
                //el BultoID del itemcode Bulto, funcionamiento normal
                $DumyValidarItemCodeNuCuantificacion.DumyValidarItemCodeNuCuantificacion.read({ folioAvisoLlegadaID: folioAvisoLlegadaID, folioCuantificacionID: folioCuantificacionID, ItemCode: ItemCode, BultoID: bultoID, token: Cookies.get("token") }).done(function (data) {
                    if (data) {
                        if (confirm("Estas seguro de cancelar el Item Code?")) {
                            $DumyValidarItemCodeNuCuantificacion.DumyValidarItemCodeNuCuantificacion.destroy({}, { folioAvisoLlegadaID: folioAvisoLlegadaID, folioCuantificacionID: folioCuantificacionID, BultoID: bultoID, ItemCode: ItemCode, token: Cookies.get("token") }).done(function (data) {
                                    var grid = $("#grid").data("kendoGrid");
                                    var tr = $(e.currentTarget).closest("tr");
                                    grid.removeRow(tr);
                            });
                        };
                    } else {
                        displayMessage("notificationslabel0039", "", '1');
                        e.preventDefault();
                    };
                });
            }
        };


        function ObtenerFoliosAvisoLlegada() {
            $FoliosCuantificacion.FoliosCuantificacion.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("FolioAvisoEntradaID", result);
            });
        };

        function ObtenerProyecto(id) {
            $Proyecto.Proyecto.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox(id, result);
            });
        };

        function obtenerTipoPackingList(id) {
            $TipoPackingList.TipoPackingList.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox(id, result);
            });
        };

        function ObtenerTipoUso() {
            $TipoUso.TipoUso.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("TipoUsoID", result);
            });
        };

        function ObtenerDatosDelFolioAvisoLlegada() {
            $ObtenerDatosFolioAvisoEntrada.ObtenerDatosFolioAvisoEntrada.read({ folioAvisoLlegadaID: FolioAvisoEntrada.FolioAvisoEntradaID, token: Cookies.get("token") }).done(function (result) {
                if (Error(result)) {
                    if (result.Proyecto.length == 0) {
                        ObtenerProyecto("ProyectoID");
                    } else {
                        ControlErroresObjetosComboBox("ProyectoID", result.Proyecto);
                    };
                    ControlErroresObjetosComboBox("FolioCuantificacionID", result.FolioLlegada);
                } else {
                    limpiarfiltrosFolioAvisoEntrada();
                };
            });
        };

        function VentanaModal(id) {

            var modalTitle = "";

            switch (id) {
                case 1:
                    $("#modalColada").hide();
                    $("#modalItemCodeSteelgo").hide();
                    $("#modalItemCode").show();
                    modalTitle = "Item Code";
                    break;
                case 2:
                    $("#modalColada").hide();
                    $("#modalItemCode").hide();
                    $("#modalItemCodeSteelgo").show();
                    modalTitle = "Item Code Steelgo";
                    break;
                case 3:
                    $("#modalItemCodeSteelgo").hide();
                    $("#modalItemCode").hide();
                    $("#modalColada").show();
                    modalTitle = "Colada";
                    break;
            };

            var window = $("#window");
            var win = window.kendoWindow({
                actions: false,
                modal: true,
                title: modalTitle,
                resizable: false,
                visible: false,
                width: "32.6%",
                minWidth: 660,
                position: {
                    top: "10%",
                    left: "20%"
                }
            }).data("kendoWindow");
            window.data("kendoWindow").title(modalTitle);
            window.data("kendoWindow").center().open();
        };

        function DeshabilitarControlesDetalleBulto() {
            $("#FolioAvisoEntradaID").data("kendoComboBox").enable(false);
            $("#ProyectoID").data("kendoComboBox").enable(false);
            $("#FolioCuantificacionID").data("kendoComboBox").enable(false);
            $("#BultoID").attr("disabled", "disabled");
            $("#PackingList").attr("disabled", "disabled");
            $("#TipoPackingListID").data("kendoComboBox").enable(false);
            $("#TipoUsoID").data("kendoComboBox").enable(false);
        };
        
        function DetalleBultoObtenerDatosDelFolioAvisoLlegadaCuantificacion(folio, cuantificacion, bulto, foliollegadamaterial) {
            $("#guardarBulto").css("display", "block");
            $("#MenuTerminar").css("display", "none");
            $("#MenuGuardarParcial").css("display", "none");
            $("#MenuCerrar").css("display", "none");

            DeshabilitarControlesDetalleBulto();
            $("#FolioAvisoEntradaID").data("kendoComboBox").value(foliollegadamaterial);
            $("#FolioCuantificacionID").data("kendoComboBox").text(cuantificacion);
            CargarFolioCuantificacion(cuantificacion);
            CargarFolioAvisoEntrada(folio, foliollegadamaterial);
            ObtenerDatosDelFolioAvisoLlegada();
            console.log("$dummyObtenerDatosFolioLlegadaMaterial " + folio + ", " + cuantificacion);
            //Obtener la informacion del folio cuantificacion y aviso entrada
            $dummyObtenerDatosFolioLlegadaMaterial.DummyObtenerDatosFolioLlegadaMaterial.read({ FolioLlegadaMaterialID: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacion: cuantificacion, token: Cookies.get("token") }).done(function (result) {
                if (Error(result)) {
                    $("#ProyectoID").data("kendoComboBox").value(result.ProyectoID);
                    $("#BultoID").val(bulto);
                    $("#PackingList").val(result.PackingList);
                    $("#TipoPackingListID").data("kendoComboBox").value(result.TipoPackingList.id);
                    $("#TipoUsoID").data("kendoComboBox").value(result.TipoUso.id);

                    CargarProyecto(result.ProyectoID, $("#ProyectoID").data("kendoComboBox").text());
                    CargarTipoPackingList(result.TipoPackingList.id, $("#TipoPackingListID").data("kendoComboBox").text());
                    CargarTipoUso(result.TipoUso.id, $("#TipoUsoID").data("kendoComboBox").text());
                    cargarGridPackingList();
                } else {
                    limpiarfiltrosFolioCuantificacion();
                };
            });

        };

        function ObtenerDatosDelFolioAvisoLlegadaCuantificacion(folio, cuantificacion) {
            $ObtenerDatosFolioLlegadaMaterial.ObtenerDatosFolioLlegadaMaterial.read({ FolioLlegadaMaterialID: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacion: cuantificacion, token: Cookies.get("token") }).done(function (result) {
                if (Error(result)) {
                    _folioCuantificacion = cuantificacion;
                    $("#ProyectoID").data("kendoComboBox").value(result.ProyectoID);
                    $("#BultoID").val(result.FolioLlegadaHijo);
                    $("#PackingList").val(result.PackingList);
                    $("#TipoPackingListID").data("kendoComboBox").value(result.TipoPackingList.id);
                    $("#TipoPackingListID").data("kendoComboBox").enable(false);
                    $("#TipoUsoID").data("kendoComboBox").value(result.TipoUso.id);
                    CargarLabelEstatus(result.Estatus);
                    CargarProyecto(result.ProyectoID, $("#ProyectoID").data("kendoComboBox").text());
                    CargarTipoPackingList(result.TipoPackingList.id, $("#TipoPackingListID").data("kendoComboBox").text());
                    CargarTipoUso(result.TipoUso.id, $("#TipoUsoID").data("kendoComboBox").text());
                    cargarGridPackingList();
                } else {
                    limpiarfiltrosFolioCuantificacion();
                };
            });
        }

        function CargarLabelEstatus(status) {
            ocultarStatus();
            cargarTituloFolio();
            if (status == "En Proceso Recepcion") {
                $("#Cuantificacion0076").show();
            }

            if (status == "Terminado") {
                $("#Cuantificacion0077").show();
            }

            if (status == "Cerrado") {
                $("#Cuantificacion0078").show();
            }
        };

        function ObtenerColada(id) {
            $Transportista.Transportista.read({ esAvisoEntrada: 0, token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox(id, result);
            });
        };

        function ObtenerFamiliaItemCode() {
            $DummyObtenerFamiliaItemCode.FamiliaAcero.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("Familia_ItemCode", result);
            });
        };

        function ObtenerFamiliaItemCodeSteelgo() {
            $DummyObtenerFamiliaItemCodeSteelgo.FamiliaAcero.read({  token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("Familia_ItemCodeSteelgo", result);
            });
        };

        function ObtenerFabricanteColada() {
            $DummyFabricanteColada.DummyFabricante.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("Fabricante_Colada", result);
            });
        };

        function ObtenerAceroColada() {
            $DummyAceroColada.DummyAcero.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("Acero_Colada", result);
            });
        };

        function changeValueColumnColada(value) {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("Colada", value);
            });
        };

        function changeValueColumnCantidad(value) {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("Cantidad", value);
            });
        };

        function changeValueColumnMM(value) {
            //var allData = $("#grid").data("kendoGrid").dataSource.data();
            //var query = new kendo.data.Query(allData);
            //var result = query.data;
            //var datasource = result;
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                    this.set("MM", value);
                } else {
                    this.set("MM", "N/A");
                }
            });
        };

        function changeValueColumnMMNoAplica() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("MM", "N/A");
            });
            
        }

        function changeValueColumnsAll() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("Colada", $("#Colada").data("kendoComboBox").text());
                this.set("Cantidad", $("#Cantidad").val());
                if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                    this.set("MM", $("#MM").val());
                } else {
                    this.set("MM", "N/A");
                }
            });
        }

        function changeValueColumnsClear() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;

            $(datasource).each(function () {
                this.set("Colada", "");
                this.set("Cantidad", "");
                if (TipoPackingList.TipoPackingListID == "1") {//TUBO
                    this.set("MM", "");
                } else {
                    this.set("MM", "N/A");
                }
            });
        }

        function limpiarfiltrosFolioAvisoEntrada() {
            $("#ProyectoID").data("kendoComboBox").dataSource.data([]);
            $("#ProyectoID").data("kendoComboBox").value("");
            $("#FolioCuantificacionID").data("kendoComboBox").dataSource.data([]);
            $("#FolioCuantificacionID").data("kendoComboBox").value("");
            $("#BultoID").val("");
            $("#PackingList").val("");
            $("#TipoPackingListID").data("kendoComboBox").value("");
            $("#TipoUsoID").data("kendoComboBox").value("");
            $("#grid").data("kendoGrid").dataSource.data([]);

            Cuantificacion = {};
            Proyecto = {};
            TipoPackingList = {};
            TipoUso = {};
            
        }
        function LimpiarColada() {
            $("#Colada").data("kendoComboBox").dataSource.data([]);
        }

        function ControlErroresObjetosComboBox(control, result) {
            if (Error(result)) {
                $("#" + control).data("kendoComboBox").dataSource.data(result);
            } else {
                $("#" + control).data("kendoComboBox").dataSource.data([]);
            };
        };

        function limpiarfiltrosFolioCuantificacion() {
            Proyecto = {};
            TipoPackingList = {};
            TipoUso = {};

            $("#ProyectoID").data("kendoComboBox").value("");
            $("#BultoID").val("");
            $("#PackingList").val("");
            $("#TipoPackingListID").data("kendoComboBox").value("");
            $("#TipoUsoID").data("kendoComboBox").value("");
            $("#grid").data("kendoGrid").dataSource.data([]);
            limpiarTituloFolio();
        }
        
        function cargarTituloFolio() {
            $("#divFolio").removeClass("hidden");
            $("#spanFolio").html(_folioCuantificacion);
        };

        function limpiarTituloFolio() {
            $("#divFolio").addClass("hidden");
            $("#spanFolio").html("");
        }

        function SaveAndFinish() {
            var j = 0, z = 0;
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.data;
            var datasource = result;
            //var filters = $("#grid").data("kendoGrid").dataSource.filter();
            //var allData = $("#grid").data("kendoGrid").dataSource.data();
            //var query = new kendo.data.Query(allData);
            //var result = query.filter(filters).data;
            //var datasource = result;
            var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

            ListadoCuantificacionIncompletos = [];
            ListadoCuantificacion = [];

            for (i = 0; i < datasource.length; i++) {
                var ItemCode = datasource[i].ItemCode;
                var BultoID = datasource[i].BultoID;
                var Descripcion = datasource[i].Descripcion;
                var D1 = datasource[i].D1;
                var D2 = datasource[i].D2;
                var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
                var Familia = datasource[i].Familia;
                var Cedula = datasource[i].Cedula;
                var TipoAcero = datasource[i].TipoAcero;
                var Colada = datasource[i].Colada;
                var Cantidad = datasource[i].Cantidad;
                var MM = !datasource[i].MM ? "N/A" : datasource[i].MM;
                var Detallar = datasource[i].Detallar;
                var TieneNU = datasource[i].TieneNU;
                var TieneError = datasource[i].TieneError;

                if (!TieneNU) {
                    if (ItemCode != "Bulto") {
                        if (!ItemCode || (!D1 && D1 != 0) || (!D2 && D2 != 0) || !ItemCodeSteelgo || !Colada || !Cantidad) { // informacion incompleta
                            datasource[i].TieneError = true;
                            ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true };
                            z++;
                        } else { // informacion completa
                            ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError };
                            j++;
                        }
                    } else {
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError };
                        j++;
                    }
                }
            }

            CargarDefaults();

            UpdateCuantificacion = { FolioAvisollegadaId: "", ProyectoID: "", FolioCuantificacionID: "", BultoID: "", PackingList: "", TipoPackingList: "", TipoUso: "" };
            UpdateCuantificacion.FolioAvisollegadaId = FolioAvisoEntrada.FolioAvisoEntradaID;
            UpdateCuantificacion.ProyectoID = Proyecto.ProyectoID;
            UpdateCuantificacion.FolioCuantificacionID = folioCuantificacionID;
            UpdateCuantificacion.BultoID = $("#BultoID").val();
            UpdateCuantificacion.PackingList = $("#PackingList").val();
            UpdateCuantificacion.TipoPackingList = TipoPackingList.TipoPackingListID;
            UpdateCuantificacion.TipoUso = TipoUso.TipoUsoID;

            var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
            Client.add('DummyListadoCuantificacion');
            var incompletos = false;
            var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";

            if (ListadoCuantificacionIncompletos) {
                incompletos = true;
                closed = false;
            }
            console.log("SaveAndnew" + JSON.stringify(ListadoCuantificacion));

            if (folioCuantificacionID != -1) {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.update({}, { cerrar: closed, incompletos: incompletos, FolioAvisollegadaId: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacionID: folioCuantificacionID, cuantificacion: JSON.stringify(ListadoCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.update");
                        llenarGrid(data, ListadoCuantificacionIncompletos);
                        ordenamientoGrid();
                        BotonAlta();
                        if (incompletos) {
                            displayMessage("notificationslabel0037", "", '1');
                        } else {
                            ocultarStatus();
                            cargarTituloFolio();
                            $("#Cuantificacion0077").show();
                        }
                    });
                });
            } else {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.create({}, { cerrar: closed, incompletos: incompletos, FolioAvisollegadaId: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacionID: folioCuantificacionID, cuantificacion: JSON.stringify(ListadoCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.create");
                        
                        llenarGrid(data, ListadoCuantificacionIncompletos);
                        ordenamientoGrid();
                        BotonAlta();
                        if (incompletos) {
                            displayMessage("notificationslabel0037", "", '1');
                        } else {
                            ocultarStatus();
                            cargarTituloFolio();
                            $("#Cuantificacion0077").show();
                        }
                    });
                });
            }
        }

        function FinishAndNew() {
            var j = 0, z = 0;
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.data;
            var datasource = result;
            //var filters = $("#grid").data("kendoGrid").dataSource.filter();
            //var allData = $("#grid").data("kendoGrid").dataSource.data();
            //var query = new kendo.data.Query(allData);
            //var result = query.filter(filters).data;
            //var datasource = result;
            var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

            ListadoCuantificacionIncompletos = [];
            ListadoCuantificacion = [];

            for (i = 0; i < datasource.length; i++) {
                var ItemCode = datasource[i].ItemCode;
                var BultoID = datasource[i].BultoID;
                var Descripcion = datasource[i].Descripcion;
                var D1 = datasource[i].D1;
                var D2 = datasource[i].D2;
                var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
                var Familia = datasource[i].Familia;
                var Cedula = datasource[i].Cedula;
                var TipoAcero = datasource[i].TipoAcero;
                var Colada = datasource[i].Colada;
                var Cantidad = datasource[i].Cantidad;
                var MM = !datasource[i].MM ? "N/A" : datasource[i].MM;
                var Detallar = datasource[i].Detallar;
                var TieneNU = datasource[i].TieneNU;
                var TieneError = datasource[i].TieneError;

                if (!TieneNU) {
                    if (ItemCode != "Bulto") {
                        if (!ItemCode || (!D1 && D1 != 0) || (!D2 && D2 != 0) || !ItemCodeSteelgo || !Colada || !Cantidad) { // informacion incompleta
                            datasource[i].TieneError = true;
                            ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true };
                            z++;
                        } else { // informacion completa
                            ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError };
                            j++;
                        }
                    } else {
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID:BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError };
                        j++;
                    }
                }
            }

            CargarDefaults();

            UpdateCuantificacion = { FolioAvisollegadaId: "", ProyectoID: "", FolioCuantificacionID: "", BultoID: "", PackingList: "", TipoPackingList: "", TipoUso: "" };
            UpdateCuantificacion.FolioAvisollegadaId = FolioAvisoEntrada.FolioAvisoEntradaID;
            UpdateCuantificacion.ProyectoID = Proyecto.ProyectoID;
            UpdateCuantificacion.FolioCuantificacionID = folioCuantificacionID;
            UpdateCuantificacion.BultoID = $("#BultoID").val();
            UpdateCuantificacion.PackingList = $("#PackingList").val();
            UpdateCuantificacion.TipoPackingList = TipoPackingList.TipoPackingListID;
            UpdateCuantificacion.TipoUso = TipoUso.TipoUsoID;

            var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
            Client.add('DummyListadoCuantificacion');
            var incompletos = false;
            var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";

            if (ListadoCuantificacionIncompletos) {
                incompletos = true;
                closed = false;
            }
            console.log("SaveAndnew" + JSON.stringify(ListadoCuantificacion));

            if (folioCuantificacionID != -1) {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.update({}, { cerrar: closed, incompletos: incompletos, FolioAvisollegadaId: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacionID: folioCuantificacionID, cuantificacion: JSON.stringify(ListadoCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.update");
                        llenarGrid(data, ListadoCuantificacionIncompletos);
                        ordenamientoGrid();
                        BotonAlta();
                        if (incompletos) {
                            displayMessage("notificationslabel0037", "", '1');
                        } else {
                           window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
                        }
                    });
                });
            } else {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.create({}, { cerrar: closed, incompletos: incompletos, FolioAvisollegadaId: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacionID: folioCuantificacionID, cuantificacion: JSON.stringify(ListadoCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.create");
                        llenarGrid(data, ListadoCuantificacionIncompletos);
                        ordenamientoGrid();
                        BotonAlta();
                        if (incompletos) {
                            displayMessage("notificationslabel0037", "", '1');
                        } else {
                            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
                        }
                    });
                });
            }
        }

        function SaveAndClose() {
            var j = 0, z = 0;
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.data;
            var datasource = result;
            //var filters = $("#grid").data("kendoGrid").dataSource.filter();            
            //var query = new kendo.data.Query(allData);
            //var result = query.filter(filters).data;
            //var datasource = result;
            var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
            var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

            ListadoCuantificacionIncompletos = [];
            ListadoCuantificacion = [];

            for (i = 0; i < datasource.length; i++) {
                var ItemCode = datasource[i].ItemCode;
                var BultoID = datasource[i].BultoID;
                var Descripcion = datasource[i].Descripcion;
                var D1 = datasource[i].D1;
                var D2 = datasource[i].D2;
                var ItemCodeSteelgo = datasource[i].ItemCodeSteelgo;
                var Familia = datasource[i].Familia;
                var Cedula = datasource[i].Cedula;
                var TipoAcero = datasource[i].TipoAcero;
                var Colada = datasource[i].Colada;
                var Cantidad = datasource[i].Cantidad;
                var MM = !datasource[i].MM ? "N/A" : datasource[i].MM;
                var Detallar = datasource[i].Detallar;
                var TieneNU = datasource[i].TieneNU;
                var TieneError = datasource[i].TieneError;

                if (!TieneNU) {
                    if (ItemCode != "Bulto") {
                        if (!ItemCode || (!D1 && D1 != 0) || (!D2 || D2 != 0) || !ItemCodeSteelgo || !Colada || !Cantidad) { // informacion incompleta
                            datasource[i].TieneError = true;
                            ListadoCuantificacionIncompletos[z] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: true };
                            z++;
                        } else { // informacion completa
                            ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError };
                            j++;
                        }
                    } else {
                        ListadoCuantificacion[j] = { ItemCode: ItemCode, BultoID: BultoID, Descripcion: Descripcion, D1: D1, D2: D2, ItemCodeSteelgo: ItemCodeSteelgo, Familia: Familia, Cedula: Cedula, TipoAcero: TipoAcero, Colada: Colada, Cantidad: Cantidad, MM: MM, Detallar: Detallar, TieneNU: TieneNU, TieneError: TieneError };
                        j++;
                    }
                }
            }

            CargarDefaults();

            UpdateCuantificacion = { FolioAvisollegadaId: "", ProyectoID: "", FolioCuantificacionID: "", BultoID: "", PackingList: "", TipoPackingList: "", TipoUso: "" };
            UpdateCuantificacion.FolioAvisollegadaId = FolioAvisoEntrada.FolioAvisoEntradaID;
            UpdateCuantificacion.ProyectoID = Proyecto.ProyectoID;
            UpdateCuantificacion.FolioCuantificacionID = Cuantificacion.FolioCuantificacionID;
            UpdateCuantificacion.BultoID = $("#BultoID").val();
            UpdateCuantificacion.PackingList = $("#PackingList").val();
            UpdateCuantificacion.TipoPackingList = TipoPackingList.TipoPackingListID;
            UpdateCuantificacion.TipoUso = TipoUso.TipoUsoID;

            var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
            Client.add('DummyListadoCuantificacion');
            var incompletos = false, closed = false;
            var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";

            if (ListadoCuantificacionIncompletos) {
                incompletos = true;
                closed = false;
            }

            if (folioCuantificacionID != -1) {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.update({}, { cerrar: closed, incompletos: incompletos, FolioAvisollegadaId: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacionID: Cuantificacion.FolioCuantificacionID, cuantificacion: JSON.stringify(ListadoCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.update");
                        if (Error(data)) {
                            llenarGrid(data, ListadoCuantificacionIncompletos);
                            ordenamientoGrid();
                            BotonEdicion();
                            if (incompletos) {
                                displayMessage("notificationslabel0037", "", '1');
                            } else {
                                ocultarStatus();
                                cargarTituloFolio();
                                $("#Cuantificacion0078").show();
                            }
                        }
                    });
                });
            } else {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.create({}, { cerrar: closed, incompletos: incompletos, FolioAvisollegadaId: FolioAvisoEntrada.FolioAvisoEntradaID, FolioCuantificacionID: Cuantificacion.FolioCuantificacionID, cuantificacion: JSON.stringify(ListadoCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.create");
                        if (Error(data)) {
                            llenarGrid(data, ListadoCuantificacionIncompletos);
                            ordenamientoGrid();
                            BotonAlta();
                            if (incompletos) {
                                displayMessage("notificationslabel0037", "", '1');
                            } else {
                                ocultarStatus();
                                cargarTituloFolio();
                                $("#Cuantificacion0078").show();
                            }
                        }
                    });
                });
            }
        }

       

        function SavePartially(guardarynuevo)
        {
                var incompletos = false;
                var allData = $("#grid").data("kendoGrid").dataSource.data();
                var query = new kendo.data.Query(allData);
                var result = query.data;
                var datasource = result;
                var folioAvisoEntradaID = FolioAvisoEntrada.FolioAvisoEntradaID ? FolioAvisoEntrada.FolioAvisoEntradaID : "-1";
                var folioCuantificacionID = Cuantificacion.FolioCuantificacionID ? Cuantificacion.FolioCuantificacionID : "-1";

                console.log(JSON.stringify(result));

                CargarDefaults();

                UpdateCuantificacion = { FolioAvisollegadaId: "", ProyectoID: "", FolioCuantificacionID: "", BultoID: "", PackingList: "", TipoPackingList: "", TipoUso: "" };
                UpdateCuantificacion.FolioAvisollegadaId = FolioAvisoEntrada.FolioAvisoEntradaID;
                UpdateCuantificacion.ProyectoID = Proyecto.ProyectoID;
                UpdateCuantificacion.FolioCuantificacionID = folioCuantificacionID;
                UpdateCuantificacion.BultoID = $("#BultoID").val();
                UpdateCuantificacion.PackingList = $("#PackingList").val();
                UpdateCuantificacion.TipoPackingList = TipoPackingList.TipoPackingListID;
                UpdateCuantificacion.TipoUso = TipoUso.TipoUsoID;

                var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
                Client.add('DummyListadoCuantificacion');

                if (folioCuantificacionID != -1) {

                    $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.update({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                        _folioCuantificacion = data;

                        Client.DummyListadoCuantificacion.update({}, { cerrar: false, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: folioCuantificacionID, cuantificacion: JSON.stringify(result), token: Cookies.get("token") }).done(function (data) {
                            if (Error(data)) {
                                displayMessage("notificationslabel0038", '', '0');
                                BotonEdicion();
                                if (guardarynuevo) {
                                    var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";
                                    window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
                                }
                                ocultarStatus();
                                cargarTituloFolio();
                                $("#Cuantificacion0076").show();
                        }
                    });
                });
            } else {
                $DummyGuardarFolioLlegadaCuantificacion.DummyGuardarFolioLlegadaCuantificacion.create({}, { data: JSON.stringify(UpdateCuantificacion), token: Cookies.get("token") }).done(function (data) {
                    _folioCuantificacion = data;
                    Client.DummyListadoCuantificacion.create({}, { cerrar: false, incompletos: incompletos, FolioAvisollegadaId: folioAvisoEntradaID, FolioCuantificacionID: folioCuantificacionID, cuantificacion: JSON.stringify(result), token: Cookies.get("token") }).done(function (data) {
                        console.log("DummyListadoCuantificacion.create");
                        if (Error(data)) {
                            displayMessage("notificationslabel0038", '', '0');
                            BotonAlta();
                            if (guardarynuevo) {
                                var detalleIdeaUrl = "@Url.Action("Cuantificacion", "Cuantificacion")";
                                window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
                            }
                            ocultarStatus();
                            cargarTituloFolio();
                            $("#Cuantificacion0076").show();
                        }
                    });
                });
            };
        }
     



        function llenarGrid(dataJson, incompletos) {
            $("#grid").data("kendoGrid").dataSource.data([]);
            $.each(dataJson, function (key) {
                var item =
                       { ItemCode: dataJson[key].ItemCode, BultoID: dataJson[key].BultoID, Descripcion: dataJson[key].Descripcion, D1: dataJson[key].D1, D2: dataJson[key].D2, ItemCodeSteelgo: dataJson[key].ItemCodeSteelgo, Familia: dataJson[key].Familia, Cedula: dataJson[key].Cedula, TipoAcero: dataJson[key].TipoAcero, Colada: dataJson[key].Colada, Cantidad: dataJson[key].Cantidad, MM: dataJson[key].MM, Detallar: dataJson[key].Detallar, TieneNU: dataJson[key].TieneNU, TieneError: dataJson[key].TieneError };
                $("#grid").data("kendoGrid").dataSource.insert(item);
            });

            $.each(incompletos, function (key) {
                var item =
                       { ItemCode: incompletos[key].ItemCode, BultoID: dataJson[key].BultoID, Descripcion: incompletos[key].Descripcion, D1: incompletos[key].D1, D2: incompletos[key].D2, ItemCodeSteelgo: incompletos[key].ItemCodeSteelgo, Familia: incompletos[key].Familia, Cedula: incompletos[key].Cedula, TipoAcero: incompletos[key].TipoAcero, Colada: incompletos[key].Colada, Cantidad: incompletos[key].Cantidad, MM: dataJson[key].MM, Detallar: incompletos[key].Detallar, TieneNU: incompletos[key].TieneNU, TieneError: incompletos[key].TieneError };
                $("#grid").data("kendoGrid").dataSource.insert(item);
            });
        };

        function ordenamientoGrid() {
            var dsSort = [];
            dsSort.push({ field: "TieneError", dir: "desc" });
            $("#grid").data('kendoGrid').dataSource.sort(dsSort);
            $('#grid').data('kendoGrid').refresh();

            var grid = $("#grid").data("kendoGrid");
            var gridData = grid.dataSource.view();

            for (var i = 0; i < gridData.length; i++) {
                if (gridData[i].TieneError == true) {
                    grid.table.find("tr[data-uid='" + gridData[i].uid + "']").css("background-color", "red");
                }
            }
        };

        //function guardadoParcial() {
        //    var filters = $("#grid").data("kendoGrid").dataSource.filter();
        //    var allData = $("#grid").data("kendoGrid").dataSource.data();
        //    var query = new kendo.data.Query(allData);
        //    var result = query.filter(filters).data;
        //    var foliollegadaID = FolioLlegada.length > 0 ? FolioLlegada[0].FolioLlegadaID : "";
        //    var proyectoID = Proyecto.length > 0 ? Proyecto[0].ProyectoID : "";

        //    console.log(JSON.stringify(result));

        //    if ($("#PackingList").val()) {
        //        var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
        //        Client.add('DummyListadoCuantificacion');

        //        Client.DummyListadoCuantificacion.update({}, { foliollegadaid: foliollegadaID, proyectoid: proyectoID, packingList: $("#PackingList").val(), cuantificacion: JSON.stringify(result), username: Cookies.get("user"), token: Cookies.get("token") }).done(function (data) {
        //            console.log("DummyListadoCuantificacion.update");
        //            $("#grid").data("kendoGrid").dataSource.data(data);
        //            ordenamientoGrid();
        //        });
        //    } else {
        //        var ClientPackingList = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
        //        ClientPackingList.add('DummyPackingList');

        //        ClientPackingList.DummyPackingList.create({}, { foliollegadaid: foliollegadaID, proyectoid: proyectoID, username: Cookies.get("user"), token: Cookies.get("token") }).done(function (data) {
        //            console.log("DummyPackingList");
        //            $("#PackingList").val(data.PackingListID);

        //            var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
        //            Client.add('DummyListadoCuantificacion');

        //            Client.DummyListadoCuantificacion.create({}, { foliollegadaid: foliollegadaID, proyectoid: proyectoID, cuantificacion: JSON.stringify(result), username: Cookies.get("user"), token: Cookies.get("token") }).done(function (data) {
        //                console.log("DummyListadoCuantificacion.create");
        //                $("#grid").data("kendoGrid").dataSource.data(data);
        //                ordenamientoGrid();
        //            });
        //        });
        //    };

        //};

        function cargarGridPackingList() {
            $CargarGridCuantificacion.CargarGridCuantificacion.read({}, { token: Cookies.get("token"), folioCuantificacion: Cuantificacion.FolioCuantificacionID, bultoID: $("#BultoID").val() }).done(function (result) {
                if (Error(result)) {
                    if ($("#grid").data("kendoGrid")) {
                        if (data.CuantificacionListado.length > 0) {
                            $("#grid").data("kendoGrid").dataSource.data(data.CuantificacionListado);
                            if (TipoPackingList.TipoPackingListID == "2") {
                                changeValueColumnMMNoAplica();
                            }
                        } else {
                            $("#grid").data("kendoGrid").dataSource.data([]);
                        };
                    };
                }
            });
        };

        

        function cargarItemCodeAutocomplete(value) {
            $DummyItemCode.DummyItemCode.read({}, { TipoPackingListID: TipoPackingList.TipoPackingListID, token: Cookies.get("token") }).done(function (data) {
                console.log(data);
                itemCodesJson = data;

                $.each(itemCodesJson, function (index) {
                    if (itemCodesJson[index].ItemCodeID == value) {
                        lastEditedCellID.ItemCode = itemCodesJson[index].Codigo;
                        lastEditedCellID.Descripcion = itemCodesJson[index].Descripcion;
                        lastEditedCellID.D1 = itemCodesJson[index].D1;
                        lastEditedCellID.D2 = itemCodesJson[index].D2;
                        lastEditedCellID.ItemCodeSteelgo = itemCodesJson[index].ItemCodeSteelgoID;
                        lastEditedCellID.Colada = itemCodesJson[index].Colada;
                        lastEditedCellID.Detallar = value == 0 ? "Si" : "No";
                    };
                });
                $('#grid').data('kendoGrid').refresh();
            });
        };

        function cargarItemCodeSteelgoAutocomplete(value,ItemCode) {
            $DummyItemCodeSteelgo.DummyItemCodeSteelgo.read({}, { ItemCode: ItemCode, token: Cookies.get("token") }).done(function (data) {
                console.log(data);
                itemCodesJsonSteelgo = data;

                $.each(itemCodesJsonSteelgo, function (index) {
                    if (itemCodesJsonSteelgo[index].ItemCodeID == value) {
                        lastEditedCellIDSteelgo.ItemCodeSteelgo = itemCodesJsonSteelgo[index].Codigo;
                        lastEditedCellIDSteelgo.Familia = itemCodesJsonSteelgo[index].Familia;
                        lastEditedCellIDSteelgo.Cedula = itemCodesJsonSteelgo[index].Cedula;
                        lastEditedCellIDSteelgo.TipoAcero = itemCodesJsonSteelgo[index].TipoAcero;
                    }
                });
                $('#grid').data('kendoGrid').refresh();

            });
        };

        function itemCodeAutocomplete(container, options) {
            $('<input required data-text-field="Codigo" data-value-field="ItemCodeID" data-bind="value:' + options.field + '"/>')
                .appendTo(container)
                .kendoComboBox({
                    autoBind: false,
                    dataTextField: "Codigo",
                    dataValueField: "ItemCodeID",
                    dataSource: {
                        type: "json",
                        transport: {
                            read: $ComboDummyItemCode + "TipoPackingListID=" + TipoPackingList.TipoPackingListID + "&token=" + Cookies.get("token")
                        },
                        serverPaging: true,
                        serverFiltering: true
                    },
                    filter: "contains",
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        if (dataItem.ItemCodeID == -1) {
                            VentanaModal(1);
                            e.preventDefault();
                        }
                    },
                    change: function (e) {
                        var value = this.value();
                        if (_bultoID != "-1" && value == 0) {
                            displayMessage("notificationslabel0043", "", '1');
                            lastEditedCellID.ItemCode = "";
                            lastEditedCellID.Descripcion = "";
                            lastEditedCellID.D1 = 0;
                            lastEditedCellID.D2 = 0;
                            lastEditedCellID.ItemCodeSteelgo = "";
                            lastEditedCellID.Colada = "";
                            lastEditedCellID.Detallar = "No";
                            $('#grid').data('kendoGrid').refresh();
                        }
                        else {
                            cargarItemCodeAutocomplete(value);
                        }
                        
                    }
                });
            lastEditedCellID = options.model;
        };


        function itemCodeSteelgoAutocomplete(container, options) {
            $('<input required data-text-field="Codigo" data-value-field="ItemCodeID" data-bind="value:' + options.field + '"/>')
                .appendTo(container)
                .kendoComboBox({
                    autoBind: false,
                    dataTextField: "Codigo",
                    dataValueField: "ItemCodeID",
                    dataSource: {
                        type: "json",
                        transport: {
                            read: $ComboDummyItemCodeSteelgo + "?token=" + Cookies.get("token")
                            //read: $ComboDummyItemCodeSteelgo + container.parent().children()[0].innerText + "&token=" + Cookies.get("token")
                        },
                        serverPaging: true,
                        serverFiltering: true
                    },
                    filter: "contains",
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        if (dataItem.ItemCodeID == -1) {
                            VentanaModal(2);
                            e.preventDefault();
                        }
                    },
                    change: function (e) {
                        var value = this.value();
                        cargarItemCodeSteelgoAutocomplete(value,container.parent().children()[0].innerText);

                      
                    }
                });
            lastEditedCellIDSteelgo = options.model;
        };

        //function cargarColadaAutocomplete() {
        //    var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
        //    Client.add('DummyTipoAcero');

        //    Client.DummyTipoAcero.read({}, {  familiaAcero:"", proyectoid: "",token: Cookies.get("token") }).done(function (data) {
        //        console.log("DummyTipoAcero="+ data);
        //        tipoAceroJson = data;
        //    });
        //};
        
        function ColadaAutocomplete(container, options) {
            container.empty();
            prueba = $('<input required data-text-field="Nomenclatura" data-value-field="AceroID" data-bind="value:' + options.field + '"/>');
            
            $('<input required data-text-field="Nomenclatura" data-value-field="AceroID" data-bind="value:' + options.field + '"/>')
                .appendTo(container)
                .kendoComboBox({
                    autoBind: false,
                    dataTextField: "Nomenclatura",
                    dataValueField: "AceroID",
                    dataSource: {
                        type: "json",
                        transport: {
                            read: $DummyTipoAcero + "token=" + Cookies.get("token")
                            //read: $DummyTipoAcero + container.parent().children()[5].innerText + "&proyectoid=" + Proyecto.ProyectoID + "&token=" + Cookies.get("token")
                        },
                        serverPaging: true,
                        serverFiltering: true
                    },
                    select: function (e) {
                        var dataItem = this.dataItem(e.item.index());
                        if (dataItem.AceroID == -1) {
                            VentanaModal(3);
                            e.preventDefault();
                        }
                    },
                    change: function (e) {
                        var value = this.text();
                        lastEditedCellIDSColada.Colada = value;
                        $('#grid').data('kendoGrid').refresh();
                    },
                    filter: "contains",
                });

            lastEditedCellIDSColada = options.model;
        };
        
        function browserSupportFileUpload() {
            var isCompatible = false;
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                isCompatible = true;
            }
            return isCompatible;
        };

        function upload(evt) {
            if (!(/\.(csv)$/i).test(evt.target.files[0].name)) {
                displayMessage("notificationslabel0018", "", '1');
                event.preventDefault();
            } else {
                if (!browserSupportFileUpload()) {
                    displayMessage("notificationslabel0019", "", '1');
                } else {
                    var dataJson = null;
                    var file = evt.target.files[0];
                    var reader = new FileReader();
                    reader.readAsText(file);

                    reader.onload = function (event) {
                        var csvData = event.target.result;
                        dataJson = $.parseJSON(csvJSON(csvData));

                        if (dataJson && dataJson.length > 0) {
                            $.each(dataJson, function (key) {
                                var item =
                                       { ItemCode: dataJson[key].ItemCode, Descripcion: dataJson[key].Descripcion, D1: dataJson[key].D1, D2: dataJson[key].D2, ItemCodeSteelgo: dataJson[key].ItemCodeSteelgo, Familia: dataJson[key].Familia, Cedula: dataJson[key].Cedula, TipoAcero: dataJson[key].TipoAcero, Colada: dataJson[key].Colada, Cantidad: dataJson[key].Cantidad, MM: dataJson[key].MM, Detallar: dataJson[key].Detallar, TieneNU: false, TieneError: false };
                                $("#grid").data("kendoGrid").dataSource.insert(item);
                            });
                            document.getElementById('txtFileUpload').addEventListener('change', upload, false);
                        } else {
                            displayMessage("notificationslabel0020", "", '1');
                        }
                    };
                    reader.onerror = function () {
                        displayMessage("notificationslabel0021", file.fileName, '1');
                    };
                }
            }
        };
       

        function Error(data) {
            if (data.ReturnCode) {
                if (data.ReturnCode != 200) {
                    if (data.ReturnCode == 401) {
                        removeUserSession();
                        return true;
                    } else {
                        displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                        return false;
                    }
                } else {
                    return true;
                }
            } else {
                return true;
            }
        };


        }

        function imprimirEtiquetas() {
            var filters = $("#grid").data("kendoGrid").dataSource.filter();
            var allData = $("#grid").data("kendoGrid").dataSource.data();
            var query = new kendo.data.Query(allData);
            var result = query.filter(filters).data;
            var datasource = result;
            var _tieneNU = false;
            var strItemCodes = "";
            var x = 0;
            for (i = 0; i < datasource.length; i++) {
                if (datasource[i].TieneNU) {
                    _tieneNU = true;
                    if (x == 0) {
                        strItemCodes = datasource[i].ItemCode;
                    } else {
                        strItemCodes += "," + datasource[i].ItemCode;
                    }
                    x++;
                };
       
            };

            if (_tieneNU) {
                Cookies.set("ItemCodes", strItemCodes, {path: '/'});
                window.open("@Url.Action("FormatoEtiquetas", "Cuantificacion")");
            } else {
                displayMessage("notificationslabel0022", "", '1');
                return;
            }

        };
        function csvJSON(csv) {
            var lines = csv.split("\n");
            var result = [];
            var headers = lines[0].split(",");
            for (var i = 1; i < lines.length - 1; i++) 
            {
                var obj = {};
                var currentline = lines[i].split(",");

                for (var j = 0; j < headers.length; j++) {
                    if (headers[j] == "D1" || headers[j] == "D2" || headers[j] == "Cantidad" ) {
                        obj[headers[j]] = Number(currentline[j]);
                    } else {
                        if (headers[j] == "TieneError" || headers[j] == "TieneNU") {
                            obj[headers[j]] = currentline[j] == "True" ? true : false;
                        } else {
                            obj[headers[j]] = currentline[j];
                        }
                    }
            
                }

                result.push(obj);
            };

            return JSON.stringify(result);
        };
    

        function CargarDefaults() {
            $("#formCuantificacion :not(.security_required)").each(function (i, elem) {
                if (elem.tagName.toLowerCase() != 'label') {
                    switch ($(elem).attr("id")) {
                        case 'ProyectoID':
                            if (!$("#ProyectoID").data("kendoComboBox").value().length > 0) {
                                CargarProyecto(1, "");
                            }
                            break;
                        case 'TipoUsoID':
                            if (!$("#TipoUsoID").data("kendoComboBox").value().length > 0) {
                                CargarTipoUso(1, "");
                            }
                            break;
                    };
                };
            });
        };
        @section JavascriptDocumentReadyFunctions 
        {
            cargaInicial();

            //detallar un bulto
            if (_detalleBulto!="-1") {
                cargaInicialEdicionDetalleBulto();
            }

            //edicion de un folio cuantificacion
            if (_edicion != "-1") {
                cargaInicialEdicion();
            };
            
           

            $("#massiveUpload").click( function () {
                $("#txtFileUpload").click();
            });

            $authorizationModel["Cuantificacion"] = $CuantificacionModel;
            $authorizationModel["Item Code"] = $ItemCodeModel;
            $authorizationModel["Item Code Steelgo"] = $ItemCodeSteelgoModel;
            $authorizationModel["Colada"] = $ColadaModel
            
    }

    @section JavascriptDocumentReadyHomeCookie {
        Cookies.set("home", true, { path: '/' });
        Cookies.set("navegacion", "12", { path: '/' });
    } 
</script>
