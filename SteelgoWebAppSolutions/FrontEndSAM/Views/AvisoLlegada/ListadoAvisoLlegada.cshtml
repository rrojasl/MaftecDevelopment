@{
    ViewBag.Title = "Listado - Aviso Llegada";
}

@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="ListadoAvisoLlegada0020"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("ListadoAvisoLlegada", "AvisoLlegada")"><span id="ListadoAvisoLlegada0021"></span></a>
    </li>
}
<button id="btnCreados"><span id="ListadoAvisoLlegada0022"></span><span id="spanCreados"></span></button>
<button id="btnSinPermiso"><span id="ListadoAvisoLlegada0023"></span><span id="spanSinPermiso"></span></button>
<button id="btnSinAutorizacion"><span id="ListadoAvisoLlegada0024"></span><span id="spanSinAutorizacion"></span></button>
<button id="btnCompletos"><span id="ListadoAvisoLlegada0025"></span><span id="spanCompletos"></span></button>

<div class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="row">
        <div class="col-sm-12 col-md-12 col-lg-10 filterStretch">
            <div class="row">
                <div class="form-group col-sm-6 col-md-6 col-lg-3">
                    <label id="ListadoAvisoLlegada0026"></label>
                    <input id="ClienteID" class="" />
                </div>
                <div class="form-group col-sm-6 col-md-6 col-lg-3">
                    <label id="ListadoAvisoLlegada0003"></label>
                    <input id="PatioID" class="" />
                </div>
                @*<div class="form-group col-sm-6 col-md-6 col-lg-3">
                    <label id="ListadoAvisoLlegada0004" class=""></label>
                    <input id="ProyectoID" class="" />
                </div>*@
                @*<div class="form-group col-sm-4 col-md-4 col-lg-2">
                    <label id="ListadoAvisoLlegada0002"></label>
                    <input id="FolioAvisoLlegadaID" class="" />
                </div>*@
                <div class="form-group col-sm-4 col-md-4 col-lg-2">
                    <label id="ListadoAvisoLlegada0006"></label>
                    <input id="FechaInicial" class="" />
                </div>
                <div class="form-group col-sm-4 col-md-4 col-lg-2">
                    <label id="ListadoAvisoLlegada0007"></label>
                    <input id="FechaFinal" class="" />
                </div>
            </div>
        </div>
        @*<div class="col-sm-12 col-md-4 col-lg-3 filters">
            <div class="row">
                <div class="form-group col-sm-6 col-md-12 col-lg-6">
                    <label id="ListadoAvisoLlegada0005"></label>
                    <input id="ProveedorID" class="" />
                </div>
            </div>
        </div>*@
        <div class="col-sm-12 col-md-12 col-lg-2 filterBtns">
            <div class="row">
                <div class="form-group buttonBar col-sm-12 col-md-12 col-lg-12">
                    <a id="Mostrar" href="javascript:void(0);" class="btn btn-yellow">
                        <span id="ListadoAvisoLlegada0017"></span>
                    </a>
                    <a id="Creacion" href="javascript:void(0);" class="btn btn-primary"></a>
                    @*<a id="Refrescar" href="javascript:void(0);" class="btn btn-primary"></a>*@
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row">
                <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    @*<div class="branchCut"></div>*@
                    <div id="grid"></div>
                </div>
            </div>
        </div>

        <div id="window">
            @*Content of the Window*@
        </div>
    </div>
</div>

<input id="hdAccionFiltrado" type="hidden" />

<script>

    @section JavascriptDocumentReadyHomeCookie {
    Cookies.set("home", true, {path: '/'});
    Cookies.set("navegacion", "3", { path: '/' });
    }

    @section JavascriptGlobalVariables {
        //your partial views variables
        var Transportista = [], Proveedor = [], Patio = [], Folio = [], Cliente = {};
        var FechaInicial, FechaFinal, resultadoJson;
        var folioLlegadaID = getUrlParameter("folioLlegadaID", "-1");
        var folioEntradaID = getUrlParameter("folioEntradaID", "-1");
        //vars Dashboard
        var DashBoardAccionListado = getUrlParameter("DashBoardAccionListado", "-1");
        var DashPatioID = getUrlParameter("DashPatioID", "-1");
        var DashClienteID = getUrlParameter("DashClienteID", "-1");
        var DashFechaInicial = getUrlParameter("DashFechaInicial", "-1");
        var DashFechaFinal = getUrlParameter("DashFechaFinal", "-1");

        alert("DashBoardAccionListado=" + DashBoardAccionListado + ", DashPatioID=" + DashPatioID + " , DashClienteID=" + DashClienteID + " , DashFechaInicial=" + DashFechaInicial + " , DashFechaFinal=" + DashFechaFinal);

        var $AvisoLLegadaModel = {
            listContainer: {
                create: "#Creacion",
                list: "#grid",
                detail: ".detailLink",
                destroy: ".k-grid-Cancelar"
            },
            properties: {
                username: {
                    visible: "",
                    editable: "",
                    required: ""
                }
            }
        };
    }

    @section JavascriptGlobalFunctions {        
        //Your partial views specific functions
        function changeDatePickerDateFormat(datePickerOptions) {
            FechaInicial.setOptions(datePickerOptions);
            FechaFinal.setOptions(datePickerOptions);
        };

        function changeLanguageCall() {
            CargarGridAvisoLlegada();            
        }

        function CargarGridAvisoLlegada()
        {
            $("#grid").kendoGrid({
                dataSource: {
                    data: resultadoJson,
                    schema: {
                        model: {
                            fields: {
                                FolioAvisoLlegadaID: { type: "string" },
                                Patio: { type:"string" },
                                NombreProyecto: { type: "string" },
                                Transportista: { type: "string" },
                                FechaRecepcion: { type: "string"},
                                Estatus: { type: "string"}
                            }
                        }
                    },
                    pageSize: 10,
                    serverPaging: false,
                    serverFiltering: false,
                    serverSorting: false
                },
                autoHeight: true,
                sortable: true,
                scrollable: false,
                filterable: true,
                pageable: {
                    refresh: false,
                    pageSizes: [10, 15, 20],
                    info: false,
                    input: true,
                    numeric: false,
                    messages: {
                        page: "",
                        of: _dictionary.ListadoAvisoLlegada0018[$("#language").data("kendoDropDownList").value()],
                        itemsPerPage: _dictionary.ListadoAvisoLlegada0019[$("#language").data("kendoDropDownList").value()],
                    }
                },               
                columns: [
                    { field: "FolioAvisoLlegadaID", title: _dictionary.ListadoAvisoLlegada0008[$("#language").data("kendoDropDownList").value()], template: "<a class='detailLink' onclick='mostrarDetalle(#:FolioAvisoLlegadaID#)'>#:FolioAvisoLlegadaID#</a>", filterable: true },
                    { field: "Patio", title: _dictionary.ListadoAvisoLlegada0009[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "NombreProyecto", title: _dictionary.ListadoAvisoLlegada0010[$("#language").data("kendoDropDownList").value()], filterable: true },                   
                    { field: "Transportista", title: _dictionary.ListadoAvisoLlegada0012[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "FechaRecepcion", title: _dictionary.ListadoAvisoLlegada0013[$("#language").data("kendoDropDownList").value()], filterable: true },
                    { field: "Estatus", title: _dictionary.ListadoAvisoLlegada0014[$("#language").data("kendoDropDownList").value()], filterable: true },                    
                    { command: { text: _dictionary.ListadoAvisoLlegada0016[$("#language").data("kendoDropDownList").value()], click: cancelarFolio }, title: " ", width: "40px" }
                ],
                dataBound: function (e) {
                    $(".k-grid input.k-textbox").prop( 'readonly' , true);                    
                    $(".k-grid td .k-button").text(''); 
                    $(".k-grid td:first-child, .k-grid td:last-child").css('text-overflow', 'clip');                                                       
                }
            });                                
        }

        function mostrarDetalle(folioAvisoLlegadaID)
        {
            //e.preventDefault();
            //var dataItem = $("#grid").data("kendoGrid").dataItem($(e.currentTarget).closest("tr"));
            //var folioAvisoLlegadaID = dataItem.FolioAvisoLlegadaID
            //REDIRECT
            var detalleIdeaUrl = "@Url.Action("DetalleAvisoLLegada", "AvisoLLegada")";
            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value() + "&folio=" + folioAvisoLlegadaID;
        }

        function cancelarFolio(e)
        {
            e.preventDefault();
            var dataItem = $("#grid").data("kendoGrid").dataItem($(e.currentTarget).closest("tr"));
            var folioAvisoLlegadaID = dataItem.FolioAvisoLlegadaID
            var dataSource = $("#grid").data("kendoGrid").dataSource;
            var foliovalido = true;

            var Client = new $.RestClient('http://localhost:60960' + '/backendsam/api/');
            Client.add('DummyVerificarCancelacion');

            Client.DummyVerificarCancelacion.read({}, { folio: folioAvisoLlegadaID, username: Cookies.get("user"), token: Cookies.get("token") }).done(function (data) {
                foliovalido = data;
                if (foliovalido) {
                    if (confirm("Estas seguro de cancelar el folio de entrada?")) {
                        //aki debe estar el de filtros()
                        var Client = new $.RestClient('http://localhost:60960' + '/backendsam/api/');
                        Client.add('DummyCancelacionListadoAvisoLlegada');

                        Client.DummyCancelacionListadoAvisoLlegada.read({}, { folio: folioAvisoLlegadaID, username: Cookies.get("user"), token: Cookies.get("token") }).done(function (data) {
                            $("#grid").data("kendoGrid").dataSource.data(data);
                        });
                    };
                } else {
                    alert("El folio cuenta con permiso en tramite, permiso autorizado y/o pase de salida");
                };
            });
        };

        function ObtenerAccionesListado() {

            $("#spanCreados").html("(1)");
            $("#spanSinPermiso").html("(10)");
            $("#spanSinPermiso").html("(15)");
            $("#spanSinAutorizacion").html("(11)");
            $("#spanCompletos").html("(16)");
            
            
            //$FiltrosListadoEntradaMaterial.AvisoLlegada.read({}, { data: JSON.stringify(Listado) }).done(function (data) {
            //    if (data.ReturnCode) {
            //        if (data.ReturnCode == 401) {
            //            removeUserSession();
            //        } else {
            //            alert("ReturnMessage: " + data.ReturnMessage);
            //            return;
            //        }
            //    }

            //    $("#spanCreados").html("("+ data.Creados +")");
            //    $("#spanSinPermiso").html("(" + data.SinPermiso + ")");
            //    $("#spanSinAutorizacion").html("(" + data.SinAutorizacion + ")");
            //    $("#spanCompletos").html("(" + data.Completos + ")");
            //});
        };

        function CargarControlesFiltrado() { };
        function ObtenerFechasporDefecto() {
            var today = new Date();
            var fechainicio = new Date(today.getTime() - (7 * 24 * 3600 * 1000));

            $("#FechaInicial").data("kendoDatePicker").value(fechainicio.toLocaleDateString($("#language").data("kendoDropDownList").value()));
            $("#FechaFinal").data("kendoDatePicker").value(today.toLocaleDateString($("#language").data("kendoDropDownList").value()));
            $("#FechaInicial").kendoDatePicker({ footer: false });
            $("#FechaFinal").kendoDatePicker({ footer: false });
        };

        function CargarFolio(id) {
            Folio = [];
            _folio = {};
            _folio["FolioAvisoLlegadaID"] = id;
            Folio.push(_folio);
        };

        function CargarPatio(id, value) {
            Patio = [];
            _patio = {};
            _patio["PatioID"] = id;
            _patio["Nombre"] = value;
            Patio.push(_patio);
        };

        function CargarProveedor(id, value) {
            Proveedor = [];
            _proveedor = {};
            _proveedor["ProveedorID"] = id;
            _proveedor["Nombre"] = value;
            Proveedor.push(_proveedor);
        };

        function ObtenerProyectos() {
            $Proyecto.Proyecto.read({ token: Cookies.get("token") }).done(function (result) {
                if (result.ReturnCode) {
                    removeUserSession();
                } else {
                    $("#ProyectoID").data("kendoMultiSelect").dataSource.data(result);
                };
            });
        };

        function ObtenerProveedor() {
            $Proveedor.Proveedor.read({ esAvisoEntrada: 0, token: Cookies.get("token") }).done(function (result) {
                if (result.ReturnCode) {
                    removeUserSession();
                } else {
                    $("#ProveedorID").data("kendoAutoComplete").dataSource.data(result);
                };
            });
        };

        function ObtenerPatio() {
            $Patio.Patio.read({ esAvisoEntrada: 0, token: Cookies.get("token") }).done(function (result) {
                if (result.ReturnCode) {
                    removeUserSession();
                } else {
                    $("#PatioID").data("kendoAutoComplete").dataSource.data(result);
                };
            });
        };
        function ObtenerFolioEntradaMaterial() {
            $folioEntradaMaterial.Listado.read({ tipoListado: 1, token: Cookies.get("token") }).done(function (result) {
                if (result.ReturnCode) {
                    removeUserSession();
                } else {
                    $("#FolioAvisoLlegadaID").data("kendoAutoComplete").dataSource.data(result);
                };
            });
        };

        function ArregloListado(accion) {
            var Listado;
            Listado = { FolioLlegadaID: "", FolioAvisoLlegadaID: "", Patio: "", Cliente: "", FechaInicial: "", FechaFinal: "", token: "", Creados: "", SinPermiso: "", SinAutorizacion: "", Completos: "" };
            //ProyectoIDs = [];

            //var proyectos = $("#ProyectoID").data("kendoMultiSelect").value();
            //$.each(proyectos, function (index, value) {
            //    item = {};
            //    item["ProyectoID"] = value;
            //    ProyectoIDs.push(item);
            //});

            var d = new Date($("#FechaInicial").data("kendoDatePicker").value());
            var d1 = new Date($("#FechaFinal").data("kendoDatePicker").value());

            Listado.FolioLlegadaID = folioLlegadaID ? folioLlegadaID : -1;
            Listado.FolioAvisoLlegadaID = folioEntradaID ? folioEntradaID : -1;
            Listado.Patio = Patio;
            Listado.FechaInicial = obtenerFormatoFecha(d);
            Listado.FechaFinal = obtenerFormatoFecha(d1);
            Listado.Creados = accion == 1 ? true : false;
            Listado.SinPermiso = accion == 2 ? true : false;
            Listado.SinAutorizacion = accion == 3 ? true : false;
            Listado.Completos = accion == 4 ? true : false;
            Listado.Cliente = Cliente;
            Listado.token = Cookies.get("token");
            console.log(JSON.stringify(Listado));
            return Listado;
        };

        function AccionesListado(accion) {
            var Listado;
            Listado = ArregloListado(accion);

            $("#hdAccionFiltrado").val(accion);

            $FiltrosListadoEntradaMaterial.AvisoLlegada.read({}, { data: JSON.stringify(Listado) }).done(function (data) {
                if (data.ReturnCode) {
                    if (data.ReturnCode == 401) {
                        removeUserSession();
                    } else {
                        alert("ReturnMessage: " + data.ReturnMessage);
                        return;
                    }
                }

                resultadoJson = data;
                if ($("#grid").data("kendoGrid")) {
                    $("#grid").data("kendoGrid").dataSource.data(resultadoJson);
                };
            });
        };

        function Filtros(prueba) {
            var Listado;
            var accion = $("#hdAccionFiltrado").val() ? $("#hdAccionFiltrado").val() : 1;
            AccionesListado(accion);
        };

        function CargarCliente(id, value) {
            Cliente = {};
            Cliente = { ClienteID: id, Nombre: value };
        };

        function ObtenerCliente() {
            $Cliente.Cliente.read({ token: Cookies.get("token") }).done(function (result) {
                Error(result);
                $("#ClienteID").data("kendoAutoComplete").dataSource.data(result);

            });
        };

        function CargarControlesFiltrado() {

        };
    }

    @section JavascriptDocumentReadyFunctions {
    $authorizationModel["Aviso Entrada"] = $AvisoLLegadaModel;
        ObtenerAccionesListado();

        setTimeout(function () {
            console.log("prueba time out");
            ObtenerAccionesListado();
        }, 60000);



        //Botones Dashboard
        $("#btnCreados").click(function () { AccionesListado(1); });
        $("#btnSinPermiso").click(function () { AccionesListado(2); });
        $("#btnSinAutorizacion").click(function () { AccionesListado(3); });
        $("#btnCompletos").click(function () { AccionesListado(4); });

        $("#Mostrar").click(function () { Filtros(0); });
        $("#Creacion").click(function (e) {
            var detalleIdeaUrl = "@Url.Action("DetalleAvisoLLegada", "AvisoLLegada")";
            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
        });
    
        //$("#FolioAvisoLlegadaID").kendoAutoComplete({            
        //    dataTextField: "id",
        //    dataValueField: "value",
        //    select: function (e) {
        //        var dataItem = this.dataItem(e.item.index());
        //        CargarFolio(dataItem.id);
        //    },
        //    change: function (e) {
        //        var value = this.value();
        //        if (!value) {
        //            Folio = [];
        //        };
        //    },
        //    filter: "contains"
        //});
        //ObtenerFolioEntradaMaterial();

        $("#ClienteID").kendoAutoComplete({
            dataTextField: "Nombre",
            dataValueField: "ClienteID",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarCliente(dataItem.ClienteID, dataItem.Nombre);
            },
            change: function (e) {
                var value = this.value();
                if (!value) {
                    Cliente = [];
                };
            },
            filter: "contains",
        });
        ObtenerCliente();

        $("#PatioID").kendoAutoComplete({
            dataTextField: "Nombre",
            dataValueField: "PatioID",
            select: function (e) {
                var dataItem = this.dataItem(e.item.index());
                CargarPatio(dataItem.PatioID, dataItem.Nombre);
            },
            change: function(e) {
                var value = this.value();
                if (!value) {
                    Patio = [];
                };
            },
            filter: "contains",
        });
        ObtenerPatio();

        //$("#ProyectoID").kendoMultiSelect({
        //    dataTextField: "Nombre",
        //    dataValueField: "ProyectoID",
        //    filter: "contains",
        //});
        //ObtenerProyectos();
        FechaInicial = new kendo.ui.DatePicker($("#FechaInicial"));
        FechaFinal = new kendo.ui.DatePicker($("#FechaFinal"));

        ObtenerFechasporDefecto();

        if (folioLlegadaID != -1 && folioEntradaID != -1) {// viene de la llegada de material       
            Filtros(2);
        } else {
            if (DashBoardAccionListado != -1) {
                CargarControlesFiltrado();
                AccionesListado(DashBoardAccionListado);
            } else {
                Filtros(1);//default hoy menos 7 dias
            };
        };


        var autocomplete = $("#ClienteID").data("kendoAutoComplete");
        autocomplete.select(function (dataItem) {
            if (dataItem.Nombre == "Plana") {
                CargarTipoVehiculoPlana(dataItem.TipoVehiculoID, dataItem.Nombre);
                return dataItem.Nombre === "Plana";
            }
        });
    }


    function obtenerFormatoFecha(d) {
        var curr_date = d.getDate();
        var curr_month = d.getMonth() + 1; //Months are zero based
        var curr_year = d.getFullYear();

        return curr_year + "-" + curr_month + "-" + curr_date;
    };
</script>

