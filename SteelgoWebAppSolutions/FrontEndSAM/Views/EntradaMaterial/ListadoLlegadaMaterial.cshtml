@{
    ViewBag.Title = "Listado Llegada de Material";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="ListadoLlegadaMaterial0020"></span></a>
    </li>
    <li>
        <a href="@Url.Action("DashboardLlegadaMaterial", "EntradaMaterial")"><span id="ListadoLlegadaMaterial0019"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("ListadoLlegadaMaterial", "EntradaMaterial")"><span id="ListadoLlegadaMaterial0021"></span></a>
    </li>
}

<div class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="row">
        <div class="col-sm-12 col-md-12 col-lg-12">
            <div class="formNav filtersFields clearfix">
                <div class="row">
                    <div class="col-sm-2 col-md-2 col-lg-1">
                        <div class="button-section">
                            <button id="Nuevo" type="button" class="btn btn-yellow"><span id="ListadoLlegadaMaterial0001"></span></button>
                        </div>
                    </div>
                    <div class="col-sm-10 col-md-10 col-lg-9 filter-section">
                        <div class="row">
                            <div class="col-sm-6 col-md-6 col-lg-3">
                                <label id="ListadoLlegadaMaterial0002"></label>
                                <input id="PatioID" class="" />
                            </div>
                            <div class="col-sm-6 col-md-6 col-lg-3">
                                <label id="ListadoLlegadaMaterial0003"></label>
                                <input id="ClienteID" class="" />
                            </div>
                            <div class="col-sm-6 col-md-6 col-lg-3">
                                <label id="ListadoLlegadaMaterial0004"></label>
                                <input id="FechaInic" class="" />
                            </div>
                            <div class="col-sm-6 col-md-6 col-lg-3">
                                <label id="ListadoLlegadaMaterial0005"></label>
                                <input id="FechaFinal" class="" />
                            </div>
                            <div class="col-sm-6 col-md-6 col-lg-3">
                                <label id="ListadoLlegadaMaterial0006"></label>
                                <input id="PeriodoTiempo" class="" />
                            </div>
                        </div>
                    </div>
                    @*<div class="col-sm-12 col-md-12 col-lg-3 buttonBar">
                        <a id="Mostrar" href="javascript:void(0);" class="btn btn-yellow"><span id="ListadoLlegadaMaterial0005"></span></a>
                        <a id="Creacion" href="javascript:void(0);" class="btn btn-primary"></a>
                    </div>*@
                </div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="row">
                <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="row">
                        <div class="btn-group tabList col-xs-12 col-sm-12 col-md-12 col-lg-12" role="group" arial-label="tabList">
                            <button id="btnPorLlegar" class="btn btn-tabList"><span id="ListadoLlegadaMaterial0012"></span><span id="spanPorLlegar">0</span></button>
                            <button id="btnPorDescargar" class="btn btn-tabList"><span id="ListadoLlegadaMaterial0013"></span><span id="spanPorDescargar">0</span></button>
                            <button id="btnPorSalir" class="btn btn-tabList"><span id="ListadoLlegadaMaterial0014"></span><span id="spanPorSalir">0</span></button>

                        </div>
                    </div>
                    <div class="row">
                        <div id="filterContainer" class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <input id="FolioAvisoEntradaID" class="quickFilters arrivalMaterial" />
                            <input id="FechaCreacion" class="quickFilters arrivalMaterial" />
                            <input id="Patio" class="quickFilters arrivalMaterial " />
                            <input id="EstatusFolio" class="quickFilters arrivalMaterial" />
                            <input id="Cancel" class="quickFilters arrivalMaterial" disabled />
                        </div>
                    </div>
                    <div id="grid" class="entradaMaterial"></div>
                </div>
            </div>
        </div>
        <div id="window">
            @*Content of the Window*@
        </div>
    </div>
</div>

<script>

    @section JavascriptGlobalVariables 
    {
    var Patio = {}, Cliente = {}, PeriodoTiempo = {};

    var FechaInic, FechaFinal, resultadoJson;
    var folioLlegadaID = getUrlParameter("folioLlegadaID", "-1");
    var folioEntradaID = getUrlParameter("folioEntradaID", "-1");

    //vars Dashboard
    var DashBoardAccionListado = getUrlParameter("DashBoardAccionListado", "-1");
    var DashPatioID = getUrlParameter("DashPatioID", "-1");
    var DashClienteID = getUrlParameter("DashClienteID", "-1");
    var DashFechaInicial = getUrlParameter("DashFechaInicial", "-1");
    var DashFechaFinal = getUrlParameter("DashFechaFinal", "-1");


    }

    @section JavascriptGlobalFunctions 
    {

    function changeDatePickerDateFormat(datePickerOptions) {
        FechaInic.setOptions(datePickerOptions);
        FechaFinal.setOptions(datePickerOptions);
    };

    function changeLanguageCall() {
        CargarGridLlegadaMaterial();
    };


    function cargaInicial() {
        //Botones Dashboard
        $("#FolioAvisoEntradaID").val("");
        $("#FechaCreacion").val("");
        $("#Patio").val("");
        $("#EstatusFolio").val("");
        $("#Cancel").val("");

        $("#btnPorLlegar").click(function () { tabActivo("1"); AccionesListado(1); });
        $("#btnPorDescargar").click(function () { tabActivo("2"); AccionesListado(2); });
        $("#btnPorSalir").click(function () { tabActivo("3"); AccionesListado(3); });

        $("#Nuevo").click(function (e) {
            var detalleIdeaUrl = "@Url.Action("DetalleLlegadaMaterial", "EntradaMaterial")";
                window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
            });

            $("#FolioAvisoEntradaID").keyup(function () {
                var ds = $("#grid").data("kendoGrid").dataSource;
                ds.filter([
                    {
                        "field": "FolioAvisoEntrada",
                        "operator": "Contains",
                        "value": this.value
                    }
                ]);
            });

            $("#FechaCreacion").keyup(function () {
                var ds = $("#grid").data("kendoGrid").dataSource;
                ds.filter([
                    {
                        "field": "FechaCreacion",
                        "operator": "Contains",
                        "value": this.value
                    }
                ]);
            });

            $("#Patio").keyup(function () {
                var ds = $("#grid").data("kendoGrid").dataSource;
                ds.filter([
                    {
                        "field": "Patio",
                        "operator": "Contains",
                        "value": this.value
                    }
                ]);
            });

            $("#EstatusFolio").keyup(function () {
                var ds = $("#grid").data("kendoGrid").dataSource;
                ds.filter([
                    {
                        "field": "EstatusFolio",
                        "operator": "Contains",
                        "value": this.value
                    }
                ]);
            });

            $("#ClienteID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "ClienteID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarCliente(dataItem.ClienteID, dataItem.Nombre);

                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        Cliente = [];
                    }
                    Filtros();
                },
                filter: "contains",
            });
            ObtenerCliente();

            $("#PatioID").kendoComboBox({
                dataTextField: "Nombre",
                dataValueField: "PatioID",
                select: function (e) {
                    var dataItem = this.dataItem(e.item.index());
                    CargarPatio(dataItem.PatioID, dataItem.Nombre);
                },
                change: function (e) {
                    var value = this.value();
                    if (!value) {
                        Patio = [];
                    }
                    Filtros();
                },
                filter: "contains",
            });
            ObtenerPatio();

            FechaInic = new kendo.ui.DatePicker($("#FechaInic"));
            FechaFinal = new kendo.ui.DatePicker($("#FechaFinal"));


            $("#FechaInic").bind("change", function () {
                Filtros();
            });

            $("#FechaFinal").bind("change", function () {
                Filtros();
            });

            if (DashBoardAccionListado != -1) {
                tabActivo(DashBoardAccionListado);
                CargarControlesFiltrado();
                console.log("AccionesListado Inicio");
                AccionesListado(DashBoardAccionListado);
            } else {
                ObtenerFechasporDefecto();
                tabActivo(1);
                Filtros();
            }
            };


            function CargarGridLlegadaMaterial() {
                $("#grid").kendoGrid({
                    dataSource: {
                        data: resultadoJson,
                        schema: {
                            model: {
                                fields: {
                                    FolioAvisoEntrada: { type: "string" },
                                    FechaCreacion: { type: "date" },
                                    Patio: { type: "string" },
                                    EstatusFolio: { type: "string" },
                                }
                            }
                        },
                        pageSize: 20,
                        serverPaging: false,
                        serverFiltering: false,
                        serverSorting: false
                    },
                    autoHeight: true,
                    sortable: true,
                    scrollable: false,
                    filterable: {
                        extra: false,
                        operators: {
                            string: {
                                startswith: "Starts with",
                                eq: "Is equal to",
                                neq: "Is not equal to"
                            }
                        }
                    },
                    pageable: {
                        refresh: false,
                        pageSizes: [10, 15, 20],
                        info: false,
                        input: false,
                        numeric: true,
                    },
                    columns: [
                    /* Pendienteeeeeeee */
                        { field: "FolioAvisoEntrada", title: _dictionary.ListadoLlegadaMaterial0015[$("#language").data("kendoDropDownList").value()], template: "<a class='detailLink' onclick='mostrarDetalle(#:FolioAvisoEntrada#)'>#:PackingListID#</a>", filterable: true },
                        { field: "FechaCreacion", title: _dictionary.ListadoLlegadaMaterial0018[$("#language").data("kendoDropDownList").value()], filterable: true },
                        { field: "Patio", title: _dictionary.ListadoLlegadaMaterial0002[$("#language").data("kendoDropDownList").value()], filterable: true },
                        { field: "EstatusFolio", title: _dictionary.ListadoLlegadaMaterial0016[$("#language").data("kendoDropDownList").value()], filterable: true },
                        { command: { text: _dictionary.ListadoLlegadaMaterial0017[$("#language").data("kendoDropDownList").value()], click: cancelarFolio }, title: " ", width: "40px" }
                    ],
                    dataBound: function (e) {
                        $(".k-grid input.k-textbox").prop('readonly', true);
                        $(".k-grid td .k-button").text('');
                        $(".k-grid td:first-child, .k-grid td:last-child").css('text-overflow', 'clip');
                    }
                });
            };


            function mostrarDetalle(folioEntrada) {
                var detalleIdeaUrl = "@Url.Action("DetalleLlegadaMaterial", "EntradaMaterial")";
            window.location.href = detalleIdeaUrl + "?leng=" + $("#language").data("kendoDropDownList").value();
        }

        function cancelarFolio() {
            if (confirm("Estas seguro de cancelar el folio de llegada?")) {
                //aki debe estar el de filtros()
                var Client = new $.RestClient($BackEndSAMUri + '/backendsam/api/');
                Client.add('FolioAvisoEntrada');
                Client.FolioAvisoEntrada.destroy({}, { folio: FolioAvisoEntradaID, token: Cookies.get("token") }).done(function (data) {
                    Filtros();
                });

            } else {
                displayMessage("notificationslabel0016", "", '1');
                e.preventDefault();
            };

        };

        function ObtenerAccionesListado(Listado) {
            $folioEntradaMaterial.Listado.read({}, { data: JSON.stringify(Listado), token: Cookies.get("token"), parametroBusqueda: "" }).done(function (result) {
                Error(result);
                $("#spanPorLlegar").html(result.SinEstaus ? result.SinEstaus : 0);
                $("#spanPorDescargar").html(result.SinOrdenDescarga ? result.SinOrdenDescarga : 0);
                $("#spanPorSalir").html(result.SinPaseSalida ? result.SinPaseSalida : 0);
            });
        };

        function CargarFolio(id) {
            Folio = [];
            _folio = {};
            _folio["FolioAvisoEntradaID"] = id;
            Folio.push(_folio);
        };

        function CargarPatio(id, value) {
            Patio = [];
            _patio = {};
            _patio["PatioID"] = id;
            _patio["Nombre"] = value;
            Patio.push(_patio);
        };

        function CargarCliente(id, value) {
            Cliente = {};
            Cliente = { ClienteID: id };
        };

        function ObtenerPatio() {
            $Patio.Patio.read({ esAvisoEntrada: 0, token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("PatioID", result);
            });
        };

        function ObtenerCliente() {
            $Cliente.Cliente.read({ token: Cookies.get("token") }).done(function (result) {
                ControlErroresObjetosComboBox("ClienteID", result);
            });
        };

        function ArregloListado(accion) {
            var Listado;
            Listado = { FolioLlegadaID: "", FolioAvisoLlegadaID: "", PatioID: "", ClienteID: "", FechaInicial: "", FechaFinal: "", token: "", PorLlegar: "", PorDescargar: "", PorSalir: "" };

            var d = new Date($("#FechaInic").data("kendoDatePicker").value());
            var d1 = new Date($("#FechaFinal").data("kendoDatePicker").value());

            Listado.FolioLlegadaID = folioLlegadaID ? folioLlegadaID : -1;
            Listado.FolioAvisoLlegadaID = folioEntradaID ? folioEntradaID : -1;
            Listado.PatioID = $("#PatioID").data("kendoComboBox").value();
            Listado.FechaInicial = obtenerFormatoFecha(d);
            Listado.FechaFinal = obtenerFormatoFecha(d1);
            Listado.PorLlegar = accion == 1 ? true : false;
            Listado.PorDescargar = accion == 2 ? true : false;
            Listado.PorSalir = accion == 3 ? true : false;
            Listado.ClienteID = $("#ClienteID").data("kendoComboBox").value();
            Listado.token = Cookies.get("token");
            console.log(JSON.stringify(Listado));
            return Listado;
        };

        function AccionesListado(accion) {
            loadingStart();
            var Listado;
            Listado = ArregloListado(accion);

            $("#hdAccionFiltrado").val(accion);

            $FiltrosListadoLlegadaMaterial.FolioAvisoEntrada.read({}, { data: JSON.stringify(Listado) }).done(function (data) {
                console.log("data");
                console.log(data);
                console.log("Error " + Error(data));
                if (Error(data)) {
                    resultadoJson = data;
                    console.log("grid value " + $("#grid").data("kendoGrid"));
                    if ($("#grid").data("kendoGrid")) {
                        console.log("resultadoJson: " + resultadoJson.length);
                        if (resultadoJson.length > 0) {
                            $("#grid").data("kendoGrid").dataSource.data(resultadoJson);
                            $("#grid").data("kendoGrid").dataSource.page(1);
                        } else {
                            console.log("bindear empty inicio");
                            $("#grid").data("kendoGrid").dataSource.data([]);
                            $("#grid").data("kendoGrid").dataSource.page(0);
                            console.log("bindear empty fin");
                        };
                        CantidadesDelMenuDashboard();
                        applySecurityPolicy(false);
                    };
                };

                loadingStop();
                console.log("AccionesListado fin");
            });
        };

        function Filtros() {
            var Listado;
            var accion = $("#hdAccionFiltrado").val() ? $("#hdAccionFiltrado").val() : 1;
            console.log(accion);
            AccionesListado(accion);
        };

        function CargarControlesFiltrado() {
            console.log("CargarControlesFiltrado inicio");
            var date, format;
            if ($("#language").data("kendoDropDownList").value() == "es-MX") {
                format = "dd/MM/yyyy";
            } else {
                format = "MM/dd/yyyy";
            };
            var splitYear = DashFechaInicial.split("-")[0];
            var splitMonth = DashFechaInicial.split("-")[1];
            var splitDay = DashFechaInicial.split("-")[2];

            var splitYear2 = DashFechaFinal.split("-")[0];
            var splitMonth2 = DashFechaFinal.split("-")[1];
            var splitDay2 = DashFechaFinal.split("-")[2];

            var fechaInicial = new Date(splitYear, splitMonth - 1, splitDay);
            var fechFinal = new Date(splitYear2, splitMonth2 - 1, splitDay2);

            var fechaInicialkendo = kendo.parseDate(fechaInicial, format);
            var fechaFinalkendo = kendo.parseDate(fechFinal, format);

            $("#ClienteID").data("kendoComboBox").value(DashClienteID);
            $("#PatioID").data("kendoComboBox").value(DashPatioID);
            $("#FechaInic").data("kendoDatePicker").value(fechaInicialkendo);
            $("#FechaFinal").data("kendoDatePicker").value(fechaFinalkendo);
            console.log("CargarControlesFiltrado fin");
        };

        function Error(data) {
            if (data.ReturnCode) {
                if (data.ReturnCode != 200) {
                    if (data.ReturnCode == 401) {
                        removeUserSession();
                        return true;
                    } else {
                        displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                        return false;
                    }
                } else {
                    return true;
                }
            } else {
                return true;
            }
        };

        function obtenerFormatoFecha(d) {
            var curr_date = d.getDate();
            var curr_month = d.getMonth() + 1; //Months are zero based
            var curr_year = d.getFullYear();

            return curr_year + "-" + curr_month + "-" + curr_date;
        };

        function tabActivo(dashBoardAccionListado) {
            $(".btn-tabList").removeClass("active");
            switch (dashBoardAccionListado) {
                case "1":
                    $("#btnPorLlegar").addClass("active");
                    break;
                case "2":
                    $("#btnPorDescargar").addClass("active");
                    break;
                case "3":
                    $("#btnPorSalir").addClass("active");
                    break;
            }
        };


        function CantidadesDelMenuDashboard() {
            var accion = $("#hdAccionFiltrado").val() ? $("#hdAccionFiltrado").val() : 1;
            var Listado;
            Listado = { FolioLlegadaID: "", FolioAvisoLlegadaID: "", PatioID: "", ClienteID: "", FechaInicial: "", FechaFinal: "", token: "", Creados: "", SinPermiso: "", SinAutorizacion: "", Completos: "", TipoListado: "" };

            var d = new Date($("#FechaInic").data("kendoDatePicker").value());
            var d1 = new Date($("#FechaFinal").data("kendoDatePicker").value());

            Listado.FolioLlegadaID = folioLlegadaID ? folioLlegadaID : -1;
            Listado.FolioAvisoLlegadaID = folioEntradaID ? folioEntradaID : -1;
            Listado.PatioID = $("#PatioID").data("kendoComboBox").value();
            Listado.FechaInicial = obtenerFormatoFecha(d);
            Listado.FechaFinal = obtenerFormatoFecha(d1);
            Listado.Creados = accion == 1 ? true : false;
            Listado.SinPermiso = accion == 2 ? true : false;
            Listado.SinAutorizacion = accion == 3 ? true : false;
            Listado.Completos = accion == 4 ? true : false;
            Listado.ClienteID = $("#ClienteID").data("kendoComboBox").value();
            Listado.token = Cookies.get("token");
            Listado.TipoListado = 4;
            console.log("CantidadesDelMenuDashboard: " + JSON.stringify(Listado));

            ObtenerAccionesListado(Listado);
        };

        function ControlErroresObjetosComboBox(control, result) {
            if (Error(result)) {
                $("#" + control).data("kendoComboBox").dataSource.data(result);
            } else {
                $("#" + control).data("kendoComboBox").dataSource.data([]);
            };
        };
    }

    function ObtenerFechasporDefecto() {
        var fechaFinal = new Date();
        var fechainicio = new Date(fechaFinal.getTime() - (7 * 24 * 3600 * 1000));

        if ($("#language").data("kendoDropDownList").value() == "es-MX") {
            format = "dd/MM/yyyy";
        } else {
            format = "MM/dd/yyyy";
        };

        var curr_date0 = fechainicio.getDate();
        var curr_month0 = fechainicio.getMonth() + 1; //Months are zero based
        var curr_year0 = fechainicio.getFullYear();


        var curr_date = fechaFinal.getDate();
        var curr_month = fechaFinal.getMonth() + 1; //Months are zero based
        var curr_year = fechaFinal.getFullYear();


        var fechaInicial = new Date(curr_year0, curr_month0 - 1, curr_date0);
        var fechFinal = new Date(curr_year, curr_month - 1, curr_date);

        var fechaInicialkendo = kendo.parseDate(fechaInicial, format);
        var fechaFinalkendo = kendo.parseDate(fechFinal, format);

        $("#FechaInic").data("kendoDatePicker").value(fechaInicialkendo);
        $("#FechaFinal").data("kendoDatePicker").value(fechaFinalkendo);
    };



    @section JavascriptDocumentReadyFunctions 
    {
    cargaInicial();
    }
     
</script>
